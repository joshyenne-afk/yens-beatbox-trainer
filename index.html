<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Beatbox Training System</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Space+Grotesk:wght@300;400;500;600;700&display=swap');
        
        :root {
            --bg-primary: #0A0A0B;
            --bg-secondary: #111113;
            --bg-tertiary: #1A1A1D;
            --bg-card: #151517;
            --text-primary: #FAFAFA;
            --text-secondary: #71717A;
            --text-muted: #52525B;
            --accent: #F97316;
            --accent-hover: #FB923C;
            --accent-glow: rgba(249, 115, 22, 0.3);
            --border: #27272A;
            --border-light: #3F3F46;
            --success: #22C55E;
            --success-glow: rgba(34, 197, 94, 0.3);
            --warning: #EAB308;
            --error: #EF4444;
            --step-active: #F97316;
            --step-playing: #FB923C;
            --step-inactive: #1A1A1D;
            --training-bg: linear-gradient(135deg, #1A1A1D 0%, #0F0F10 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Space Grotesk', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
            font-size: 13px;
            letter-spacing: -0.01em;
        }

        .container {
            max-width: 1500px;
            margin: 0 auto;
        }

        .header {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px 32px;
            margin-bottom: 20px;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            font-size: 24px;
            font-weight: 600;
            letter-spacing: -0.03em;
            color: var(--text-primary);
        }

        .logo span {
            color: var(--accent);
        }

        .subtitle {
            font-size: 11px;
            font-weight: 400;
            letter-spacing: 0.1em;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-top: 4px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .mode-tabs {
            display: flex;
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 4px;
            gap: 4px;
        }

        .mode-tab {
            padding: 8px 16px;
            background: transparent;
            border: none;
            border-radius: 6px;
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mode-tab:hover {
            color: var(--text-primary);
        }

        .mode-tab.active {
            background: var(--accent);
            color: white;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--border);
            transition: all 0.3s;
        }

        .status-indicator.active {
            background: var(--accent);
            box-shadow: 0 0 20px var(--accent-glow);
        }

        .main-grid {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            align-items: start;
        }

        .sidebar {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            max-height: calc(100vh - 160px);
            overflow-y: auto;
            position: sticky;
            top: 20px;
        }

        .sidebar-section {
            margin-bottom: 24px;
        }

        .sidebar-section:last-child {
            margin-bottom: 0;
        }

        .sidebar-title {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        .sound-card-mini {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .sound-card-mini:hover {
            border-color: var(--accent);
            background: var(--bg-secondary);
        }

        .sound-name-mini {
            font-weight: 600;
            font-size: 12px;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .sound-phonetic-mini {
            font-size: 16px;
            font-weight: 700;
            color: var(--accent);
            font-family: 'JetBrains Mono', monospace;
            margin-bottom: 4px;
        }

        .sound-desc-mini {
            font-size: 11px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .pattern-search {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 13px;
            font-family: inherit;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .pattern-search::placeholder {
            color: var(--text-muted);
        }

        .pattern-search:focus {
            outline: none;
            border-color: var(--accent);
        }

        .genre-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 12px;
        }

        .genre-tag {
            padding: 4px 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 10px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .genre-tag:hover, .genre-tag.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .pattern-list {
            max-height: 350px;
            overflow-y: auto;
        }

        .pattern-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pattern-item:hover {
            border-color: var(--border-light);
            background: var(--bg-secondary);
        }

        .pattern-item.active {
            background: rgba(249, 115, 22, 0.1);
            border-color: var(--accent);
        }

        .pattern-name {
            font-weight: 600;
            font-size: 12px;
            margin-bottom: 3px;
            color: var(--text-primary);
        }

        .pattern-meta {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .main-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 28px;
        }

        /* ============== TRAINING MODE STYLES ============== */
        
        .training-container {
            display: none;
        }

        .training-container.active {
            display: block;
        }

        .sequencer-container {
            display: none;
        }

        .sequencer-container.active {
            display: block;
        }

        .training-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 32px;
        }

        .training-phase {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--accent);
            margin-bottom: 8px;
        }

        .training-title {
            font-size: 28px;
            font-weight: 600;
            letter-spacing: -0.02em;
            margin-bottom: 8px;
        }

        .training-desc {
            font-size: 14px;
            color: var(--text-secondary);
            max-width: 500px;
            line-height: 1.6;
        }

        .training-progress-wrapper {
            text-align: right;
        }

        .training-progress-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 8px;
        }

        .training-progress-bar {
            width: 200px;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
        }

        .training-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--accent-hover));
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .drill-card {
            background: var(--training-bg);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 24px;
        }

        .drill-sound-display {
            text-align: center;
            margin-bottom: 32px;
        }

        .drill-phonetic {
            font-size: 72px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent);
            text-shadow: 0 0 60px var(--accent-glow);
            margin-bottom: 8px;
            letter-spacing: -0.02em;
        }

        .drill-name {
            font-size: 18px;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        .drill-instruction {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }

        .drill-instruction-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--accent);
            margin-bottom: 12px;
        }

        .drill-instruction-text {
            font-size: 14px;
            color: var(--text-primary);
            line-height: 1.7;
        }

        .drill-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 24px;
            margin-bottom: 32px;
        }

        .drill-beat-indicator {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-bottom: 32px;
        }

        .beat-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            transition: all 0.1s;
        }

        .beat-dot.active {
            background: var(--accent);
            border-color: var(--accent);
            box-shadow: 0 0 20px var(--accent-glow);
            transform: scale(1.2);
        }

        .beat-dot.hit {
            background: var(--success);
            border-color: var(--success);
            box-shadow: 0 0 20px var(--success-glow);
        }

        .drill-timer {
            text-align: center;
            margin-bottom: 24px;
        }

        .timer-display {
            font-size: 48px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }

        .timer-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-top: 4px;
        }

        .drill-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-top: 24px;
        }

        .stat-card {
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 16px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-primary);
        }

        .stat-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-top: 4px;
        }

        .sound-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .sound-select-card {
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .sound-select-card:hover {
            border-color: var(--border-light);
        }

        .sound-select-card.selected {
            border-color: var(--accent);
            background: rgba(249, 115, 22, 0.1);
        }

        .sound-select-card.completed {
            border-color: var(--success);
            background: rgba(34, 197, 94, 0.1);
        }

        .sound-select-card.completed::after {
            content: '✓';
            position: absolute;
            top: 8px;
            right: 8px;
            color: var(--success);
            font-weight: 700;
        }

        .sound-select-card {
            position: relative;
        }

        .sound-select-phonetic {
            font-size: 32px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent);
            margin-bottom: 4px;
        }

        .sound-select-name {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .sound-select-status {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 8px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Phase 2 specific styles */
        .combo-display {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 24px;
            margin-bottom: 32px;
        }

        .combo-sound {
            text-align: center;
        }

        .combo-phonetic {
            font-size: 48px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent);
        }

        .combo-phonetic.inactive {
            color: var(--text-muted);
            opacity: 0.4;
        }

        .combo-phonetic.current {
            text-shadow: 0 0 40px var(--accent-glow);
            transform: scale(1.1);
        }

        .combo-arrow {
            font-size: 32px;
            color: var(--text-muted);
        }

        .combo-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .combo-card {
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .combo-card:hover {
            border-color: var(--border-light);
        }

        .combo-card.selected {
            border-color: var(--accent);
            background: rgba(249, 115, 22, 0.1);
        }

        .combo-card-sounds {
            font-size: 24px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent);
            margin-bottom: 4px;
        }

        .combo-card-name {
            font-size: 11px;
            color: var(--text-secondary);
        }

        /* ============== TRANSPORT & SEQUENCER ============== */

        .transport {
            display: flex;
            align-items: center;
            gap: 24px;
            margin-bottom: 28px;
            flex-wrap: wrap;
        }

        .transport-controls {
            display: flex;
            gap: 8px;
        }

        .btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 16px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            background: var(--bg-secondary);
            border-color: var(--border-light);
        }

        .btn.primary {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .btn.primary:hover {
            background: var(--accent-hover);
        }

        .btn.success {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .btn-large {
            padding: 14px 28px;
            font-size: 15px;
            border-radius: 10px;
        }

        .tempo-control {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .tempo-label {
            color: var(--text-muted);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .tempo-slider {
            -webkit-appearance: none;
            width: 120px;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            outline: none;
        }

        .tempo-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid var(--bg-primary);
        }

        .tempo-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            color: var(--text-primary);
            min-width: 65px;
        }

        .pattern-info {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }

        .pattern-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .pattern-description {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .phonetic-guide {
            background: linear-gradient(135deg, rgba(249, 115, 22, 0.15), rgba(249, 115, 22, 0.05));
            border: 1px solid var(--accent);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            text-align: center;
        }

        .phonetic-text {
            font-size: 22px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent);
            letter-spacing: 3px;
        }

        .phonetic-help {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 6px;
        }

        .sequencer {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
        }

        .track {
            display: grid;
            grid-template-columns: 90px repeat(16, 1fr);
            gap: 4px;
            align-items: center;
            margin-bottom: 6px;
        }

        .track:last-child {
            margin-bottom: 0;
        }

        .track-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            padding-right: 12px;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .track-name {
            font-weight: 600;
            color: var(--text-secondary);
        }

        .track-phonetic {
            font-size: 14px;
            font-weight: 700;
            color: var(--accent);
            font-family: 'JetBrains Mono', monospace;
        }

        .step {
            aspect-ratio: 1;
            background: var(--step-inactive);
            border: 1px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.1s;
        }

        .step:hover {
            border-color: var(--accent);
        }

        .step.active {
            background: var(--step-active);
            border-color: var(--step-active);
        }

        .step.playing {
            box-shadow: 0 0 0 2px var(--accent-glow);
            transform: scale(1.05);
        }

        .step:nth-child(5n+2) {
            margin-left: 3px;
        }

        .status-message {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 14px 20px;
            font-size: 13px;
            display: none;
            animation: slideIn 0.3s ease-out;
            z-index: 1000;
        }

        .status-message.show {
            display: block;
        }

        .status-message.success {
            border-color: var(--success);
            color: var(--success);
        }

        .status-message.error {
            border-color: var(--error);
            color: var(--error);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .pulse {
            animation: pulse 0.5s ease-in-out;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                position: relative;
                top: 0;
                max-height: none;
            }

            .sound-selector, .combo-selector {
                grid-template-columns: 1fr;
            }
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-light);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div>
                    <div class="logo">BEATBOX<span>MASTERY</span></div>
                    <div class="subtitle">Progressive Training System</div>
                </div>
                <div class="header-right">
                    <div class="mode-tabs">
                        <button class="mode-tab active" data-mode="training">Training</button>
                        <button class="mode-tab" data-mode="sequencer">Patterns</button>
                    </div>
                    <div class="status-indicator" id="statusIndicator"></div>
                </div>
            </div>
        </div>

        <div class="main-grid">
            <div class="sidebar">
                <div class="sidebar-section">
                    <div class="sidebar-title">Core Sounds</div>
                    <div class="sound-card-mini" onclick="playSound('hihat')">
                        <div class="sound-name-mini">Hi-Hat (Closed)</div>
                        <div class="sound-phonetic-mini">{ t } "Ts"</div>
                        <div class="sound-desc-mini">Tongue behind teeth, quick release. The easiest sound.</div>
                    </div>
                    <div class="sound-card-mini" onclick="playSound('snare')">
                        <div class="sound-name-mini">K-Snare</div>
                        <div class="sound-phonetic-mini">{ K } "Cats"</div>
                        <div class="sound-desc-mini">Hard 'K' sound, back of tongue to soft palate.</div>
                    </div>
                    <div class="sound-card-mini" onclick="playSound('kick')">
                        <div class="sound-name-mini">Kick Drum</div>
                        <div class="sound-phonetic-mini">{ B } "Boots"</div>
                        <div class="sound-desc-mini">Whispered 'B', lips closed, no voice.</div>
                    </div>
                    <div class="sound-card-mini" onclick="playSound('openhat')">
                        <div class="sound-name-mini">Open Hi-Hat</div>
                        <div class="sound-phonetic-mini">{ ts } "Tssss"</div>
                        <div class="sound-desc-mini">Extended { t } with sustained 's' sound.</div>
                    </div>
                </div>

                <div class="sidebar-section" id="patternSidebar">
                    <div class="sidebar-title">Pattern Library</div>
                    <input type="text" class="pattern-search" id="patternSearch" placeholder="Search patterns..." />
                    <div class="genre-filters" id="genreFilters"></div>
                    <div class="pattern-list" id="patternList"></div>
                </div>
            </div>

            <div class="main-content">
                <!-- TRAINING MODE -->
                <div class="training-container active" id="trainingContainer">
                    <div class="training-header">
                        <div>
                            <div class="training-phase" id="trainingPhase">Phase 1</div>
                            <div class="training-title" id="trainingTitle">Sound Isolation</div>
                            <div class="training-desc" id="trainingDesc">Master each sound individually before combining. One sound, every beat, full minute. This is how professionals train.</div>
                        </div>
                        <div class="training-progress-wrapper">
                            <div class="training-progress-label">Overall Progress</div>
                            <div class="training-progress-bar">
                                <div class="training-progress-fill" id="overallProgress" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Phase 1: Sound Selection -->
                    <div id="phase1Container">
                        <div class="sound-selector" id="soundSelector">
                            <div class="sound-select-card" data-sound="hihat" onclick="selectTrainingSound('hihat')">
                                <div class="sound-select-phonetic">{ t }</div>
                                <div class="sound-select-name">Hi-Hat</div>
                                <div class="sound-select-status" id="hihat-status">Not started</div>
                            </div>
                            <div class="sound-select-card" data-sound="snare" onclick="selectTrainingSound('snare')">
                                <div class="sound-select-phonetic">{ K }</div>
                                <div class="sound-select-name">K-Snare</div>
                                <div class="sound-select-status" id="snare-status">Not started</div>
                            </div>
                            <div class="sound-select-card" data-sound="kick" onclick="selectTrainingSound('kick')">
                                <div class="sound-select-phonetic">{ B }</div>
                                <div class="sound-select-name">Kick</div>
                                <div class="sound-select-status" id="kick-status">Not started</div>
                            </div>
                        </div>

                        <div class="drill-card" id="drillCard" style="display: none;">
                            <div class="drill-sound-display">
                                <div class="drill-phonetic" id="drillPhonetic">{ t }</div>
                                <div class="drill-name" id="drillName">Hi-Hat</div>
                                <div class="drill-instruction">
                                    <div class="drill-instruction-title">Technique</div>
                                    <div class="drill-instruction-text" id="drillInstruction">
                                        Tongue tip contacts ridge behind upper front teeth. Short, sharp burst with teeth lightly closed. Remove all vocalization—consonant only.
                                    </div>
                                </div>
                            </div>

                            <div class="drill-beat-indicator" id="beatIndicator">
                                <div class="beat-dot"></div>
                                <div class="beat-dot"></div>
                                <div class="beat-dot"></div>
                                <div class="beat-dot"></div>
                            </div>

                            <div class="drill-timer">
                                <div class="timer-display" id="timerDisplay">1:00</div>
                                <div class="timer-label">Remaining</div>
                            </div>

                            <div class="drill-controls">
                                <button class="btn btn-large primary" id="startDrillBtn" onclick="startDrill()">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polygon points="5 3 19 12 5 21 5 3"></polygon>
                                    </svg>
                                    Start Drill
                                </button>
                                <button class="btn btn-large" id="stopDrillBtn" onclick="stopDrill()" style="display: none;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="3" width="18" height="18" rx="2"></rect>
                                    </svg>
                                    Stop
                                </button>
                            </div>

                            <div class="tempo-control" style="justify-content: center; margin-bottom: 24px;">
                                <span class="tempo-label">Tempo</span>
                                <input type="range" class="tempo-slider" id="drillTempoSlider" min="40" max="120" value="60" />
                                <span class="tempo-value" id="drillTempoValue">60 BPM</span>
                            </div>

                            <div class="drill-stats">
                                <div class="stat-card">
                                    <div class="stat-value" id="statBeats">0</div>
                                    <div class="stat-label">Beats Hit</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value" id="statAccuracy">--%</div>
                                    <div class="stat-label">Timing</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value" id="statStreak">0</div>
                                    <div class="stat-label">Best Streak</div>
                                </div>
                            </div>
                        </div>

                        <div style="text-align: center; margin-top: 24px;">
                            <button class="btn" id="advanceToPhase2" onclick="advanceToPhase2()" style="display: none;">
                                Advance to Phase 2: Combinations →
                            </button>
                        </div>
                    </div>

                    <!-- Phase 2: Two-Sound Combinations -->
                    <div id="phase2Container" style="display: none;">
                        <div class="combo-selector" id="comboSelector">
                            <div class="combo-card" data-combo="kick-hihat" onclick="selectCombo('kick-hihat')">
                                <div class="combo-card-sounds">B - t</div>
                                <div class="combo-card-name">Kick + Hi-Hat</div>
                            </div>
                            <div class="combo-card" data-combo="hihat-snare" onclick="selectCombo('hihat-snare')">
                                <div class="combo-card-sounds">t - K</div>
                                <div class="combo-card-name">Hi-Hat + Snare</div>
                            </div>
                            <div class="combo-card" data-combo="kick-snare" onclick="selectCombo('kick-snare')">
                                <div class="combo-card-sounds">B - K</div>
                                <div class="combo-card-name">Kick + Snare</div>
                            </div>
                        </div>

                        <div class="drill-card" id="comboCard" style="display: none;">
                            <div class="combo-display" id="comboDisplay">
                                <div class="combo-sound">
                                    <div class="combo-phonetic" id="comboSound1">B</div>
                                </div>
                                <div class="combo-arrow">→</div>
                                <div class="combo-sound">
                                    <div class="combo-phonetic" id="comboSound2">t</div>
                                </div>
                            </div>

                            <div class="drill-beat-indicator" id="comboBeatIndicator">
                                <div class="beat-dot"></div>
                                <div class="beat-dot"></div>
                                <div class="beat-dot"></div>
                                <div class="beat-dot"></div>
                                <div class="beat-dot"></div>
                                <div class="beat-dot"></div>
                                <div class="beat-dot"></div>
                                <div class="beat-dot"></div>
                            </div>

                            <div class="drill-timer">
                                <div class="timer-display" id="comboTimerDisplay">1:00</div>
                                <div class="timer-label">Remaining</div>
                            </div>

                            <div class="drill-controls">
                                <button class="btn btn-large primary" id="startComboBtn" onclick="startComboDrill()">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polygon points="5 3 19 12 5 21 5 3"></polygon>
                                    </svg>
                                    Start Drill
                                </button>
                                <button class="btn btn-large" id="stopComboBtn" onclick="stopComboDrill()" style="display: none;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="3" width="18" height="18" rx="2"></rect>
                                    </svg>
                                    Stop
                                </button>
                            </div>

                            <div class="tempo-control" style="justify-content: center; margin-bottom: 24px;">
                                <span class="tempo-label">Tempo</span>
                                <input type="range" class="tempo-slider" id="comboTempoSlider" min="40" max="100" value="60" />
                                <span class="tempo-value" id="comboTempoValue">60 BPM</span>
                            </div>

                            <div class="drill-stats">
                                <div class="stat-card">
                                    <div class="stat-value" id="comboStatBeats">0</div>
                                    <div class="stat-label">Cycles</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value" id="comboStatAccuracy">--%</div>
                                    <div class="stat-label">Timing</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value" id="comboStatStreak">0</div>
                                    <div class="stat-label">Best Streak</div>
                                </div>
                            </div>
                        </div>

                        <div style="text-align: center; margin-top: 24px;">
                            <button class="btn" onclick="backToPhase1()">← Back to Phase 1</button>
                            <button class="btn" id="advanceToPatterns" onclick="advanceToPatterns()" style="display: none; margin-left: 12px;">
                                Ready for Patterns →
                            </button>
                        </div>
                    </div>
                </div>

                <!-- SEQUENCER MODE -->
                <div class="sequencer-container" id="sequencerContainer">
                    <div class="transport">
                        <div class="transport-controls">
                            <button class="btn" id="playBtn">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polygon points="5 3 19 12 5 21 5 3"></polygon>
                                </svg>
                                Play
                            </button>
                            <button class="btn" id="stopBtn">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="18" height="18" rx="2"></rect>
                                </svg>
                                Stop
                            </button>
                            <button class="btn" id="clearBtn">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"></path>
                                    <line x1="18" y1="9" x2="12" y2="15"></line>
                                    <line x1="12" y1="9" x2="18" y2="15"></line>
                                </svg>
                                Clear
                            </button>
                        </div>
                        <div class="tempo-control">
                            <span class="tempo-label">Tempo</span>
                            <input type="range" class="tempo-slider" id="tempoSlider" min="40" max="180" value="90" />
                            <span class="tempo-value" id="tempoValue">90 BPM</span>
                        </div>
                    </div>

                    <div class="pattern-info" id="patternInfo">
                        <div class="pattern-title" id="patternTitle">Select a Pattern</div>
                        <div class="pattern-description" id="patternDescription">Choose a pattern from the library to begin practicing</div>
                    </div>

                    <div class="phonetic-guide">
                        <div class="phonetic-text" id="phoneticGuide">B - Ts - K - Ts</div>
                        <div class="phonetic-help">Practice speaking this rhythm slowly, then speed up</div>
                    </div>

                    <div class="sequencer" id="sequencer">
                        <div class="track">
                            <div class="track-label">
                                <span class="track-name">Kick</span>
                                <span class="track-phonetic">{ B }</span>
                            </div>
                        </div>
                        <div class="track">
                            <div class="track-label">
                                <span class="track-name">Snare</span>
                                <span class="track-phonetic">{ K }</span>
                            </div>
                        </div>
                        <div class="track">
                            <div class="track-label">
                                <span class="track-name">HiHat</span>
                                <span class="track-phonetic">{ t }</span>
                            </div>
                        </div>
                        <div class="track">
                            <div class="track-label">
                                <span class="track-name">Open</span>
                                <span class="track-phonetic">{ ts }</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="status-message" id="statusMessage"></div>

    <script>
        // ============== CONSTANTS & STATE ==============
        const STEPS = 16;
        const instruments = ['kick', 'snare', 'hihat', 'openhat'];
        const DRILL_DURATION = 60; // seconds
        
        // Sound instruction data
        const soundData = {
            hihat: {
                phonetic: '{ t }',
                name: 'Hi-Hat (Closed)',
                instruction: 'Tongue tip contacts ridge behind upper front teeth. Make the letter "t" sound from "hat" or "cat"—remove all vocalization, keeping only the consonant. Short, sharp burst with teeth lightly closed.'
            },
            snare: {
                phonetic: '{ K }',
                name: 'K-Snare',
                instruction: 'Make a hard "K" sound as in "kit" with strong accent—the "cats" in "boots and cats". Back of tongue contacts soft palate. Short, percussive click. This is your foundational snare.'
            },
            kick: {
                phonetic: '{ B }',
                name: 'Kick Drum',
                instruction: 'Say "boo" out loud, then whisper it (no vocal cord vibration). Isolate just the "B" consonant with heavy emphasis. Build pressure with lips tightly closed, release in one burst—let lips vibrate briefly.'
            }
        };

        const comboData = {
            'kick-hihat': { sounds: ['kick', 'hihat'], display: ['B', 't'], name: 'Kick + Hi-Hat' },
            'hihat-snare': { sounds: ['hihat', 'snare'], display: ['t', 'K'], name: 'Hi-Hat + Snare' },
            'kick-snare': { sounds: ['kick', 'snare'], display: ['B', 'K'], name: 'Kick + Snare' }
        };

        // Training state
        let trainingState = {
            phase: 1,
            completedSounds: new Set(),
            completedCombos: new Set(),
            currentSound: null,
            currentCombo: null
        };

        // Drill state
        let drillState = {
            isRunning: false,
            intervalId: null,
            timerIntervalId: null,
            currentBeat: 0,
            beatsHit: 0,
            bestStreak: 0,
            currentStreak: 0,
            timeRemaining: DRILL_DURATION,
            tempo: 60
        };

        // Combo drill state
        let comboState = {
            isRunning: false,
            intervalId: null,
            timerIntervalId: null,
            currentBeat: 0,
            cycles: 0,
            bestStreak: 0,
            currentStreak: 0,
            timeRemaining: DRILL_DURATION,
            tempo: 60
        };

        // Sequencer state
        let audioContext;
        let isPlaying = false;
        let currentStep = 0;
        let intervalId = null;
        let currentPattern = null;
        let activeGenre = 'All';

        // Pattern library (condensed for training focus)
        const patternLibrary = [
            {
                name: "Boots and Cats",
                genre: "Beginner",
                tempo: 60,
                description: "THE beginner pattern. Say 'Boots and Cats and Boots and Cats'. Classic 2-beat loop.",
                phonetic: "B - t - K - t",
                pattern: {
                    kick: [1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],
                    snare: [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],
                    hihat: [0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0],
                    openhat: [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
                }
            },
            {
                name: "Simple Two-Step",
                genre: "Beginner",
                tempo: 60,
                description: "Just kick and snare. No hi-hat. Master the backbeat first.",
                phonetic: "B - - - K - - -",
                pattern: {
                    kick: [1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],
                    snare: [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],
                    hihat: [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                    openhat: [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
                }
            },
            {
                name: "Hi-Hat Fill",
                genre: "Beginner",
                tempo: 70,
                description: "Kick → 3 hi-hats → Snare → 3 hi-hats. Builds subdivision control.",
                phonetic: "B t t t K t t t",
                pattern: {
                    kick: [1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],
                    snare: [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],
                    hihat: [0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1],
                    openhat: [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
                }
            },
            {
                name: "Basic Rock",
                genre: "Rock",
                tempo: 90,
                description: "Classic 4/4 rock beat. Kick on 1 & 3, snare on 2 & 4, steady 8th note hi-hats.",
                phonetic: "B-t-K-t-B-t-K-t",
                pattern: {
                    kick: [1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],
                    snare: [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],
                    hihat: [1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],
                    openhat: [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
                }
            },
            {
                name: "Boom Bap",
                genre: "Hip-Hop",
                tempo: 90,
                description: "Classic hip-hop foundation. The iconic boom (kick) bap (snare) sound.",
                phonetic: "B-t-t-K-B-B-t-K",
                pattern: {
                    kick: [1,0,0,0,0,0,1,0,1,0,0,0,0,0,0,0],
                    snare: [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],
                    hihat: [0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0],
                    openhat: [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
                }
            },
            {
                name: "Four-on-Floor",
                genre: "House",
                tempo: 120,
                description: "Essential house/electronic pattern. Kick on every beat.",
                phonetic: "B-t-B-t-B-t-B-ts",
                pattern: {
                    kick: [1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],
                    snare: [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],
                    hihat: [0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0],
                    openhat: [0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1]
                }
            },
            {
                name: "Funk Groove",
                genre: "Funk",
                tempo: 100,
                description: "Syncopated funk pattern. Focus on the pocket.",
                phonetic: "B-t-K-t-B-t-K-t-t",
                pattern: {
                    kick: [1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0],
                    snare: [0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,0],
                    hihat: [1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],
                    openhat: [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
                }
            },
            {
                name: "Trap",
                genre: "Hip-Hop",
                tempo: 140,
                description: "Modern trap with rapid hi-hats. Advanced timing required.",
                phonetic: "B-tttt-K-tttt-B-tttt-K-tttt",
                pattern: {
                    kick: [1,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0],
                    snare: [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],
                    hihat: [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
                    openhat: [0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0]
                }
            },
            {
                name: "Double Kick",
                genre: "Intermediate",
                tempo: 80,
                description: "Two kicks followed by snare. Essential for adding energy to your beats.",
                phonetic: "B-B-K-t-B-B-K-t",
                pattern: {
                    kick: [1,0,0,1,0,0,0,0,1,0,0,1,0,0,0,0],
                    snare: [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],
                    hihat: [0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0],
                    openhat: [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
                }
            },
            {
                name: "Shuffle Groove",
                genre: "Intermediate",
                tempo: 85,
                description: "Swung hi-hats create a bouncy, human feel. Foundation of groove.",
                phonetic: "B-t-ts-K-t-t",
                pattern: {
                    kick: [1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],
                    snare: [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],
                    hihat: [1,0,0,1,0,0,1,0,1,0,0,1,0,0,1,0],
                    openhat: [0,0,1,0,0,1,0,0,0,0,1,0,0,1,0,0]
                }
            },
            {
                name: "Half-Time Hip-Hop",
                genre: "Hip-Hop",
                tempo: 75,
                description: "Slower, heavier feel. Snare on 3 instead of 2 & 4. Creates space.",
                phonetic: "B-t-t-B-K-t",
                pattern: {
                    kick: [1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0],
                    snare: [0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],
                    hihat: [0,0,1,0,1,0,0,0,0,0,1,0,1,0,0,0],
                    openhat: [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
                }
            },
            {
                name: "Fast Hands",
                genre: "Advanced",
                tempo: 95,
                description: "Rapid 16th note hi-hats with sparse kick/snare. Practice hand speed.",
                phonetic: "B-tttt-K-tttt",
                pattern: {
                    kick: [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                    snare: [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],
                    hihat: [0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1],
                    openhat: [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
                }
            },
            {
                name: "Drum & Bass",
                genre: "Electronic",
                tempo: 160,
                description: "Fast breakbeat pattern. Syncopated kicks, tight snares. Advanced.",
                phonetic: "B-t-K-B-B-t-K-t",
                pattern: {
                    kick: [1,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0],
                    snare: [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],
                    hihat: [0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0],
                    openhat: [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
                }
            },
            {
                name: "Reggae One Drop",
                genre: "Reggae",
                tempo: 70,
                description: "Kick and snare together on beat 3. Laid-back island groove.",
                phonetic: "t-t-BK-t",
                pattern: {
                    kick: [0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],
                    snare: [0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],
                    hihat: [1,0,1,0,1,0,1,0,0,0,1,0,1,0,1,0],
                    openhat: [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
                }
            }
        ];

        // ============== INITIALIZATION ==============
        
        function init() {
            createSequencer();
            initializePatternLibrary();
            loadPattern(patternLibrary[0]);
            setupModeToggle();
            setupEventListeners();
            updateOverallProgress();
        }

        function setupModeToggle() {
            document.querySelectorAll('.mode-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const mode = tab.dataset.mode;
                    document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');

                    // Stop any running drills or sequencer when switching modes
                    if (drillState.isRunning) {
                        stopDrill();
                    }
                    if (comboState.isRunning) {
                        stopComboDrill();
                    }
                    if (isPlaying) {
                        stop();
                    }

                    if (mode === 'training') {
                        document.getElementById('trainingContainer').classList.add('active');
                        document.getElementById('sequencerContainer').classList.remove('active');
                    } else {
                        document.getElementById('trainingContainer').classList.remove('active');
                        document.getElementById('sequencerContainer').classList.add('active');
                    }
                });
            });
        }

        function setupEventListeners() {
            // Drill tempo slider - prevent changes during active drill
            document.getElementById('drillTempoSlider').addEventListener('input', (e) => {
                if (drillState.isRunning) {
                    e.target.value = drillState.tempo; // Reset to current tempo
                    showStatus('Stop the drill before changing tempo', 'error');
                    return;
                }
                drillState.tempo = parseInt(e.target.value);
                document.getElementById('drillTempoValue').textContent = `${drillState.tempo} BPM`;
            });

            // Combo tempo slider - prevent changes during active drill
            document.getElementById('comboTempoSlider').addEventListener('input', (e) => {
                if (comboState.isRunning) {
                    e.target.value = comboState.tempo; // Reset to current tempo
                    showStatus('Stop the drill before changing tempo', 'error');
                    return;
                }
                comboState.tempo = parseInt(e.target.value);
                document.getElementById('comboTempoValue').textContent = `${comboState.tempo} BPM`;
            });

            // Sequencer controls
            document.getElementById('playBtn').addEventListener('click', play);
            document.getElementById('stopBtn').addEventListener('click', stop);
            document.getElementById('clearBtn').addEventListener('click', clear);
            
            document.getElementById('tempoSlider').addEventListener('input', (e) => {
                const tempo = e.target.value;
                document.getElementById('tempoValue').textContent = `${tempo} BPM`;
                if (isPlaying) {
                    pause();
                    play();
                }
            });
        }

        // ============== PHASE 1: SOUND ISOLATION ==============

        function selectTrainingSound(sound) {
            trainingState.currentSound = sound;
            
            // Update selection UI
            document.querySelectorAll('.sound-select-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`[data-sound="${sound}"]`).classList.add('selected');
            
            // Show drill card
            document.getElementById('drillCard').style.display = 'block';
            
            // Update drill display
            const data = soundData[sound];
            document.getElementById('drillPhonetic').textContent = data.phonetic;
            document.getElementById('drillName').textContent = data.name;
            document.getElementById('drillInstruction').textContent = data.instruction;
            
            // Reset drill state
            resetDrillState();
        }

        function resetDrillState() {
            drillState.beatsHit = 0;
            drillState.bestStreak = 0;
            drillState.currentStreak = 0;
            drillState.timeRemaining = DRILL_DURATION;
            drillState.currentBeat = 0;
            
            document.getElementById('timerDisplay').textContent = formatTime(DRILL_DURATION);
            document.getElementById('statBeats').textContent = '0';
            document.getElementById('statAccuracy').textContent = '--%';
            document.getElementById('statStreak').textContent = '0';
            
            document.querySelectorAll('#beatIndicator .beat-dot').forEach(dot => {
                dot.classList.remove('active', 'hit');
            });
        }

        function startDrill() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            // Resume audio context (required for modern browsers)
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }

            drillState.isRunning = true;
            drillState.currentBeat = 0;
            
            document.getElementById('startDrillBtn').style.display = 'none';
            document.getElementById('stopDrillBtn').style.display = 'inline-flex';
            document.getElementById('statusIndicator').classList.add('active');
            
            const interval = (60 / drillState.tempo) * 1000;
            
            // Beat loop
            drillState.intervalId = setInterval(() => {
                advanceDrillBeat();
            }, interval);
            
            // Timer
            drillState.timerIntervalId = setInterval(() => {
                drillState.timeRemaining--;
                document.getElementById('timerDisplay').textContent = formatTime(drillState.timeRemaining);
                
                if (drillState.timeRemaining <= 0) {
                    completeDrill();
                }
            }, 1000);
            
            // Start immediately
            advanceDrillBeat();
        }

        function advanceDrillBeat() {
            const dots = document.querySelectorAll('#beatIndicator .beat-dot');
            
            // Clear previous
            dots.forEach(dot => dot.classList.remove('active'));
            
            // Activate current
            dots[drillState.currentBeat].classList.add('active');
            
            // Play sound
            playSound(trainingState.currentSound);
            
            // Track beat
            drillState.beatsHit++;
            drillState.currentStreak++;
            if (drillState.currentStreak > drillState.bestStreak) {
                drillState.bestStreak = drillState.currentStreak;
            }
            
            // Update stats
            document.getElementById('statBeats').textContent = drillState.beatsHit;
            document.getElementById('statStreak').textContent = drillState.bestStreak;
            
            // Advance beat
            drillState.currentBeat = (drillState.currentBeat + 1) % 4;
        }

        function stopDrill() {
            drillState.isRunning = false;
            clearInterval(drillState.intervalId);
            clearInterval(drillState.timerIntervalId);
            
            document.getElementById('startDrillBtn').style.display = 'inline-flex';
            document.getElementById('stopDrillBtn').style.display = 'none';
            document.getElementById('statusIndicator').classList.remove('active');
            
            document.querySelectorAll('#beatIndicator .beat-dot').forEach(dot => {
                dot.classList.remove('active');
            });
        }

        function completeDrill() {
            stopDrill();
            
            // Mark sound as completed
            trainingState.completedSounds.add(trainingState.currentSound);
            
            // Update UI
            const card = document.querySelector(`[data-sound="${trainingState.currentSound}"]`);
            card.classList.add('completed');
            document.getElementById(`${trainingState.currentSound}-status`).textContent = 'Completed ✓';
            
            // Calculate and show accuracy
            const expectedBeats = Math.floor(DRILL_DURATION * (drillState.tempo / 60));
            const accuracy = Math.round((drillState.beatsHit / expectedBeats) * 100);
            document.getElementById('statAccuracy').textContent = `${Math.min(accuracy, 100)}%`;
            
            // Update overall progress
            updateOverallProgress();
            
            // Check if all Phase 1 sounds completed
            if (trainingState.completedSounds.size >= 3) {
                document.getElementById('advanceToPhase2').style.display = 'inline-flex';
                showStatus('Phase 1 Complete! Ready for combinations.', 'success');
            } else {
                showStatus(`${trainingState.currentSound} mastered! ${3 - trainingState.completedSounds.size} sounds remaining.`, 'success');
            }
        }

        // ============== PHASE 2: COMBINATIONS ==============

        function advanceToPhase2() {
            trainingState.phase = 2;
            
            document.getElementById('phase1Container').style.display = 'none';
            document.getElementById('phase2Container').style.display = 'block';
            
            document.getElementById('trainingPhase').textContent = 'Phase 2';
            document.getElementById('trainingTitle').textContent = 'Two-Sound Combinations';
            document.getElementById('trainingDesc').textContent = 'Before "boots and cats" works, you need to nail the transitions. Practice alternating between two sounds until the switch is automatic.';
            
            updateOverallProgress();
        }

        function backToPhase1() {
            document.getElementById('phase1Container').style.display = 'block';
            document.getElementById('phase2Container').style.display = 'none';
            
            document.getElementById('trainingPhase').textContent = 'Phase 1';
            document.getElementById('trainingTitle').textContent = 'Sound Isolation';
            document.getElementById('trainingDesc').textContent = 'Master each sound individually before combining. One sound, every beat, full minute. This is how professionals train.';
        }

        function selectCombo(comboId) {
            trainingState.currentCombo = comboId;
            
            // Update selection UI
            document.querySelectorAll('.combo-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`[data-combo="${comboId}"]`).classList.add('selected');
            
            // Show combo drill card
            document.getElementById('comboCard').style.display = 'block';
            
            // Update display
            const combo = comboData[comboId];
            document.getElementById('comboSound1').textContent = combo.display[0];
            document.getElementById('comboSound2').textContent = combo.display[1];
            
            // Reset combo state
            resetComboState();
        }

        function resetComboState() {
            comboState.cycles = 0;
            comboState.bestStreak = 0;
            comboState.currentStreak = 0;
            comboState.timeRemaining = DRILL_DURATION;
            comboState.currentBeat = 0;
            
            document.getElementById('comboTimerDisplay').textContent = formatTime(DRILL_DURATION);
            document.getElementById('comboStatBeats').textContent = '0';
            document.getElementById('comboStatAccuracy').textContent = '--%';
            document.getElementById('comboStatStreak').textContent = '0';
            
            document.querySelectorAll('#comboBeatIndicator .beat-dot').forEach(dot => {
                dot.classList.remove('active', 'hit');
            });
            
            document.getElementById('comboSound1').classList.remove('current', 'inactive');
            document.getElementById('comboSound2').classList.remove('current', 'inactive');
        }

        function startComboDrill() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            // Resume audio context (required for modern browsers)
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }

            comboState.isRunning = true;
            comboState.currentBeat = 0;
            
            document.getElementById('startComboBtn').style.display = 'none';
            document.getElementById('stopComboBtn').style.display = 'inline-flex';
            document.getElementById('statusIndicator').classList.add('active');
            
            const interval = (60 / comboState.tempo) * 1000;
            
            // Beat loop
            comboState.intervalId = setInterval(() => {
                advanceComboBeat();
            }, interval);
            
            // Timer
            comboState.timerIntervalId = setInterval(() => {
                comboState.timeRemaining--;
                document.getElementById('comboTimerDisplay').textContent = formatTime(comboState.timeRemaining);
                
                if (comboState.timeRemaining <= 0) {
                    completeComboDrill();
                }
            }, 1000);
            
            // Start immediately
            advanceComboBeat();
        }

        function advanceComboBeat() {
            const combo = comboData[trainingState.currentCombo];
            const dots = document.querySelectorAll('#comboBeatIndicator .beat-dot');
            
            // Clear previous
            dots.forEach(dot => dot.classList.remove('active'));
            
            // Activate current
            dots[comboState.currentBeat].classList.add('active');
            
            // Determine which sound to play (alternating)
            const soundIndex = comboState.currentBeat % 2;
            const soundToPlay = combo.sounds[soundIndex];
            
            // Update visual emphasis
            const sound1El = document.getElementById('comboSound1');
            const sound2El = document.getElementById('comboSound2');
            
            sound1El.classList.remove('current', 'inactive');
            sound2El.classList.remove('current', 'inactive');
            
            if (soundIndex === 0) {
                sound1El.classList.add('current');
                sound2El.classList.add('inactive');
            } else {
                sound2El.classList.add('current');
                sound1El.classList.add('inactive');
            }
            
            // Play sound
            playSound(soundToPlay);
            
            // Track cycles (every 2 beats = 1 cycle)
            if (comboState.currentBeat % 2 === 1) {
                comboState.cycles++;
                comboState.currentStreak++;
                if (comboState.currentStreak > comboState.bestStreak) {
                    comboState.bestStreak = comboState.currentStreak;
                }
                document.getElementById('comboStatBeats').textContent = comboState.cycles;
                document.getElementById('comboStatStreak').textContent = comboState.bestStreak;
            }
            
            // Advance beat
            comboState.currentBeat = (comboState.currentBeat + 1) % 8;
        }

        function stopComboDrill() {
            comboState.isRunning = false;
            clearInterval(comboState.intervalId);
            clearInterval(comboState.timerIntervalId);
            
            document.getElementById('startComboBtn').style.display = 'inline-flex';
            document.getElementById('stopComboBtn').style.display = 'none';
            document.getElementById('statusIndicator').classList.remove('active');
            
            document.querySelectorAll('#comboBeatIndicator .beat-dot').forEach(dot => {
                dot.classList.remove('active');
            });
            
            document.getElementById('comboSound1').classList.remove('current', 'inactive');
            document.getElementById('comboSound2').classList.remove('current', 'inactive');
        }

        function completeComboDrill() {
            stopComboDrill();
            
            // Mark combo as completed
            trainingState.completedCombos.add(trainingState.currentCombo);
            
            // Update UI
            const card = document.querySelector(`[data-combo="${trainingState.currentCombo}"]`);
            card.classList.add('selected');
            card.style.borderColor = 'var(--success)';
            card.style.background = 'rgba(34, 197, 94, 0.1)';
            
            // Calculate accuracy
            const expectedCycles = Math.floor(DRILL_DURATION * (comboState.tempo / 60) / 2);
            const accuracy = Math.round((comboState.cycles / expectedCycles) * 100);
            document.getElementById('comboStatAccuracy').textContent = `${Math.min(accuracy, 100)}%`;
            
            // Update overall progress
            updateOverallProgress();
            
            // Check if all combos completed
            if (trainingState.completedCombos.size >= 3) {
                document.getElementById('advanceToPatterns').style.display = 'inline-flex';
                showStatus('Phase 2 Complete! You\'re ready for full patterns.', 'success');
            } else {
                showStatus(`${comboData[trainingState.currentCombo].name} mastered! ${3 - trainingState.completedCombos.size} combinations remaining.`, 'success');
            }
        }

        function advanceToPatterns() {
            document.querySelector('[data-mode="sequencer"]').click();
            showStatus('Welcome to the pattern sequencer! Start with "Boots and Cats" at 60 BPM.', 'success');
        }

        // ============== PROGRESS TRACKING ==============

        function updateOverallProgress() {
            // Phase 1: 3 sounds = 50%, Phase 2: 3 combos = 50%
            const phase1Progress = (trainingState.completedSounds.size / 3) * 50;
            const phase2Progress = (trainingState.completedCombos.size / 3) * 50;
            const totalProgress = phase1Progress + phase2Progress;
            
            document.getElementById('overallProgress').style.width = `${totalProgress}%`;
        }

        // ============== UTILITY FUNCTIONS ==============

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // ============== SEQUENCER FUNCTIONS ==============

        function createSequencer() {
            const sequencer = document.getElementById('sequencer');
            const tracks = sequencer.getElementsByClassName('track');
            
            instruments.forEach((inst, i) => {
                for (let j = 0; j < STEPS; j++) {
                    const step = document.createElement('div');
                    step.className = 'step';
                    step.dataset.instrument = inst;
                    step.dataset.step = j;
                    step.addEventListener('click', toggleStep);
                    tracks[i].appendChild(step);
                }
            });
        }

        function initializePatternLibrary() {
            const genres = ['All', ...new Set(patternLibrary.map(p => p.genre))];
            const genreFilters = document.getElementById('genreFilters');
            
            genres.forEach(genre => {
                const tag = document.createElement('div');
                tag.className = 'genre-tag' + (genre === 'All' ? ' active' : '');
                tag.textContent = genre;
                tag.addEventListener('click', () => filterByGenre(genre));
                genreFilters.appendChild(tag);
            });
            
            renderPatternList();
            
            document.getElementById('patternSearch').addEventListener('input', (e) => {
                renderPatternList(e.target.value);
            });
        }

        function filterByGenre(genre) {
            activeGenre = genre;
            document.querySelectorAll('.genre-tag').forEach(tag => {
                tag.classList.toggle('active', tag.textContent === genre);
            });
            renderPatternList();
        }

        function renderPatternList(searchTerm = '') {
            const patternList = document.getElementById('patternList');
            const filtered = patternLibrary.filter(p => {
                const matchesGenre = activeGenre === 'All' || p.genre === activeGenre;
                const matchesSearch = p.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                    p.description.toLowerCase().includes(searchTerm.toLowerCase());
                return matchesGenre && matchesSearch;
            });
            
            patternList.innerHTML = filtered.map((p, i) => `
                <div class="pattern-item ${currentPattern && currentPattern.name === p.name ? 'active' : ''}"
                     onclick="loadPatternByIndex(${patternLibrary.indexOf(p)})">
                    <div class="pattern-name">${p.name}</div>
                    <div class="pattern-meta">${p.genre} • ${p.tempo} BPM</div>
                </div>
            `).join('');
        }

        function loadPatternByIndex(index) {
            loadPattern(patternLibrary[index]);
        }

        function loadPattern(pattern) {
            currentPattern = pattern;
            
            document.getElementById('patternTitle').textContent = pattern.name;
            document.getElementById('patternDescription').textContent = pattern.description;
            document.getElementById('phoneticGuide').textContent = pattern.phonetic;
            document.getElementById('tempoSlider').value = pattern.tempo;
            document.getElementById('tempoValue').textContent = `${pattern.tempo} BPM`;
            
            instruments.forEach(inst => {
                pattern.pattern[inst].forEach((value, step) => {
                    const element = document.querySelector(`[data-instrument="${inst}"][data-step="${step}"]`);
                    element.classList.toggle('active', value === 1);
                });
            });
            
            renderPatternList();
            showStatus(`Loaded: ${pattern.name}`, 'success');
        }

        function toggleStep(e) {
            const inst = e.target.dataset.instrument;
            const step = parseInt(e.target.dataset.step);
            
            if (currentPattern) {
                currentPattern.pattern[inst][step] = currentPattern.pattern[inst][step] ? 0 : 1;
            }
            
            e.target.classList.toggle('active');
        }

        function playSound(inst) {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            const now = audioContext.currentTime;

            switch(inst) {
                case 'kick':
                    // Punchy kick with attack click and bass body
                    const kickOsc = audioContext.createOscillator();
                    const kickGain = audioContext.createGain();
                    const kickFilter = audioContext.createBiquadFilter();

                    kickFilter.type = 'lowpass';
                    kickFilter.frequency.value = 800;
                    kickFilter.Q.value = 1;

                    kickOsc.connect(kickFilter);
                    kickFilter.connect(kickGain);
                    kickGain.connect(audioContext.destination);

                    // Frequency sweep for punch (starts high, drops fast)
                    kickOsc.frequency.setValueAtTime(180, now);
                    kickOsc.frequency.exponentialRampToValueAtTime(60, now + 0.05);
                    kickOsc.frequency.exponentialRampToValueAtTime(45, now + 0.15);

                    // Attack + decay envelope
                    kickGain.gain.setValueAtTime(1.2, now);
                    kickGain.gain.exponentialRampToValueAtTime(0.8, now + 0.01);
                    kickGain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);

                    kickOsc.start(now);
                    kickOsc.stop(now + 0.3);
                    break;
                    
                case 'snare':
                    // Crispy snare with body and snap
                    const noise = audioContext.createBufferSource();
                    const noiseBuffer = audioContext.createBuffer(1, audioContext.sampleRate * 0.15, audioContext.sampleRate);
                    const noiseData = noiseBuffer.getChannelData(0);
                    for (let i = 0; i < noiseBuffer.length; i++) {
                        noiseData[i] = Math.random() * 2 - 1;
                    }
                    noise.buffer = noiseBuffer;

                    // Multi-band filtering for realistic snap
                    const noiseHP = audioContext.createBiquadFilter();
                    noiseHP.type = 'highpass';
                    noiseHP.frequency.value = 800;

                    const noisePeak = audioContext.createBiquadFilter();
                    noisePeak.type = 'peaking';
                    noisePeak.frequency.value = 2200;
                    noisePeak.Q.value = 1.5;
                    noisePeak.gain.value = 8;

                    const noiseGain = audioContext.createGain();
                    noise.connect(noiseHP);
                    noiseHP.connect(noisePeak);
                    noisePeak.connect(noiseGain);
                    noiseGain.connect(audioContext.destination);

                    // Sharp attack, quick decay
                    noiseGain.gain.setValueAtTime(0.7, now);
                    noiseGain.gain.exponentialRampToValueAtTime(0.3, now + 0.01);
                    noiseGain.gain.exponentialRampToValueAtTime(0.01, now + 0.12);

                    // Tonal body for depth
                    const snareOsc = audioContext.createOscillator();
                    const snareOsc2 = audioContext.createOscillator();
                    const snareGain = audioContext.createGain();
                    const snareFilter = audioContext.createBiquadFilter();

                    snareFilter.type = 'bandpass';
                    snareFilter.frequency.value = 220;
                    snareFilter.Q.value = 2;

                    snareOsc.connect(snareFilter);
                    snareOsc2.connect(snareFilter);
                    snareFilter.connect(snareGain);
                    snareGain.connect(audioContext.destination);

                    snareOsc.frequency.setValueAtTime(220, now);
                    snareOsc2.frequency.setValueAtTime(170, now);

                    snareGain.gain.setValueAtTime(0.4, now);
                    snareGain.gain.exponentialRampToValueAtTime(0.01, now + 0.08);

                    snareOsc.start(now);
                    snareOsc2.start(now);
                    snareOsc.stop(now + 0.08);
                    snareOsc2.stop(now + 0.08);
                    noise.start(now);
                    noise.stop(now + 0.15);
                    break;
                    
                case 'hihat':
                    // Crisp, short closed hi-hat
                    const hihatNoise = audioContext.createBufferSource();
                    const hihatBuffer = audioContext.createBuffer(1, audioContext.sampleRate * 0.04, audioContext.sampleRate);
                    const hihatData = hihatBuffer.getChannelData(0);
                    for (let i = 0; i < hihatBuffer.length; i++) {
                        hihatData[i] = Math.random() * 2 - 1;
                    }
                    hihatNoise.buffer = hihatBuffer;

                    // Metallic character with multiple peaks
                    const hihatHP = audioContext.createBiquadFilter();
                    hihatHP.type = 'highpass';
                    hihatHP.frequency.value = 7000;

                    const hihatPeak1 = audioContext.createBiquadFilter();
                    hihatPeak1.type = 'peaking';
                    hihatPeak1.frequency.value = 10000;
                    hihatPeak1.Q.value = 2.5;
                    hihatPeak1.gain.value = 5;

                    const hihatPeak2 = audioContext.createBiquadFilter();
                    hihatPeak2.type = 'peaking';
                    hihatPeak2.frequency.value = 13500;
                    hihatPeak2.Q.value = 1.8;
                    hihatPeak2.gain.value = 3;

                    const hihatGain = audioContext.createGain();
                    hihatNoise.connect(hihatHP);
                    hihatHP.connect(hihatPeak1);
                    hihatPeak1.connect(hihatPeak2);
                    hihatPeak2.connect(hihatGain);
                    hihatGain.connect(audioContext.destination);

                    // Tight envelope for closed sound
                    hihatGain.gain.setValueAtTime(0.6, now);
                    hihatGain.gain.exponentialRampToValueAtTime(0.01, now + 0.035);

                    hihatNoise.start(now);
                    hihatNoise.stop(now + 0.04);
                    break;
                    
                case 'openhat':
                    // Sustained open hi-hat with shimmer
                    const openNoise = audioContext.createBufferSource();
                    const openBuffer = audioContext.createBuffer(1, audioContext.sampleRate * 0.6, audioContext.sampleRate);
                    const openData = openBuffer.getChannelData(0);
                    for (let i = 0; i < openBuffer.length; i++) {
                        openData[i] = Math.random() * 2 - 1;
                    }
                    openNoise.buffer = openBuffer;

                    // Bright metallic ring with multiple resonances
                    const openHP = audioContext.createBiquadFilter();
                    openHP.type = 'highpass';
                    openHP.frequency.value = 6000;

                    const openPeak1 = audioContext.createBiquadFilter();
                    openPeak1.type = 'peaking';
                    openPeak1.frequency.value = 9000;
                    openPeak1.Q.value = 3.5;
                    openPeak1.gain.value = 7;

                    const openPeak2 = audioContext.createBiquadFilter();
                    openPeak2.type = 'peaking';
                    openPeak2.frequency.value = 12000;
                    openPeak2.Q.value = 2.8;
                    openPeak2.gain.value = 5;

                    const openPeak3 = audioContext.createBiquadFilter();
                    openPeak3.type = 'peaking';
                    openPeak3.frequency.value = 15000;
                    openPeak3.Q.value = 2;
                    openPeak3.gain.value = 3;

                    const openGain = audioContext.createGain();
                    openNoise.connect(openHP);
                    openHP.connect(openPeak1);
                    openPeak1.connect(openPeak2);
                    openPeak2.connect(openPeak3);
                    openPeak3.connect(openGain);
                    openGain.connect(audioContext.destination);

                    // Slower decay for sustain
                    openGain.gain.setValueAtTime(0, now);
                    openGain.gain.linearRampToValueAtTime(0.5, now + 0.005);
                    openGain.gain.exponentialRampToValueAtTime(0.15, now + 0.1);
                    openGain.gain.exponentialRampToValueAtTime(0.01, now + 0.55);

                    openNoise.start(now);
                    openNoise.stop(now + 0.6);
                    break;
            }
        }

        function advanceSequencer() {
            document.querySelectorAll('.step').forEach(el => {
                el.classList.remove('playing');
            });
            
            instruments.forEach(inst => {
                const el = document.querySelector(`[data-instrument="${inst}"][data-step="${currentStep}"]`);
                el.classList.add('playing');
                
                if (currentPattern && currentPattern.pattern[inst][currentStep]) {
                    playSound(inst);
                }
            });
            
            currentStep = (currentStep + 1) % STEPS;
        }

        function play() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            // Resume audio context (required for modern browsers)
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }

            if (!isPlaying) {
                isPlaying = true;
                const tempo = parseInt(document.getElementById('tempoSlider').value);
                const interval = (60 / tempo / 4) * 1000;

                document.getElementById('statusIndicator').classList.add('active');
                document.getElementById('playBtn').innerHTML = `
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="6" y="4" width="4" height="16"></rect>
                        <rect x="14" y="4" width="4" height="16"></rect>
                    </svg>
                    Pause
                `;

                advanceSequencer();
                intervalId = setInterval(advanceSequencer, interval);
            } else {
                pause();
            }
        }

        function pause() {
            isPlaying = false;
            clearInterval(intervalId);
            document.getElementById('statusIndicator').classList.remove('active');
            document.getElementById('playBtn').innerHTML = `
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="5 3 19 12 5 21 5 3"></polygon>
                </svg>
                Play
            `;
        }

        function stop() {
            pause();
            currentStep = 0;
            document.querySelectorAll('.step').forEach(el => {
                el.classList.remove('playing');
            });
        }

        function clear() {
            if (currentPattern) {
                instruments.forEach(inst => {
                    currentPattern.pattern[inst].fill(0);
                    currentPattern.pattern[inst].forEach((_, step) => {
                        const element = document.querySelector(`[data-instrument="${inst}"][data-step="${step}"]`);
                        element.classList.remove('active');
                    });
                });
            }
        }

        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `status-message show ${type}`;
            setTimeout(() => statusEl.classList.remove('show'), 4000);
        }

        // Global exports
        window.loadPatternByIndex = loadPatternByIndex;
        window.playSound = playSound;
        window.selectTrainingSound = selectTrainingSound;
        window.startDrill = startDrill;
        window.stopDrill = stopDrill;
        window.advanceToPhase2 = advanceToPhase2;
        window.backToPhase1 = backToPhase1;
        window.selectCombo = selectCombo;
        window.startComboDrill = startComboDrill;
        window.stopComboDrill = stopComboDrill;
        window.advanceToPatterns = advanceToPatterns;

        // Initialize
        init();
    </script>
</body>
</html>
