<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0A0A0B">
    <title>YEN's Beatbox Trainer</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Space+Grotesk:wght@400;500;600;700&display=swap');
        
        :root {
            --bg: #0A0A0B;
            --bg-card: #141416;
            --bg-elevated: #1a1a1d;
            --text: #FAFAFA;
            --text-dim: #888;
            --accent: #FF6B35;
            --accent-soft: rgba(255, 107, 53, 0.15);
            --accent-glow: rgba(255, 107, 53, 0.5);
            --border: #2a2a2d;
            --success: #22c55e;
            --danger: #ef4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; overflow: hidden; }
        
        body {
            font-family: 'Space Grotesk', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            font-size: 16px;
            line-height: 1.4;
        }

        .app {
            display: flex;
            flex-direction: column;
            height: 100%;
            max-width: 500px;
            margin: 0 auto;
        }

        header {
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }
        .logo { font-size: 18px; font-weight: 700; }
        .logo span { color: var(--accent); }

        nav {
            display: flex;
            padding: 12px 16px;
            gap: 8px;
            flex-shrink: 0;
            border-bottom: 1px solid var(--border);
        }
        .nav-btn {
            flex: 1;
            padding: 12px 8px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-dim);
            font-family: inherit;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }
        .nav-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        main {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: 100px;
        }

        .section { margin-bottom: 32px; }
        .section-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-dim);
            margin-bottom: 12px;
            padding-left: 4px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.15s ease;
            -webkit-user-select: none;
            user-select: none;
            min-height: 72px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
        }
        .card:active {
            transform: scale(0.96);
            background: var(--bg-elevated);
        }
        .card.playing {
            border-color: var(--accent);
            box-shadow: 0 0 20px var(--accent-glow);
        }

        .card-phonetic {
            font-family: 'DM Mono', monospace;
            font-size: 22px;
            font-weight: 500;
            color: var(--accent);
            margin-bottom: 4px;
        }
        .card-name {
            font-size: 11px;
            color: var(--text-dim);
            text-transform: lowercase;
        }
        .card-hint {
            font-size: 9px;
            color: var(--text-dim);
            opacity: 0.7;
            margin-top: 4px;
            line-height: 1.3;
        }

        .card-status {
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 2px 6px;
            border-radius: 4px;
            background: var(--accent);
            color: white;
            display: none;
        }
        .card.playing .card-status {
            display: block;
        }

        .drill-display {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 56px;
            gap: 12px;
        }
        .drill-phonetic {
            font-family: 'DM Mono', monospace;
            font-size: 24px;
            font-weight: 500;
            color: var(--accent);
            letter-spacing: 2px;
        }
        .drill-phonetic .current {
            background: var(--accent);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .bpm-control {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-shrink: 0;
        }
        .bpm-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-elevated);
            color: var(--text);
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .bpm-btn:active {
            background: var(--accent);
            border-color: var(--accent);
        }
        .stop-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-elevated);
            color: var(--text);
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .stop-btn:active {
            background: var(--accent);
            border-color: var(--accent);
        }
        .stop-btn.playing {
            background: var(--accent);
            border-color: var(--accent);
        }
        .bpm-value {
            font-family: 'DM Mono', monospace;
            font-size: 13px;
            color: var(--text-dim);
            min-width: 50px;
            text-align: center;
        }

        .pattern-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.15s ease;
            position: relative;
        }
        .pattern-card:active {
            transform: scale(0.98);
        }
        .pattern-card.playing {
            border-color: var(--accent);
            box-shadow: 0 0 20px var(--accent-glow);
        }
        .pattern-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .pattern-meta {
            font-size: 12px;
            color: var(--text-dim);
            margin-bottom: 8px;
        }
        .pattern-phonetic {
            font-family: 'DM Mono', monospace;
            font-size: 14px;
            color: var(--accent);
            margin-bottom: 8px;
        }
        .pattern-visualizer {
            display: flex;
            gap: 2px;
            height: 24px;
            align-items: flex-end;
        }
        .pattern-step {
            flex: 1;
            background: var(--border);
            border-radius: 2px;
            transition: all 0.05s;
        }
        .pattern-step.kick { height: 100%; background: var(--accent); opacity: 0.4; }
        .pattern-step.snare { height: 70%; background: #888; opacity: 0.4; }
        .pattern-step.hihat { height: 40%; background: #666; opacity: 0.4; }
        .pattern-step.active { opacity: 1; }
        .pattern-step.current { box-shadow: 0 0 8px var(--accent-glow); }

        .pattern-status {
            position: absolute;
            top: 12px;
            right: 12px;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 3px 8px;
            border-radius: 4px;
            background: var(--accent);
            color: white;
            display: none;
        }
        .pattern-card.playing .pattern-status {
            display: block;
        }

        .ref-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 10px;
        }
        .ref-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }
        .ref-phonetic {
            font-family: 'DM Mono', monospace;
            font-size: 28px;
            font-weight: 500;
            color: var(--accent);
        }
        .ref-title {
            flex: 1;
        }
        .ref-name {
            font-size: 16px;
            font-weight: 600;
        }
        .ref-category {
            font-size: 10px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .ref-text {
            font-size: 13px;
            color: var(--text-dim);
            line-height: 1.5;
            margin-bottom: 10px;
        }
        .ref-link {
            font-size: 12px;
            color: var(--accent);
            font-weight: 600;
            text-decoration: none;
        }

        .view { display: none; }
        .view.active { display: block; }

        /* ===== CREATE VIEW STYLES ===== */
        .create-header {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .create-name-row {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }
        .create-name-input {
            flex: 1;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 12px;
            color: var(--text);
            font-family: inherit;
            font-size: 14px;
        }
        .create-name-input:focus {
            outline: none;
            border-color: var(--accent);
        }
        .create-controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .create-btn {
            padding: 10px 16px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-family: inherit;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .create-btn:active {
            background: var(--accent);
            border-color: var(--accent);
        }
        .create-btn.primary {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }
        .create-btn.success {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }
        .create-btn.danger {
            background: var(--danger);
            border-color: var(--danger);
            color: white;
        }

        .sequencer-grid {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            overflow-x: auto;
        }
        .seq-track {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .seq-track:last-child {
            margin-bottom: 0;
        }
        .seq-label {
            width: 50px;
            flex-shrink: 0;
        }
        .seq-label-phonetic {
            font-family: 'DM Mono', monospace;
            font-size: 16px;
            font-weight: 500;
            color: var(--accent);
        }
        .seq-label-name {
            font-size: 9px;
            color: var(--text-dim);
            text-transform: uppercase;
        }
        .seq-steps {
            display: flex;
            gap: 4px;
            flex: 1;
        }
        .seq-step {
            width: 100%;
            min-width: 20px;
            max-width: 28px;
            aspect-ratio: 1;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.1s;
        }
        .seq-step:nth-child(4n+1) {
            border-left: 2px solid var(--text-dim);
        }
        .seq-step.active {
            background: var(--accent);
            border-color: var(--accent);
        }
        .seq-step.current {
            box-shadow: 0 0 0 2px var(--accent-glow);
            transform: scale(1.1);
        }
        .seq-step:active {
            transform: scale(0.9);
        }

        .saved-patterns {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
        }
        .saved-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .saved-title {
            font-size: 14px;
            font-weight: 600;
        }
        .saved-count {
            font-size: 11px;
            color: var(--text-dim);
        }
        .saved-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .saved-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .saved-item:last-child {
            margin-bottom: 0;
        }
        .saved-item:active {
            transform: scale(0.98);
        }
        .saved-item.active {
            border-color: var(--accent);
        }
        .saved-item-info {
            flex: 1;
        }
        .saved-item-name {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 2px;
        }
        .saved-item-meta {
            font-size: 11px;
            color: var(--text-dim);
        }
        .saved-item-actions {
            display: flex;
            gap: 6px;
        }
        .saved-item-btn {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-dim);
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .saved-item-btn:active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }
        .saved-item-btn.delete:active {
            background: var(--danger);
            border-color: var(--danger);
        }
        .empty-state {
            text-align: center;
            padding: 32px;
            color: var(--text-dim);
            font-size: 13px;
        }
        .share-url {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 12px;
            font-family: 'DM Mono', monospace;
            font-size: 11px;
            color: var(--text-dim);
            word-break: break-all;
            margin-top: 12px;
            display: none;
        }
        .share-url.visible {
            display: block;
        }
    </style>
</head>
<body>
    <div class="app">
        <header>
            <div class="logo">YEN's <span>Beatbox</span></div>
        </header>

        <nav>
            <button class="nav-btn active" data-view="train">Train</button>
            <button class="nav-btn" data-view="create">Create</button>
            <button class="nav-btn" data-view="patterns">Patterns</button>
            <button class="nav-btn" data-view="reference">Ref</button>
        </nav>
        <main>
            <div class="view active" id="trainView">
                <div class="section">
                    <div class="section-label">1. Core Sounds</div>
                    <div id="soundCards"></div>
                </div>
                <div class="section">
                    <div class="section-label">2. Two-Sound Transitions</div>
                    <div class="drill-display" id="comboDisplay"></div>
                    <div class="grid" id="comboGrid"></div>
                </div>
                <div class="section">
                    <div class="section-label">3. Three-Sound Triplets</div>
                    <div class="drill-display" id="tripletDisplay"></div>
                    <div class="grid" id="tripletGrid"></div>
                </div>
                <div class="section">
                    <div class="section-label">4. Beatrhyming Phrases</div>
                    <div class="drill-display" id="phraseDisplay"></div>
                    <div class="grid" id="phraseGrid"></div>
                </div>
            </div>

            <div class="view" id="createView">
                <div class="create-header">
                    <div class="create-name-row">
                        <input type="text" class="create-name-input" id="createName" placeholder="My Beat" maxlength="30">
                    </div>
                    <div class="create-controls">
                        <button class="create-btn primary" id="createPlayBtn">â–¶ Play</button>
                        <button class="create-btn" id="createClearBtn">Clear</button>
                        <button class="create-btn success" id="createSaveBtn">ðŸ’¾ Save</button>
                        <button class="create-btn" id="createShareBtn">ðŸ”— Share</button>
                    </div>
                    <div class="bpm-control" style="margin-top: 12px; justify-content: center;">
                        <button class="bpm-btn" id="createBpmDown">âˆ’</button>
                        <div class="bpm-value" id="createBpmValue">90</div>
                        <button class="bpm-btn" id="createBpmUp">+</button>
                    </div>
                    <div class="share-url" id="shareUrl"></div>
                </div>

                <div class="sequencer-grid">
                    <div class="seq-track" data-track="kick">
                        <div class="seq-label">
                            <div class="seq-label-phonetic">B</div>
                            <div class="seq-label-name">Kick</div>
                        </div>
                        <div class="seq-steps" id="kickSteps"></div>
                    </div>
                    <div class="seq-track" data-track="snare">
                        <div class="seq-label">
                            <div class="seq-label-phonetic">K</div>
                            <div class="seq-label-name">Snare</div>
                        </div>
                        <div class="seq-steps" id="snareSteps"></div>
                    </div>
                    <div class="seq-track" data-track="hihat">
                        <div class="seq-label">
                            <div class="seq-label-phonetic">t</div>
                            <div class="seq-label-name">Hat</div>
                        </div>
                        <div class="seq-steps" id="hihatSteps"></div>
                    </div>
                </div>

                <div class="saved-patterns">
                    <div class="saved-header">
                        <div class="saved-title">Saved Patterns</div>
                        <div class="saved-count" id="savedCount">0 / 20</div>
                    </div>
                    <div class="saved-list" id="savedList">
                        <div class="empty-state">No saved patterns yet.<br>Create one above!</div>
                    </div>
                </div>
            </div>

            <div class="view" id="patternsView">
                <div class="section">
                    <div class="drill-display" id="patternDisplay"></div>
                    <div class="section-label">Pattern Library</div>
                    <div id="patternCards"></div>
                </div>
            </div>
            <div class="view" id="referenceView">
                <div class="section">
                    <div class="section-label">How To Make The Sounds</div>
                    <div id="refCards"></div>
                </div>
            </div>
        </main>
    </div>

<script>
// Extended sounds with variations
const sounds = [
    // KICKS
    { id: 'kick', phonetic: 'B', name: 'Classic Kick', category: 'Kick',
      hint: '"Boots" â€” lips closed, whispered B',
      tutorial: 'https://www.youtube.com/results?search_query=beatbox+kick+drum+tutorial',
      ref: 'Bilabial plosive. Close lips tight, build pressure from diaphragm, release in one punch. Whisper "boo" then drop the vowel. No vocal cord vibration.' },
    { id: 'kick808', phonetic: 'U', name: '808/Throat Kick', category: 'Kick',
      hint: 'Close airway, vocalize with throat',
      tutorial: 'https://www.youtube.com/results?search_query=beatbox+808+kick+tutorial',
      ref: 'Glottalic. Close epiglottis (like holding breath), vocalize while keeping it closed. Sound comes from vocal cords but stays trapped. Put mic on throat for huge sub.' },
    { id: 'kickchest', phonetic: 'Bnn', name: 'Chest Bass Kick', category: 'Kick',
      hint: 'Deep resonance from chest cavity',
      tutorial: 'https://www.youtube.com/results?search_query=beatbox+chest+bass+tutorial',
      ref: 'Create large space in back of throat. Big airy breath outward. Feel chest cavity resonate. Very low, bassy "boom" â€” adds sub-bass depth.' },
    
    // HI-HATS
    { id: 'hihat', phonetic: 't', name: 'Closed Hi-Hat', category: 'Hi-Hat',
      hint: '"ts" â€” tongue behind teeth, quick snap',
      tutorial: 'https://www.youtube.com/results?search_query=beatbox+hi+hat+tutorial',
      ref: 'Dental plosive. Tongue tip touches ridge behind upper front teeth. Quick release with teeth lightly closed. The "t" from "cat" â€” unvoiced consonant only.' },
    { id: 'hihatopen', phonetic: 'ts', name: 'Open Hi-Hat', category: 'Hi-Hat',
      hint: '"tssss" â€” extend the s sound',
      tutorial: 'https://www.youtube.com/results?search_query=beatbox+open+hi+hat+tutorial',
      ref: 'Start with closed { t }, extend with sustained "sss" sound. Open lips slightly for more air. Duration of "s" controls openness. Cut off abruptly for half-open.' },
    { id: 'hihatinward', phonetic: '^ts', name: 'Inward Hi-Hat', category: 'Hi-Hat',
      hint: 'Breathe IN while making the sound',
      tutorial: 'https://www.youtube.com/results?search_query=beatbox+inward+hi+hat+tutorial',
      ref: 'Tongue on alveolar ridge, draw tongue down and back while breathing IN. Different tonal quality. Key technique for circular breathing patterns.' },
    
    // SNARES
    { id: 'snare', phonetic: 'K', name: 'K-Snare', category: 'Snare',
      hint: '"Cats" â€” hard K, back of tongue',
      tutorial: 'https://www.youtube.com/results?search_query=beatbox+k+snare+tutorial',
      ref: 'Velar plosive. Back of tongue hits soft palate. Hard "K" as in "kit" with strong accent. Short, percussive click. The foundation snare sound.' },
    { id: 'snarepf', phonetic: 'Pf', name: 'PF-Snare (Classic)', category: 'Snare',
      hint: '"poof" without the "oo"',
      tutorial: 'https://www.youtube.com/results?search_query=beatbox+pf+snare+tutorial',
      ref: 'Say "poof" without the "oo" â€” zero gap between consonants. Pressure on "p", let "ff" resonate using only mouth air. Heavy attack-and-decay, DJ-style backbone.' },
    { id: 'snareinward', phonetic: '^K', name: 'Inward K-Snare', category: 'Snare',
      hint: 'Kenny Muhammad technique â€” breathe while playing',
      tutorial: 'https://www.youtube.com/results?search_query=beatbox+inward+k+snare+tutorial',
      ref: 'Touch tongue tip to roof behind "t" position. Seal sides creating cavity. Inhale while dropping middle tongue. Continue inhale for "shh" tail. Allows breathing during beats!' }
];

const combos = [
    { id: 'b-t', sounds: ['kick','hihat'], display: ['B','t'], name: 'Kick â†’ Hat' },
    { id: 't-k', sounds: ['hihat','snare'], display: ['t','K'], name: 'Hat â†’ Snare' },
    { id: 'b-k', sounds: ['kick','snare'], display: ['B','K'], name: 'Kick â†’ Snare' },
    { id: 'k-b', sounds: ['snare','kick'], display: ['K','B'], name: 'Snare â†’ Kick' },
    { id: 'k-t', sounds: ['snare','hihat'], display: ['K','t'], name: 'Snare â†’ Hat' },
    { id: 't-b', sounds: ['hihat','kick'], display: ['t','B'], name: 'Hat â†’ Kick' }
];

const triplets = [
    { id: 'b-t-k', sounds: ['kick','hihat','snare'], display: ['B','t','K'], name: 'boots and cats' },
    { id: 'k-t-b', sounds: ['snare','hihat','kick'], display: ['K','t','B'], name: 'cats and boots' },
    { id: 'b-k-t', sounds: ['kick','snare','hihat'], display: ['B','K','t'], name: 'boom kat' },
    { id: 't-b-k', sounds: ['hihat','kick','snare'], display: ['t','B','K'], name: 'and boom kat' },
    { id: 't-k-b', sounds: ['hihat','snare','kick'], display: ['t','K','B'], name: 'and kat boom' },
    { id: 'k-b-t', sounds: ['snare','kick','hihat'], display: ['K','B','t'], name: 'kat boom and' },
    { id: 'b-b-k', sounds: ['kick','kick','snare'], display: ['B','B','K'], name: 'double kick snap' },
    { id: 'b-b-t', sounds: ['kick','kick','hihat'], display: ['B','B','t'], name: 'double kick hat' },
    { id: 'k-k-b', sounds: ['snare','snare','kick'], display: ['K','K','B'], name: 'double snap kick' },
    { id: 'k-k-t', sounds: ['snare','snare','hihat'], display: ['K','K','t'], name: 'double snap hat' },
    { id: 't-t-k', sounds: ['hihat','hihat','snare'], display: ['t','t','K'], name: 'tika snare' },
    { id: 't-t-b', sounds: ['hihat','hihat','kick'], display: ['t','t','B'], name: 'tika kick' },
    { id: 't-k-t', sounds: ['hihat','snare','hihat'], display: ['t','K','t'], name: 'offbeat snare' },
    { id: 't-b-t', sounds: ['hihat','kick','hihat'], display: ['t','B','t'], name: 'offbeat kick' },
    { id: 'k-t-k', sounds: ['snare','hihat','snare'], display: ['K','t','K'], name: 'snare sandwich' },
    { id: 'b-t-b', sounds: ['kick','hihat','kick'], display: ['B','t','B'], name: 'kick sandwich' }
];

const phrases = [
    { id: 'boots-cats', syllables: ['boots','and','cats','and'], sounds: ['kick','hihat','snare','hihat'], display: 'B t K t', name: 'boots and cats', hint: 'boots=B and=t cats=K and=t' },
    { id: 'boots-n-cats', syllables: ['boots','n','cats','n'], sounds: ['kick','hihat','snare','hihat'], display: 'B t K t', name: 'boots n cats', hint: 'boots=B n=t cats=K n=t' },
    { id: 'boots-cats-2', syllables: ['boots','cats','boots','cats'], sounds: ['kick','snare','kick','snare'], display: 'B K B K', name: 'boots cats (no hat)', hint: 'boots=B cats=K (skip the ands)' },
    { id: 'funky-town', syllables: ['fun','ky','town','uh'], sounds: ['kick','snare','kick','hihat'], display: 'B K B t', name: 'funky town', hint: 'fun=B ky=K town=B uh=t' },
    { id: 'get-funky', syllables: ['get','fun','ky','now'], sounds: ['hihat','kick','snare','kick'], display: 't B K B', name: 'get funky now', hint: 'get=t fun=B ky=K now=B' },
    { id: 'bump-ditty', syllables: ['bump','dit','ty','bump'], sounds: ['kick','hihat','hihat','kick'], display: 'B t t B', name: 'bump ditty', hint: 'bump=B dit=t ty=t bump=B' },
    { id: 'do-the-funk', syllables: ['do','the','funk','y'], sounds: ['kick','hihat','kick','snare'], display: 'B t B K', name: 'do the funk', hint: 'do=B the=t funk=B y=K' },
    { id: 'funk-machine', syllables: ['funk','ma','chine','uh'], sounds: ['kick','snare','kick','hihat'], display: 'B K B t', name: 'funk machine', hint: 'funk=B ma=K chine=B uh=t' },
    { id: 'slap-it', syllables: ['slap','it','down','now'], sounds: ['snare','hihat','kick','kick'], display: 'K t B B', name: 'slap it down', hint: 'slap=K it=t down=B now=B' },
    { id: 'in-the-pocket', syllables: ['in','the','pock','et'], sounds: ['kick','hihat','snare','hihat'], display: 'B t K t', name: 'in the pocket', hint: 'in=B the=t pock=K et=t' },
    { id: 'hit-it', syllables: ['hit','it','hit','it'], sounds: ['kick','hihat','snare','hihat'], display: 'B t K t', name: 'hit it', hint: 'hit=B it=t hit=K it=t' },
    { id: 'push-pull', syllables: ['push','uh','pull','uh'], sounds: ['kick','hihat','snare','hihat'], display: 'B t K t', name: 'push pull', hint: 'push=B uh=t pull=K uh=t' },
    { id: 'boom-bap', syllables: ['boom','bap','boom','bap'], sounds: ['kick','snare','kick','snare'], display: 'B K B K', name: 'boom bap', hint: 'boom=B bap=K' },
    { id: 'boom-clap', syllables: ['boom','clap','boom','clap'], sounds: ['kick','snare','kick','snare'], display: 'B K B K', name: 'boom clap', hint: 'boom=B clap=K' },
    { id: 'bubba-cup', syllables: ['bub','ba','cup','uh'], sounds: ['kick','kick','snare','hihat'], display: 'B B K t', name: 'bubba cup', hint: 'bub=B ba=B cup=K uh=t' },
    { id: 'coffee-cup', syllables: ['cof','fee','cup','uh'], sounds: ['kick','kick','snare','hihat'], display: 'B B K t', name: 'coffee cup', hint: 'cof=B fee=B cup=K uh=t' },
    { id: 'butter-cup', syllables: ['but','ter','cup','uh'], sounds: ['kick','kick','snare','hihat'], display: 'B B K t', name: 'butter cup', hint: 'but=B ter=B cup=K uh=t' },
    { id: 'double-up', syllables: ['dou','ble','up','now'], sounds: ['kick','kick','hihat','snare'], display: 'B B t K', name: 'double up', hint: 'dou=B ble=B up=t now=K' },
    { id: 'cats-boots', syllables: ['cats','and','boots','and'], sounds: ['snare','hihat','kick','hihat'], display: 'K t B t', name: 'cats and boots', hint: 'cats=K and=t boots=B and=t' },
    { id: 'clap-stomp', syllables: ['clap','uh','stomp','uh'], sounds: ['snare','hihat','kick','hihat'], display: 'K t B t', name: 'clap stomp', hint: 'clap=K uh=t stomp=B uh=t' },
    { id: 'snare-first', syllables: ['snare','first','kick','last'], sounds: ['snare','hihat','kick','hihat'], display: 'K t B t', name: 'snare first', hint: 'snare=K first=t kick=B last=t' },
    { id: 'pick-it-up', syllables: ['pick','it','up','now'], sounds: ['hihat','kick','hihat','snare'], display: 't B t K', name: 'pick it up', hint: 'pick=t it=B up=t now=K' },
    { id: 'and-one', syllables: ['and','one','and','two'], sounds: ['hihat','kick','hihat','snare'], display: 't B t K', name: 'and one and two', hint: 'and=t one=B and=t two=K' },
    { id: 'upbeat', syllables: ['up','beat','down','beat'], sounds: ['hihat','kick','hihat','snare'], display: 't B t K', name: 'upbeat downbeat', hint: 'up=t beat=B down=t beat=K' },
    { id: 'boots-cats-boots-cats', syllables: ['boots','and','cats','and','boots','and','cats','and'], sounds: ['kick','hihat','snare','hihat','kick','hihat','snare','hihat'], display: 'B t K t B t K t', name: 'boots and cats x2', hint: 'Full bar: boots=B and=t cats=K and=t (repeat)' },
    { id: 'funky-drummer', syllables: ['fun','ky','drum','mer','hit','it','now','uh'], sounds: ['kick','snare','kick','hihat','snare','hihat','kick','hihat'], display: 'B K B t K t B t', name: 'funky drummer', hint: 'fun=B ky=K drum=B mer=t hit=K it=t now=B uh=t' },
    { id: 'give-drummer-some', syllables: ['give','the','drum','mer','some','uh','now','uh'], sounds: ['kick','hihat','kick','snare','kick','hihat','snare','hihat'], display: 'B t B K B t K t', name: 'give drummer some', hint: 'give=B the=t drum=B mer=K some=B uh=t now=K uh=t' },
    { id: 'shake-your-body', syllables: ['shake','your','bo','dy','down','to','ground','uh'], sounds: ['kick','hihat','kick','snare','kick','hihat','snare','hihat'], display: 'B t B K B t K t', name: 'shake your body', hint: 'shake=B your=t bo=B dy=K down=B to=t ground=K uh=t' },
    { id: 'pizza-hut', syllables: ['piz','za','hut','uh'], sounds: ['kick','snare','kick','hihat'], display: 'B K B t', name: 'pizza hut', hint: 'piz=B za=K hut=B uh=t' },
    { id: 'kit-kat', syllables: ['kit','kat','kit','kat'], sounds: ['snare','snare','snare','snare'], display: 'K K K K', name: 'kit kat', hint: 'kit=K kat=K (all snares!)' },
    { id: 'ice-cream', syllables: ['ice','cream','sun','dae'], sounds: ['kick','hihat','snare','hihat'], display: 'B t K t', name: 'ice cream sundae', hint: 'ice=B cream=t sun=K dae=t' },
    { id: 'peanut-butter', syllables: ['pea','nut','but','ter'], sounds: ['kick','hihat','kick','hihat'], display: 'B t B t', name: 'peanut butter', hint: 'pea=B nut=t but=B ter=t (no snare!)' },
    { id: 'coca-cola', syllables: ['co','ca','co','la'], sounds: ['kick','hihat','snare','hihat'], display: 'B t K t', name: 'coca cola', hint: 'co=B ca=t co=K la=t' },
    { id: 'drop-beat', syllables: ['drop','the','beat','now'], sounds: ['kick','hihat','snare','kick'], display: 'B t K B', name: 'drop the beat', hint: 'drop=B the=t beat=K now=B' },
    { id: 'check-it', syllables: ['check','it','out','yo'], sounds: ['snare','hihat','kick','hihat'], display: 'K t B t', name: 'check it out', hint: 'check=K it=t out=B yo=t' },
    { id: 'rock-it', syllables: ['rock','it','dont','stop'], sounds: ['kick','hihat','snare','kick'], display: 'B t K B', name: 'rock it dont stop', hint: 'rock=B it=t dont=K stop=B' },
    { id: 'break-it-down', syllables: ['break','it','down','now'], sounds: ['kick','hihat','kick','snare'], display: 'B t B K', name: 'break it down', hint: 'break=B it=t down=B now=K' }
];

const patterns = [
    { name: 'Boots & Cats', genre: 'Foundation', tempo: 80, phonetic: 'B t K t', grid: { kick:[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0], snare:[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0], hihat:[0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0] }},
    { name: 'Simple Backbeat', genre: 'Foundation', tempo: 85, phonetic: 'B K B K', grid: { kick:[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0], snare:[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0], hihat:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0] }},
    { name: 'Funky Drummer', genre: 'Funk', tempo: 98, phonetic: 'B t K t B tK t', grid: { kick:[1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0], snare:[0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,0], hihat:[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0] }},
    { name: 'Clyde Stubblefield', genre: 'Funk', tempo: 100, phonetic: 'B t t K t B t K', grid: { kick:[1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0], snare:[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0], hihat:[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0] }},
    { name: 'James Brown 1', genre: 'Funk', tempo: 105, phonetic: 'B t K t t B K t', grid: { kick:[1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0], snare:[0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0], hihat:[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0] }},
    { name: 'P-Funk', genre: 'Funk', tempo: 96, phonetic: 'B tB t K t B K', grid: { kick:[1,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0], snare:[0,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0], hihat:[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0] }},
    { name: 'Cissy Strut', genre: 'Funk', tempo: 92, phonetic: 'B t K t B t K B', grid: { kick:[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1], snare:[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0], hihat:[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0] }},
    { name: 'Meters Groove', genre: 'Funk', tempo: 94, phonetic: 'B t t K B t K t', grid: { kick:[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0], snare:[0,0,0,0,1,0,0,0,0,0,0,0,1,0,1,0], hihat:[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0] }},
    { name: 'Chicken Grease', genre: 'Funk', tempo: 88, phonetic: 'B t K tK t B t', grid: { kick:[1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0], snare:[0,0,0,0,1,0,0,1,0,0,0,0,0,0,0,0], hihat:[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0] }},
    { name: 'Sly Stone', genre: 'Funk', tempo: 102, phonetic: 'B t K t B t tK', grid: { kick:[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0], snare:[0,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0], hihat:[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0] }},
    { name: 'Tower of Power', genre: 'Funk', tempo: 100, phonetic: 'B t K tB t K t', grid: { kick:[1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0], snare:[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0], hihat:[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0] }},
    { name: 'Superstition', genre: 'Funk', tempo: 98, phonetic: 'B B t K t B t K', grid: { kick:[1,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0], snare:[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0], hihat:[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0] }},
    { name: 'Brick House', genre: 'Funk', tempo: 104, phonetic: 'B t t K B t t K', grid: { kick:[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0], snare:[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0], hihat:[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0] }},
    { name: 'Get Up Offa', genre: 'Funk', tempo: 108, phonetic: 'B t K t B B K t', grid: { kick:[1,0,0,0,0,0,0,0,1,0,1,0,0,0,0,0], snare:[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0], hihat:[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0] }},
    { name: 'Boom Bap', genre: 'Hip-Hop', tempo: 92, phonetic: 'B t t K B B t K', grid: { kick:[1,0,0,0,0,0,1,0,1,0,0,0,0,0,0,0], snare:[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0], hihat:[0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0] }},
    { name: 'East Coast', genre: 'Hip-Hop', tempo: 90, phonetic: 'B t K t B t K t', grid: { kick:[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0], snare:[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0], hihat:[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0] }},
    { name: 'West Coast', genre: 'Hip-Hop', tempo: 88, phonetic: 'B t t K t B t K', grid: { kick:[1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0], snare:[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0], hihat:[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0] }},
    { name: 'Half-Time', genre: 'Hip-Hop', tempo: 80, phonetic: 'B t t t t t K t', grid: { kick:[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0], snare:[0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0], hihat:[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0] }},
    { name: 'Basic Rock', genre: 'Rock', tempo: 100, phonetic: 'B t t t K t t t', grid: { kick:[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0], snare:[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0], hihat:[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0] }},
    { name: 'Hard Rock', genre: 'Rock', tempo: 120, phonetic: 'B t B K B t B K', grid: { kick:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0], snare:[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0], hihat:[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0] }},
    { name: 'Four on Floor', genre: 'House', tempo: 124, phonetic: 'B t B t B t B t', grid: { kick:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0], snare:[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0], hihat:[0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0] }},
    { name: 'Trap', genre: 'Trap', tempo: 140, phonetic: 'B tttt K tttt', grid: { kick:[1,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0], snare:[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0], hihat:[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1] }}
];

// State
const S = { type: null, id: null, bpm: 80, beat: 0, step: 0, timer: null };
let audioCtx;

// ===== PRECISION AUDIO SCHEDULER =====
// Uses Web Audio API's hardware-synced clock for tight timing
const scheduler = {
    lookahead: 0.1,      // How far ahead to schedule (seconds)
    scheduleInterval: 25, // How often to call scheduler (ms)
    nextNoteTime: 0,     // When the next note is due (AudioContext time)
    timerID: null,
    rafID: null,
    currentStep: 0,      // For visual sync
    visualStepTime: 0    // When current visual step started
};

// Create state
const createState = {
    bpm: 90,
    grid: {
        kick: Array(16).fill(0),
        snare: Array(16).fill(0),
        hihat: Array(16).fill(0)
    },
    step: 0,
    playing: false,
    timer: null,
    currentId: null
};

// localStorage key
const STORAGE_KEY = 'beatbox_user_patterns';
const MAX_PATTERNS = 20;

// Audio
function getAudio() {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    return audioCtx;
}

// iOS/Safari fix: resume suspended context on user interaction
function resumeAudioContext() {
    const ctx = getAudio();
    if (ctx.state === 'suspended') {
        ctx.resume();
    }
}
['click', 'touchstart', 'keydown'].forEach(event => {
    document.addEventListener(event, resumeAudioContext);
});

// Play sound at a SPECIFIC time (for precision scheduling)
function playSoundAt(id, time) {
    const ctx = getAudio();
    const when = time || ctx.currentTime;
    
    if (id === 'kick' || id === 'kick808' || id === 'kickchest') {
        // Click transient for attack punch
        const clickOsc = ctx.createOscillator();
        const clickGain = ctx.createGain();
        clickOsc.type = 'square';
        clickOsc.frequency.setValueAtTime(1500, when);
        clickOsc.frequency.exponentialRampToValueAtTime(100, when + 0.02);
        clickGain.gain.setValueAtTime(0.2, when);
        clickGain.gain.exponentialRampToValueAtTime(0.001, when + 0.02);
        clickOsc.connect(clickGain).connect(ctx.destination);
        clickOsc.start(when);
        clickOsc.stop(when + 0.02);
        
        // Main body with improved frequency sweep
        const startFreq = id === 'kick808' ? 180 : id === 'kickchest' ? 160 : 180;
        const midFreq = id === 'kick808' ? 50 : id === 'kickchest' ? 40 : 60;
        const endFreq = id === 'kick808' ? 40 : id === 'kickchest' ? 35 : 45;
        
        const osc = ctx.createOscillator();
        const lpf = ctx.createBiquadFilter();
        const gain = ctx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(startFreq, when);
        osc.frequency.exponentialRampToValueAtTime(midFreq, when + 0.05);
        osc.frequency.exponentialRampToValueAtTime(endFreq, when + 0.15);
        lpf.type = 'lowpass';
        lpf.frequency.value = 800;
        lpf.Q.value = 1;
        gain.gain.setValueAtTime(1.2, when);
        gain.gain.linearRampToValueAtTime(0.8, when + 0.02);
        gain.gain.exponentialRampToValueAtTime(0.001, when + 0.3);
        osc.connect(lpf).connect(gain).connect(ctx.destination);
        osc.start(when);
        osc.stop(when + 0.3);
    }
    else if (id === 'snare' || id === 'snarepf' || id === 'snareinward') {
        // Body with bandpass filter
        const bodyOsc = ctx.createOscillator();
        const bodyBp = ctx.createBiquadFilter();
        const bodyGain = ctx.createGain();
        bodyOsc.type = 'triangle';
        bodyOsc.frequency.setValueAtTime(id === 'snarepf' ? 220 : 200, when);
        bodyOsc.frequency.exponentialRampToValueAtTime(120, when + 0.05);
        bodyBp.type = 'bandpass';
        bodyBp.frequency.value = id === 'snarepf' ? 180 : 200;
        bodyBp.Q.value = 2;
        bodyGain.gain.setValueAtTime(0.5, when);
        bodyGain.gain.exponentialRampToValueAtTime(0.001, when + 0.12);
        bodyOsc.connect(bodyBp).connect(bodyGain).connect(ctx.destination);
        bodyOsc.start(when);
        bodyOsc.stop(when + 0.12);
        
        // Snare wires with HP + LP filtering
        const buf = ctx.createBuffer(1, ctx.sampleRate * 0.2, ctx.sampleRate);
        const data = buf.getChannelData(0);
        for (let i = 0; i < buf.length; i++) data[i] = Math.random() * 2 - 1;
        const noise = ctx.createBufferSource();
        noise.buffer = buf;
        const nhp = ctx.createBiquadFilter();
        nhp.type = 'highpass';
        nhp.frequency.value = id === 'snarepf' ? 1500 : 2000;
        const nlp = ctx.createBiquadFilter();
        nlp.type = 'lowpass';
        nlp.frequency.value = 8000;
        const ngain = ctx.createGain();
        ngain.gain.setValueAtTime(0.6, when);
        ngain.gain.exponentialRampToValueAtTime(0.001, when + 0.18);
        noise.connect(nhp).connect(nlp).connect(ngain).connect(ctx.destination);
        noise.start(when);
        noise.stop(when + 0.2);
    }
    else if (id === 'hihat' || id === 'hihatopen' || id === 'hihatinward') {
        const duration = id === 'hihatopen' ? 0.25 : 0.08;
        const buf = ctx.createBuffer(1, ctx.sampleRate * duration, ctx.sampleRate);
        const data = buf.getChannelData(0);
        for (let i = 0; i < buf.length; i++) data[i] = Math.random() * 2 - 1;
        const noise = ctx.createBufferSource();
        noise.buffer = buf;
        const hp = ctx.createBiquadFilter();
        hp.type = 'highpass';
        hp.frequency.value = 7000;
        const bp = ctx.createBiquadFilter();
        bp.type = 'bandpass';
        bp.frequency.value = 10000;
        bp.Q.value = 1.5;
        // High shelf for air/shimmer
        const hs = ctx.createBiquadFilter();
        hs.type = 'highshelf';
        hs.frequency.value = 12000;
        hs.gain.value = 3;
        const gain = ctx.createGain();
        if (id === 'hihatopen') {
            gain.gain.setValueAtTime(0.4, when);
            gain.gain.linearRampToValueAtTime(0.35, when + 0.02);
            gain.gain.exponentialRampToValueAtTime(0.001, when + duration);
        } else {
            gain.gain.setValueAtTime(0.5, when);
            gain.gain.exponentialRampToValueAtTime(0.001, when + duration);
        }
        noise.connect(hp).connect(bp).connect(hs).connect(gain).connect(ctx.destination);
        noise.start(when);
        noise.stop(when + duration);
    }
}

// Wrapper for immediate playback (tap to preview)
function playSound(id) {
    playSoundAt(id, null);
}

// ===== CREATE FUNCTIONS =====
function loadSavedPatterns() {
    try {
        return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    } catch {
        return [];
    }
}

function savePatternsToStorage(patterns) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(patterns));
}

function renderCreateGrid() {
    ['kick', 'snare', 'hihat'].forEach(track => {
        const container = document.getElementById(track + 'Steps');
        container.innerHTML = '';
        for (let i = 0; i < 16; i++) {
            const step = document.createElement('div');
            step.className = 'seq-step' + (createState.grid[track][i] ? ' active' : '');
            step.dataset.track = track;
            step.dataset.step = i;
            container.appendChild(step);
        }
    });
}

function renderSavedList() {
    const patterns = loadSavedPatterns();
    const list = document.getElementById('savedList');
    const count = document.getElementById('savedCount');
    
    count.textContent = `${patterns.length} / ${MAX_PATTERNS}`;
    
    if (patterns.length === 0) {
        list.innerHTML = '<div class="empty-state">No saved patterns yet.<br>Create one above!</div>';
        return;
    }
    
    list.innerHTML = patterns.map((p, i) => `
        <div class="saved-item ${createState.currentId === p.id ? 'active' : ''}" data-idx="${i}">
            <div class="saved-item-info">
                <div class="saved-item-name">${p.name}</div>
                <div class="saved-item-meta">${p.bpm} BPM</div>
            </div>
            <div class="saved-item-actions">
                <button class="saved-item-btn" data-action="load" data-idx="${i}" title="Load">ðŸ“‚</button>
                <button class="saved-item-btn delete" data-action="delete" data-idx="${i}" title="Delete">ðŸ—‘</button>
            </div>
        </div>
    `).join('');
}

function loadPatternToCreate(pattern) {
    createState.grid = JSON.parse(JSON.stringify(pattern.grid));
    createState.bpm = pattern.bpm;
    createState.currentId = pattern.id;
    document.getElementById('createName').value = pattern.name;
    document.getElementById('createBpmValue').textContent = createState.bpm;
    renderCreateGrid();
    renderSavedList();
}

function saveCurrentPattern() {
    const name = document.getElementById('createName').value.trim() || 'My Beat';
    const patterns = loadSavedPatterns();
    
    // Check if updating existing
    const existingIdx = patterns.findIndex(p => p.id === createState.currentId);
    
    const pattern = {
        id: createState.currentId || Date.now().toString(),
        name,
        bpm: createState.bpm,
        grid: JSON.parse(JSON.stringify(createState.grid)),
        created: existingIdx >= 0 ? patterns[existingIdx].created : Date.now()
    };
    
    if (existingIdx >= 0) {
        patterns[existingIdx] = pattern;
    } else {
        if (patterns.length >= MAX_PATTERNS) {
            alert(`Max ${MAX_PATTERNS} patterns. Delete one first.`);
            return;
        }
        patterns.push(pattern);
    }
    
    createState.currentId = pattern.id;
    savePatternsToStorage(patterns);
    renderSavedList();
}

function deletePattern(idx) {
    const patterns = loadSavedPatterns();
    if (patterns[idx] && patterns[idx].id === createState.currentId) {
        createState.currentId = null;
    }
    patterns.splice(idx, 1);
    savePatternsToStorage(patterns);
    renderSavedList();
}

function clearCreateGrid() {
    createState.grid = { kick: Array(16).fill(0), snare: Array(16).fill(0), hihat: Array(16).fill(0) };
    createState.currentId = null;
    document.getElementById('createName').value = '';
    renderCreateGrid();
    renderSavedList();
}

function encodePatternToURL() {
    const name = document.getElementById('createName').value.trim() || 'My Beat';
    const kickBits = createState.grid.kick.map(v => v ? '1' : '0').join('');
    const snareBits = createState.grid.snare.map(v => v ? '1' : '0').join('');
    const hihatBits = createState.grid.hihat.map(v => v ? '1' : '0').join('');
    const data = `${createState.bpm}|${kickBits}|${snareBits}|${hihatBits}|${encodeURIComponent(name)}`;
    return window.location.origin + window.location.pathname + '?p=' + btoa(data);
}

function decodePatternFromURL() {
    const params = new URLSearchParams(window.location.search);
    const encoded = params.get('p');
    if (!encoded) return null;
    
    try {
        const data = atob(encoded);
        const [bpm, kickBits, snareBits, hihatBits, name] = data.split('|');
        return {
            bpm: parseInt(bpm) || 90,
            name: decodeURIComponent(name || 'Shared Beat'),
            grid: {
                kick: kickBits.split('').map(v => parseInt(v)),
                snare: snareBits.split('').map(v => parseInt(v)),
                hihat: hihatBits.split('').map(v => parseInt(v))
            }
        };
    } catch {
        return null;
    }
}

function startCreatePlayback() {
    if (createState.playing) {
        stopCreatePlayback();
        return;
    }
    
    const ctx = getAudio();
    if (ctx.state === 'suspended') ctx.resume();
    
    createState.playing = true;
    createState.step = 0;
    document.getElementById('createPlayBtn').textContent = 'â–  Stop';
    
    // Initialize precision scheduler
    scheduler.nextNoteTime = ctx.currentTime + 0.05; // Start slightly in future
    scheduler.currentStep = 0;
    scheduler.visualStepTime = performance.now();
    
    // Schedule ahead function - schedules notes into the future
    function scheduleAhead() {
        const secondsPerBeat = 60.0 / createState.bpm / 4; // 16th notes
        
        // Schedule notes while we're within the lookahead window
        while (scheduler.nextNoteTime < ctx.currentTime + scheduler.lookahead) {
            // Schedule sounds at the precise time
            if (createState.grid.kick[createState.step]) playSoundAt('kick', scheduler.nextNoteTime);
            if (createState.grid.snare[createState.step]) playSoundAt('snare', scheduler.nextNoteTime);
            if (createState.grid.hihat[createState.step]) playSoundAt('hihat', scheduler.nextNoteTime);
            
            // Store time for visual sync
            if (createState.step !== scheduler.currentStep) {
                scheduler.currentStep = createState.step;
                scheduler.visualStepTime = scheduler.nextNoteTime;
            }
            
            // Advance to next step
            scheduler.nextNoteTime += secondsPerBeat;
            createState.step = (createState.step + 1) % 16;
        }
    }
    
    // Visual update using requestAnimationFrame (synced to screen refresh)
    function updateVisuals() {
        if (!createState.playing) return;
        
        const ctx = getAudio();
        const currentTime = ctx.currentTime;
        const secondsPerBeat = 60.0 / createState.bpm / 4;
        
        // Calculate which step should be visually highlighted based on audio time
        // This syncs visuals to audio clock, not JavaScript timing
        let visualStep = scheduler.currentStep;
        const timeSinceLastStep = currentTime - scheduler.visualStepTime;
        if (timeSinceLastStep >= secondsPerBeat) {
            visualStep = (visualStep + Math.floor(timeSinceLastStep / secondsPerBeat)) % 16;
        }
        
        // Update visual highlighting
        document.querySelectorAll('.seq-step').forEach(el => el.classList.remove('current'));
        document.querySelectorAll(`.seq-step[data-step="${visualStep}"]`).forEach(el => el.classList.add('current'));
        
        scheduler.rafID = requestAnimationFrame(updateVisuals);
    }
    
    // Start the scheduler loop
    scheduler.timerID = setInterval(scheduleAhead, scheduler.scheduleInterval);
    scheduler.rafID = requestAnimationFrame(updateVisuals);
    
    // Initial schedule
    scheduleAhead();
}

function stopCreatePlayback() {
    createState.playing = false;
    
    // Stop precision scheduler
    if (scheduler.timerID) {
        clearInterval(scheduler.timerID);
        scheduler.timerID = null;
    }
    if (scheduler.rafID) {
        cancelAnimationFrame(scheduler.rafID);
        scheduler.rafID = null;
    }
    
    // Legacy timer cleanup (for backwards compat)
    if (createState.timer) {
        clearInterval(createState.timer);
        createState.timer = null;
    }
    
    document.querySelectorAll('.seq-step').forEach(el => el.classList.remove('current'));
    document.getElementById('createPlayBtn').textContent = 'â–¶ Play';
}

// Rendering
function renderSounds() {
    const kicks = sounds.filter(s => s.category === 'Kick');
    const hihats = sounds.filter(s => s.category === 'Hi-Hat');
    const snares = sounds.filter(s => s.category === 'Snare');
    
    const el = document.getElementById('soundCards');
    el.innerHTML = `
        <div class="grid">${kicks.map(s => `
            <div class="card" data-type="sound" data-id="${s.id}">
                <div class="card-phonetic">${s.phonetic}</div>
                <div class="card-name">${s.name}</div>
                <div class="card-status">â–¶</div>
            </div>
        `).join('')}</div>
        <div style="height:10px"></div>
        <div class="grid">${hihats.map(s => `
            <div class="card" data-type="sound" data-id="${s.id}">
                <div class="card-phonetic">${s.phonetic}</div>
                <div class="card-name">${s.name}</div>
                <div class="card-status">â–¶</div>
            </div>
        `).join('')}</div>
        <div style="height:10px"></div>
        <div class="grid">${snares.map(s => `
            <div class="card" data-type="sound" data-id="${s.id}">
                <div class="card-phonetic">${s.phonetic}</div>
                <div class="card-name">${s.name}</div>
                <div class="card-status">â–¶</div>
            </div>
        `).join('')}</div>
    `;
}

function renderCombos() {
    document.getElementById('comboGrid').innerHTML = combos.map(c => `
        <div class="card" data-type="combo" data-id="${c.id}">
            <div class="card-phonetic">${c.display.join(' ')}</div>
            <div class="card-name">${c.name}</div>
            <div class="card-status">â–¶</div>
        </div>
    `).join('');
}

function renderTriplets() {
    document.getElementById('tripletGrid').innerHTML = triplets.map(t => `
        <div class="card" data-type="triplet" data-id="${t.id}">
            <div class="card-phonetic">${t.display.join(' ')}</div>
            <div class="card-name">${t.name}</div>
            <div class="card-status">â–¶</div>
        </div>
    `).join('');
}

function renderPhrases() {
    document.getElementById('phraseGrid').innerHTML = phrases.map(p => `
        <div class="card" data-type="phrase" data-id="${p.id}">
            <div class="card-phonetic">${p.display}</div>
            <div class="card-name">${p.name}</div>
            <div class="card-hint">${p.hint}</div>
            <div class="card-status">â–¶</div>
        </div>
    `).join('');
}

function renderPatterns() {
    document.getElementById('patternCards').innerHTML = patterns.map((p, i) => `
        <div class="pattern-card" data-type="pattern" data-id="${i}">
            <div class="pattern-name">${p.name}</div>
            <div class="pattern-meta">${p.genre} â€¢ ${p.tempo} BPM</div>
            <div class="pattern-phonetic">${p.phonetic}</div>
            <div class="pattern-visualizer" id="viz-${i}">
                ${Array(16).fill(0).map((_, j) => {
                    let cls = 'pattern-step';
                    if (p.grid.kick[j]) cls += ' kick';
                    else if (p.grid.snare[j]) cls += ' snare';
                    else if (p.grid.hihat[j]) cls += ' hihat';
                    return `<div class="${cls}" data-step="${j}"></div>`;
                }).join('')}
            </div>
            <div class="pattern-status">â–¶</div>
        </div>
    `).join('');
}

function renderReference() {
    const kicks = sounds.filter(s => s.category === 'Kick');
    const hihats = sounds.filter(s => s.category === 'Hi-Hat');
    const snares = sounds.filter(s => s.category === 'Snare');
    
    const renderGroup = (items) => items.map(s => `
        <div class="ref-card">
            <div class="ref-header">
                <div class="ref-phonetic">${s.phonetic}</div>
                <div class="ref-title">
                    <div class="ref-name">${s.name}</div>
                    <div class="ref-category">${s.category}</div>
                </div>
            </div>
            <div class="ref-text">${s.ref}</div>
            <a class="ref-link" href="${s.tutorial}" target="_blank">Watch Tutorials â†’</a>
        </div>
    `).join('');
    
    document.getElementById('refCards').innerHTML = 
        '<div class="section-label" style="margin-top:0">Kicks</div>' + renderGroup(kicks) +
        '<div class="section-label">Hi-Hats</div>' + renderGroup(hihats) +
        '<div class="section-label">Snares</div>' + renderGroup(snares);
}

function updateDisplay(type, current, items, isPlaying = false) {
    const displayId = type === 'combo' ? 'comboDisplay' : type === 'triplet' ? 'tripletDisplay' : type === 'pattern' ? 'patternDisplay' : 'phraseDisplay';
    const display = document.getElementById(displayId);
    
    const highlighted = items.map((x, i) => i === current ? `<span class="current">${x}</span>` : x).join(' ');
    display.innerHTML = `
        <div class="drill-phonetic">${highlighted}</div>
        <div class="bpm-control">
            <button class="stop-btn ${isPlaying ? 'playing' : ''}" data-action="stop">${isPlaying ? 'â– ' : 'â–¶'}</button>
            <button class="bpm-btn" data-delta="-5">âˆ’</button>
            <div class="bpm-value">${S.bpm}</div>
            <button class="bpm-btn" data-delta="5">+</button>
        </div>
    `;
}

function updatePatternViz() {
    if (S.type !== 'pattern') return;
    const viz = document.getElementById(`viz-${S.id}`);
    if (!viz) return;
    
    // Use scheduler's current step for visual sync
    const visualStep = scheduler.currentStep;
    viz.querySelectorAll('.pattern-step').forEach((el, i) => {
        el.classList.toggle('current', i === visualStep);
    });
}

// Playback control
function stopAll() {
    // Stop precision scheduler
    if (scheduler.timerID) {
        clearInterval(scheduler.timerID);
        scheduler.timerID = null;
    }
    if (scheduler.rafID) {
        cancelAnimationFrame(scheduler.rafID);
        scheduler.rafID = null;
    }
    
    // Legacy timer cleanup
    if (S.timer) {
        clearInterval(S.timer);
        S.timer = null;
    }
    
    document.querySelectorAll('.card, .pattern-card').forEach(c => c.classList.remove('playing'));
    document.querySelectorAll('.pattern-step').forEach(el => el.classList.remove('current'));
    document.querySelectorAll('.stop-btn').forEach(b => { b.classList.remove('playing'); b.textContent = 'â–¶'; });
    S.type = null;
    S.id = null;
    S.beat = 0;
    S.step = 0;
}

function startLoop(type, id) {
    stopAll();
    
    const ctx = getAudio();
    if (ctx.state === 'suspended') ctx.resume();
    
    S.type = type;
    S.id = id;
    S.beat = 0;
    S.step = 0;
    
    const card = document.querySelector(`[data-type="${type}"][data-id="${id}"]`);
    if (card) card.classList.add('playing');
    
    // Initialize precision scheduler for main loops
    scheduler.nextNoteTime = ctx.currentTime + 0.05;
    scheduler.currentStep = 0;
    scheduler.visualStepTime = ctx.currentTime;
    
    function scheduleMainAhead() {
        const secondsPerBeat = type === 'pattern' ? 60.0 / S.bpm / 4 : 60.0 / S.bpm;
        
        while (scheduler.nextNoteTime < ctx.currentTime + scheduler.lookahead) {
            if (type === 'sound') {
                playSoundAt(id, scheduler.nextNoteTime);
            }
            else if (type === 'combo') {
                const combo = combos.find(c => c.id === id);
                const soundIdx = S.beat % combo.sounds.length;
                playSoundAt(combo.sounds[soundIdx], scheduler.nextNoteTime);
                scheduler.currentStep = soundIdx;
                S.beat++;
            }
            else if (type === 'triplet') {
                const triplet = triplets.find(t => t.id === id);
                const soundIdx = S.beat % triplet.sounds.length;
                playSoundAt(triplet.sounds[soundIdx], scheduler.nextNoteTime);
                scheduler.currentStep = soundIdx;
                S.beat++;
            }
            else if (type === 'phrase') {
                const phrase = phrases.find(p => p.id === id);
                const soundIdx = S.beat % phrase.sounds.length;
                playSoundAt(phrase.sounds[soundIdx], scheduler.nextNoteTime);
                scheduler.currentStep = soundIdx;
                S.beat++;
            }
            else if (type === 'pattern') {
                const pattern = patterns[parseInt(id)];
                if (pattern.grid.kick[S.step]) playSoundAt('kick', scheduler.nextNoteTime);
                if (pattern.grid.snare[S.step]) playSoundAt('snare', scheduler.nextNoteTime);
                if (pattern.grid.hihat[S.step]) playSoundAt('hihat', scheduler.nextNoteTime);
                scheduler.currentStep = S.step;
                S.step = (S.step + 1) % 16;
            }
            
            scheduler.visualStepTime = scheduler.nextNoteTime;
            scheduler.nextNoteTime += secondsPerBeat;
        }
    }
    
    function updateMainVisuals() {
        if (!S.type) return;
        
        const currentTime = ctx.currentTime;
        const secondsPerBeat = S.type === 'pattern' ? 60.0 / S.bpm / 4 : 60.0 / S.bpm;
        
        // Sync visual to audio clock
        let visualStep = scheduler.currentStep;
        
        if (type === 'combo') {
            const combo = combos.find(c => c.id === id);
            updateDisplay('combo', visualStep, combo.display, true);
        }
        else if (type === 'triplet') {
            const triplet = triplets.find(t => t.id === id);
            updateDisplay('triplet', visualStep, triplet.display, true);
        }
        else if (type === 'phrase') {
            const phrase = phrases.find(p => p.id === id);
            updateDisplay('phrase', visualStep, phrase.display.split(' '), true);
        }
        else if (type === 'pattern') {
            updatePatternViz();
            const pattern = patterns[parseInt(id)];
            updateDisplay('pattern', Math.floor(visualStep / 2), pattern.phonetic.split(' '), true);
        }
        
        scheduler.rafID = requestAnimationFrame(updateMainVisuals);
    }
    
    // Start precision scheduler
    scheduler.timerID = setInterval(scheduleMainAhead, scheduler.scheduleInterval);
    scheduler.rafID = requestAnimationFrame(updateMainVisuals);
    scheduleMainAhead();
}

function setBPM(newBpm) {
    S.bpm = Math.max(40, Math.min(200, newBpm));
    // BPM changes take effect automatically since scheduler reads S.bpm each cycle
    document.querySelectorAll('.bpm-value').forEach(el => el.textContent = S.bpm);
}

// Event handlers
document.addEventListener('click', e => {
    // Create view handlers
    if (e.target.closest('#createView')) {
        const seqStep = e.target.closest('.seq-step');
        if (seqStep) {
            const track = seqStep.dataset.track;
            const step = parseInt(seqStep.dataset.step);
            createState.grid[track][step] = createState.grid[track][step] ? 0 : 1;
            seqStep.classList.toggle('active');
            return;
        }
        
        if (e.target.id === 'createPlayBtn') {
            startCreatePlayback();
            return;
        }
        if (e.target.id === 'createClearBtn') {
            stopCreatePlayback();
            clearCreateGrid();
            return;
        }
        if (e.target.id === 'createSaveBtn') {
            saveCurrentPattern();
            return;
        }
        if (e.target.id === 'createShareBtn') {
            const url = encodePatternToURL();
            const shareEl = document.getElementById('shareUrl');
            shareEl.textContent = url;
            shareEl.classList.add('visible');
            navigator.clipboard.writeText(url).catch(() => {});
            return;
        }
        if (e.target.id === 'createBpmDown') {
            createState.bpm = Math.max(40, createState.bpm - 5);
            document.getElementById('createBpmValue').textContent = createState.bpm;
            if (createState.playing) {
                stopCreatePlayback();
                startCreatePlayback();
            }
            return;
        }
        if (e.target.id === 'createBpmUp') {
            createState.bpm = Math.min(200, createState.bpm + 5);
            document.getElementById('createBpmValue').textContent = createState.bpm;
            if (createState.playing) {
                stopCreatePlayback();
                startCreatePlayback();
            }
            return;
        }
        
        const savedBtn = e.target.closest('.saved-item-btn');
        if (savedBtn) {
            const idx = parseInt(savedBtn.dataset.idx);
            const action = savedBtn.dataset.action;
            if (action === 'load') {
                const patterns = loadSavedPatterns();
                if (patterns[idx]) {
                    stopCreatePlayback();
                    loadPatternToCreate(patterns[idx]);
                }
            } else if (action === 'delete') {
                if (confirm('Delete this pattern?')) {
                    deletePattern(idx);
                }
            }
            return;
        }
        
        const savedItem = e.target.closest('.saved-item');
        if (savedItem && !e.target.closest('.saved-item-btn')) {
            const idx = parseInt(savedItem.dataset.idx);
            const patterns = loadSavedPatterns();
            if (patterns[idx]) {
                stopCreatePlayback();
                loadPatternToCreate(patterns[idx]);
            }
            return;
        }
        
        return;
    }
    
    const card = e.target.closest('[data-type]');
    if (card) {
        const type = card.dataset.type;
        const id = card.dataset.id;
        
        if (type === 'sound') {
            if (S.type === 'sound' && S.id === id) {
                stopAll();
            } else {
                stopAll();
                playSound(id);
                card.classList.add('playing');
                S.type = 'sound';
                S.id = id;
                S.timer = setInterval(() => playSound(id), 60000 / S.bpm);
            }
        } else {
            if (S.type === type && S.id === id) {
                stopAll();
                if (type === 'combo') updateDisplay('combo', -1, combos.find(c => c.id === id).display, false);
                if (type === 'triplet') updateDisplay('triplet', -1, triplets.find(t => t.id === id).display, false);
                if (type === 'phrase') updateDisplay('phrase', -1, phrases.find(p => p.id === id).display.split(' '), false);
                if (type === 'pattern') updateDisplay('pattern', -1, patterns[parseInt(id)].phonetic.split(' '), false);
            } else {
                if (type === 'pattern') {
                    S.bpm = patterns[parseInt(id)].tempo;
                }
                startLoop(type, id);
            }
        }
        return;
    }
    
    const stopBtn = e.target.closest('.stop-btn');
    if (stopBtn) {
        if (S.timer) {
            stopAll();
            updateDisplay('combo', -1, ['B','t'], false);
            updateDisplay('triplet', -1, ['B','t','K'], false);
            updateDisplay('phrase', -1, ['B','t','K','t'], false);
            updateDisplay('pattern', -1, ['B','t','K','t'], false);
        }
        return;
    }
    
    const bpmBtn = e.target.closest('.bpm-btn');
    if (bpmBtn && !e.target.closest('#createView')) {
        setBPM(S.bpm + parseInt(bpmBtn.dataset.delta));
        return;
    }
    
    const navBtn = e.target.closest('.nav-btn');
    if (navBtn) {
        stopAll();
        stopCreatePlayback();
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        navBtn.classList.add('active');
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(navBtn.dataset.view + 'View').classList.add('active');
    }
});

// Stop on page visibility change
document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        stopAll();
        stopCreatePlayback();
    }
});

// Init
function init() {
    renderSounds();
    renderCombos();
    renderTriplets();
    renderPhrases();
    renderPatterns();
    renderReference();
    renderCreateGrid();
    renderSavedList();
    updateDisplay('combo', -1, ['B','t'], false);
    updateDisplay('triplet', -1, ['B','t','K'], false);
    updateDisplay('phrase', -1, ['B','t','K','t'], false);
    updateDisplay('pattern', -1, ['B','t','K','t'], false);
    
    // Check for shared pattern in URL
    const shared = decodePatternFromURL();
    if (shared) {
        createState.grid = shared.grid;
        createState.bpm = shared.bpm;
        document.getElementById('createName').value = shared.name;
        document.getElementById('createBpmValue').textContent = shared.bpm;
        renderCreateGrid();
        // Switch to Create view
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.querySelector('[data-view="create"]').classList.add('active');
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById('createView').classList.add('active');
    }
}

init();
</script>
</body>
</html>
