<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>YEN's Beatbox Trainer</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Space+Grotesk:wght@300;400;500;600;700&display=swap');

        :root {
            --bg-primary: #0A0A0B;
            --bg-secondary: #111113;
            --bg-tertiary: #1A1A1D;
            --bg-card: #151517;
            --text-primary: #FAFAFA;
            --text-secondary: #71717A;
            --text-muted: #52525B;
            --accent: #F97316;
            --accent-hover: #FB923C;
            --accent-glow: rgba(249, 115, 22, 0.3);
            --border: #27272A;
            --border-light: #3F3F46;
            --success: #22C55E;
            --success-glow: rgba(34, 197, 94, 0.3);
            --beginner: #22C55E;
            --intermediate: #EAB308;
            --advanced: #EF4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            font-size: 16px;
        }

        body {
            font-family: 'Space Grotesk', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            padding: 12px;
            padding-bottom: env(safe-area-inset-bottom, 12px);
            overflow-x: hidden;
        }

        /* ===== HEADER - Mobile First ===== */
        .header {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            font-size: 18px;
            font-weight: 600;
        }

        .logo span {
            color: var(--accent);
        }

        .subtitle {
            display: none;
        }

        .mode-tabs {
            display: flex;
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 3px;
            gap: 2px;
        }

        .mode-tab {
            padding: 10px 12px;
            min-height: 44px;
            background: transparent;
            border: none;
            border-radius: 6px;
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mode-tab.active {
            background: var(--accent);
            color: white;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--border);
            transition: all 0.3s;
            margin-left: 8px;
        }

        .status-indicator.active {
            background: var(--accent);
            box-shadow: 0 0 12px var(--accent-glow);
        }

        /* ===== MAIN LAYOUT ===== */
        .main-grid {
            display: block;
        }

        .sidebar {
            display: none;
        }

        .main-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            min-height: calc(100vh - 100px);
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        /* ===== PHASE NAVIGATION ===== */
        .phase-nav {
            display: flex;
            gap: 6px;
            margin-bottom: 16px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            padding-bottom: 4px;
        }

        .phase-nav::-webkit-scrollbar {
            display: none;
        }

        .phase-btn {
            padding: 12px 14px;
            min-height: 48px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .phase-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        /* ===== PHASE HEADER ===== */
        .phase-header {
            margin-bottom: 20px;
        }

        .phase-title {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .phase-desc {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* ===== SOUND SELECTOR GRID ===== */
        .selector-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .selector-card {
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 16px 12px;
            cursor: pointer;
            text-align: center;
            position: relative;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .selector-card:active {
            transform: scale(0.97);
        }

        .selector-card.selected {
            border-color: var(--accent);
            background: rgba(249, 115, 22, 0.1);
        }

        .selector-card.completed {
            border-color: var(--success);
        }

        .selector-card.completed::after {
            content: '✓';
            position: absolute;
            top: 6px;
            right: 8px;
            color: var(--success);
            font-weight: 700;
            font-size: 14px;
        }

        .selector-phonetic {
            font-size: 26px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent);
            margin-bottom: 4px;
        }

        .selector-name {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* ===== DRILL CARD ===== */
        .drill-card {
            background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px 16px;
        }

        .drill-display {
            text-align: center;
            margin-bottom: 20px;
        }

        .drill-phonetic {
            font-size: 56px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent);
            text-shadow: 0 0 40px var(--accent-glow);
        }

        .drill-name {
            font-size: 16px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* ===== INSTRUCTION CARD ===== */
        .drill-instruction {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
        }

        .drill-instruction-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--accent);
            margin-bottom: 8px;
        }

        .drill-instruction-text {
            font-size: 14px;
            line-height: 1.6;
        }

        .drill-steps {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        .drill-step {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            font-size: 13px;
            color: var(--text-secondary);
            align-items: flex-start;
        }

        .drill-step-num {
            background: var(--accent);
            color: white;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .youtube-link {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin: 16px 0;
            padding: 14px 20px;
            background: #FF0000;
            color: white;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            text-decoration: none;
            min-height: 48px;
        }

        /* ===== BEAT INDICATOR ===== */
        .beat-indicator {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin: 24px 0;
            flex-wrap: wrap;
        }

        .beat-dot {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--bg-primary);
            border: 3px solid var(--border);
            transition: all 0.1s;
        }

        .beat-dot.active {
            background: var(--accent);
            border-color: var(--accent);
            box-shadow: 0 0 20px var(--accent-glow);
            transform: scale(1.25);
        }

        /* ===== TIMER ===== */
        .drill-timer {
            text-align: center;
            margin: 20px 0;
        }

        .timer-display {
            font-size: 48px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .timer-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-top: 4px;
        }

        /* ===== BIG MOBILE BUTTONS ===== */
        .drill-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }

        .btn {
            padding: 16px 24px;
            min-height: 56px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.15s;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn.primary {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .btn.primary:active {
            background: var(--accent-hover);
        }

        .btn-row {
            display: flex;
            gap: 10px;
        }

        .btn-row .btn {
            flex: 1;
        }

        /* ===== TEMPO CONTROL - BUTTONS NOT SLIDER ===== */
        .tempo-control {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin: 20px 0;
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 12px;
        }

        .tempo-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            color: var(--text-primary);
            font-size: 24px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: inherit;
            transition: all 0.1s;
        }

        .tempo-btn:active {
            background: var(--accent);
            border-color: var(--accent);
            transform: scale(0.95);
        }

        .tempo-display {
            min-width: 100px;
            text-align: center;
        }

        .tempo-value {
            font-size: 32px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent);
        }

        .tempo-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-top: 2px;
        }

        /* ===== STATS GRID ===== */
        .drill-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 20px;
        }

        .stat-card {
            background: var(--bg-primary);
            border-radius: 10px;
            padding: 14px 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .stat-label {
            font-size: 9px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-top: 4px;
        }

        /* ===== COMBO/TRIPLET DISPLAY ===== */
        .combo-display,
        .triplet-display {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .combo-phonetic {
            font-size: 44px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent);
            transition: all 0.15s;
        }

        .combo-phonetic.current {
            text-shadow: 0 0 30px var(--accent-glow);
            transform: scale(1.2);
        }

        .combo-phonetic.inactive {
            color: var(--text-muted);
            opacity: 0.4;
        }

        .combo-arrow {
            font-size: 24px;
            color: var(--text-muted);
        }

        .triplet-phonetic {
            font-size: 38px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent);
            transition: all 0.1s;
        }

        .triplet-phonetic.current {
            text-shadow: 0 0 30px var(--accent-glow);
            transform: scale(1.15);
        }

        .triplet-phonetic.inactive {
            color: var(--text-muted);
            opacity: 0.4;
        }

        /* ===== PATTERNS SECTION ===== */
        .transport {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 16px;
        }

        .transport-controls {
            display: flex;
            gap: 8px;
        }

        .transport-controls .btn {
            flex: 1;
            min-height: 52px;
        }

        .pattern-info {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 12px;
            border: 1px solid var(--border);
        }

        .pattern-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .pattern-description {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .phonetic-guide {
            background: linear-gradient(135deg, rgba(249, 115, 22, 0.15), rgba(249, 115, 22, 0.05));
            border: 1px solid var(--accent);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 12px;
            text-align: center;
        }

        .phonetic-text {
            font-size: 20px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent);
            letter-spacing: 2px;
        }

        .phonetic-help {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* ===== SEQUENCER - Hidden on mobile, show message ===== */
        .sequencer {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .sequencer-mobile-msg {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.6;
            padding: 20px 0;
        }

        .sequencer-mobile-msg strong {
            color: var(--accent);
        }

        .sequencer-grid {
            display: none;
        }

        /* ===== PATTERN LIST (for mobile) ===== */
        .pattern-list-mobile {
            margin-top: 16px;
        }

        .pattern-list-mobile .pattern-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 14px 16px;
            margin-bottom: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 56px;
        }

        .pattern-list-mobile .pattern-item:active {
            background: var(--bg-secondary);
        }

        .pattern-list-mobile .pattern-item.active {
            border-color: var(--accent);
            background: rgba(249, 115, 22, 0.1);
        }

        .pattern-list-mobile .pattern-name {
            font-weight: 600;
            font-size: 14px;
        }

        .pattern-list-mobile .pattern-meta {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .pattern-list-mobile .pattern-phonetic {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--accent);
        }

        /* ===== AI GURU SECTION ===== */
        .guru-header {
            margin-bottom: 16px;
        }

        .guru-title {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .guru-desc {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .api-key-input {
            width: 100%;
            padding: 14px;
            min-height: 48px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 14px;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .guru-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }

        .guru-suggestion {
            padding: 12px 14px;
            min-height: 44px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 13px;
            color: var(--text-secondary);
            cursor: pointer;
            font-family: inherit;
        }

        .guru-suggestion:active {
            border-color: var(--accent);
            color: var(--accent);
        }

        .chat-container {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }

        .chat-messages {
            height: 300px;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .chat-message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.5;
        }

        .chat-message.user {
            align-self: flex-end;
            background: var(--accent);
            color: white;
        }

        .chat-message.assistant {
            align-self: flex-start;
            background: var(--bg-primary);
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
            padding: 12px;
            border-top: 1px solid var(--border);
        }

        .chat-input {
            flex: 1;
            padding: 14px;
            min-height: 48px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
            color: var(--text-primary);
        }

        .chat-send {
            padding: 14px 20px;
            min-height: 48px;
            background: var(--accent);
            border: none;
            border-radius: 10px;
            color: white;
            font-family: inherit;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
        }

        /* ===== STATUS MESSAGE ===== */
        .status-message {
            position: fixed;
            bottom: 20px;
            left: 12px;
            right: 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 14px 18px;
            font-size: 14px;
            display: none;
            z-index: 1000;
            text-align: center;
        }

        .status-message.show {
            display: block;
        }

        .status-message.success {
            border-color: var(--success);
            color: var(--success);
        }

        /* ===== DESKTOP OVERRIDES ===== */
        @media (min-width: 768px) {
            body {
                padding: 20px;
            }

            .header {
                padding: 16px 24px;
            }

            .logo {
                font-size: 22px;
            }

            .subtitle {
                display: block;
                font-size: 10px;
                letter-spacing: 0.1em;
                color: var(--text-muted);
                text-transform: uppercase;
                margin-top: 2px;
            }

            .main-grid {
                display: grid;
                grid-template-columns: 280px 1fr;
                gap: 16px;
                align-items: start;
            }

            .sidebar {
                display: block;
                background: var(--bg-card);
                border: 1px solid var(--border);
                border-radius: 12px;
                padding: 16px;
                max-height: calc(100vh - 120px);
                overflow-y: auto;
                position: sticky;
                top: 20px;
            }

            .main-content {
                padding: 24px;
            }

            .selector-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            }

            .drill-phonetic {
                font-size: 72px;
            }

            .drill-controls {
                flex-direction: row;
                justify-content: center;
            }

            .drill-controls .btn {
                flex: none;
                min-width: 140px;
            }

            .btn-row {
                justify-content: center;
            }

            .tempo-btn {
                width: 48px;
                height: 48px;
                font-size: 20px;
            }

            .tempo-value {
                font-size: 28px;
            }

            .sequencer-mobile-msg {
                display: none;
            }

            .sequencer-grid {
                display: block;
            }

            .pattern-list-mobile {
                display: none;
            }

            .chat-messages {
                height: 350px;
            }
        }

        /* Sidebar styles for desktop */
        .sidebar-section {
            margin-bottom: 20px;
        }

        .sidebar-section:last-child {
            margin-bottom: 0;
        }

        .sidebar-title {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            margin-bottom: 10px;
            padding-bottom: 6px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
        }

        .difficulty-badge {
            font-size: 8px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }

        .difficulty-badge.beginner {
            background: var(--beginner);
            color: #000;
        }

        .difficulty-badge.intermediate {
            background: var(--intermediate);
            color: #000;
        }

        .difficulty-badge.advanced {
            background: var(--advanced);
            color: white;
        }

        .sound-card-mini {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sound-card-mini:hover {
            border-color: var(--accent);
            background: var(--bg-secondary);
        }

        .sound-phonetic-mini {
            font-size: 16px;
            font-weight: 700;
            color: var(--accent);
            font-family: 'JetBrains Mono', monospace;
            min-width: 40px;
        }

        .sound-info-mini {
            flex: 1;
        }

        .sound-name-mini {
            font-weight: 600;
            font-size: 11px;
        }

        .sound-desc-mini {
            font-size: 10px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .pattern-search {
            width: 100%;
            padding: 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .pattern-search:focus {
            outline: none;
            border-color: var(--accent);
        }

        .genre-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-bottom: 10px;
        }

        .genre-tag {
            padding: 5px 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 10px;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .genre-tag.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .pattern-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .pattern-list .pattern-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 4px;
            cursor: pointer;
        }

        .pattern-list .pattern-item.active {
            background: rgba(249, 115, 22, 0.1);
            border-color: var(--accent);
        }

        .pattern-list .pattern-name {
            font-weight: 600;
            font-size: 12px;
        }

        .pattern-list .pattern-meta {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        /* Desktop sequencer grid */
        .track {
            display: grid;
            grid-template-columns: 80px repeat(16, 1fr);
            gap: 3px;
            align-items: center;
            margin-bottom: 4px;
        }

        .track:last-child {
            margin-bottom: 0;
        }

        .track-label {
            font-size: 10px;
            text-transform: uppercase;
            color: var(--text-muted);
            display: flex;
            flex-direction: column;
            gap: 1px;
        }

        .track-name {
            font-weight: 600;
            color: var(--text-secondary);
        }

        .track-phonetic {
            font-size: 13px;
            font-weight: 700;
            color: var(--accent);
            font-family: 'JetBrains Mono', monospace;
        }

        .step {
            aspect-ratio: 1;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
            min-width: 28px;
        }

        .step:hover {
            border-color: var(--accent);
        }

        .step.active {
            background: var(--accent);
            border-color: var(--accent);
        }

        .step.playing {
            box-shadow: 0 0 0 2px var(--accent-glow);
            transform: scale(1.05);
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-light);
            border-radius: 3px;
        }
    </style>
</head>

<body>
    <div class="header">
        <div>
                        <div class="logo">YEN's <span>Beatbox</span></div>
            <div class="subtitle">Learn to Beatbox</div>
        </div>
        <div style="display: flex; align-items: center;">
            <div class="mode-tabs">
                <button class="mode-tab active" data-mode="training">Train</button>
                <button class="mode-tab" data-mode="patterns">Patterns</button>
                <button class="mode-tab" data-mode="guru">AI</button>
            </div>
            <div class="status-indicator" id="statusIndicator"></div>
        </div>
    </div>

    <div class="main-grid">
        <div class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title">Beginner<span class="difficulty-badge beginner">Start</span></div>
                <div id="beginnerSounds"></div>
            </div>
            <div class="sidebar-section">
                <div class="sidebar-title">Intermediate<span class="difficulty-badge intermediate">Level Up</span></div>
                <div id="intermediateSounds"></div>
            </div>
            <div class="sidebar-section">
                <div class="sidebar-title">Advanced<span class="difficulty-badge advanced">Pro</span></div>
                <div id="advancedSounds"></div>
            </div>
            <div class="sidebar-section" id="patternSidebar">
                <div class="sidebar-title">Patterns</div>
                <input type="text" class="pattern-search" id="patternSearch" placeholder="Search..." />
                <div class="genre-filters" id="genreFilters"></div>
                <div class="pattern-list" id="patternList"></div>
            </div>
        </div>

        <div class="main-content">
            <!-- TRAINING SECTION -->
            <div class="content-section active" id="trainingSection">
                <div class="phase-nav">
                    <button class="phase-btn active" data-phase="1">Phase 1: Isolation</button>
                    <button class="phase-btn" data-phase="2">Phase 2: Combos</button>
                    <button class="phase-btn" data-phase="3">Phase 3: Triplets</button>
                </div>

                <!-- Phase 1 -->
                <div class="phase-content active" id="phase1">
                    <div class="phase-header">
                        <div class="phase-title">Sound Isolation</div>
                        <div class="phase-desc">One sound, every beat. Master each before combining.</div>
                    </div>
                    <div class="selector-grid" id="phase1Sounds"></div>
                    <div class="drill-card" id="drillCard" style="display: none;">
                        <div class="drill-display">
                            <div class="drill-phonetic" id="drillPhonetic">{ t }</div>
                            <div class="drill-name" id="drillName">Hi-Hat</div>
                        </div>
                        <div class="drill-instruction">
                            <div class="drill-instruction-title">Technique</div>
                            <div class="drill-instruction-text" id="drillInstruction"></div>
                            <div class="drill-steps" id="drillSteps"></div>
                        </div>
                        <a class="youtube-link" id="youtubeLink" href="#" target="_blank" style="display: none;">▶ Watch
                            Tutorial</a>
                        <div class="beat-indicator" id="beatIndicator">
                            <div class="beat-dot"></div>
                            <div class="beat-dot"></div>
                            <div class="beat-dot"></div>
                            <div class="beat-dot"></div>
                        </div>
                        <div class="drill-timer">
                            <div class="timer-display" id="timerDisplay">1:00</div>
                            <div class="timer-label">Remaining (optional)</div>
                        </div>
                        <div class="drill-controls">
                            <button class="btn primary" id="startDrillBtn" onclick="startDrill()">▶ Start Drill</button>
                            <button class="btn" id="stopDrillBtn" onclick="stopDrill()" style="display: none;">■
                                Stop</button>
                        </div>
                        <div class="btn-row">
                            <button class="btn" onclick="markComplete()">✓ Complete</button>
                        </div>
                        <div class="tempo-control">
                            <button class="tempo-btn" onclick="adjustTempo('drill', -5)">−</button>
                            <div class="tempo-display">
                                <div class="tempo-value" id="drillTempoValue">60</div>
                                <div class="tempo-label">BPM</div>
                            </div>
                            <button class="tempo-btn" onclick="adjustTempo('drill', 5)">+</button>
                        </div>
                        <div class="drill-stats">
                            <div class="stat-card">
                                <div class="stat-value" id="statBeats">0</div>
                                <div class="stat-label">Beats</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="statAccuracy">—</div>
                                <div class="stat-label">Accuracy</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="statStreak">0</div>
                                <div class="stat-label">Streak</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Phase 2 -->
                <div class="phase-content" id="phase2" style="display: none;">
                    <div class="phase-header">
                        <div class="phase-title">Two-Sound Combos</div>
                        <div class="phase-desc">Practice transitions until automatic.</div>
                    </div>
                    <div class="selector-grid" id="phase2Combos"></div>
                    <div class="drill-card" id="comboCard" style="display: none;">
                        <div class="combo-display">
                            <div class="combo-phonetic" id="comboSound1">B</div>
                            <div class="combo-arrow">→</div>
                            <div class="combo-phonetic" id="comboSound2">t</div>
                        </div>
                        <div class="beat-indicator" id="comboBeatIndicator">
                            <div class="beat-dot"></div>
                            <div class="beat-dot"></div>
                            <div class="beat-dot"></div>
                            <div class="beat-dot"></div>
                            <div class="beat-dot"></div>
                            <div class="beat-dot"></div>
                            <div class="beat-dot"></div>
                            <div class="beat-dot"></div>
                        </div>
                        <div class="drill-timer">
                            <div class="timer-display" id="comboTimerDisplay">1:00</div>
                            <div class="timer-label">Remaining (optional)</div>
                        </div>
                        <div class="drill-controls">
                            <button class="btn primary" id="startComboBtn" onclick="startComboDrill()">▶ Start
                                Drill</button>
                            <button class="btn" id="stopComboBtn" onclick="stopComboDrill()" style="display: none;">■
                                Stop</button>
                        </div>
                        <div class="btn-row">
                            <button class="btn" onclick="markComboComplete()">✓ Complete</button>
                        </div>
                        <div class="tempo-control">
                            <button class="tempo-btn" onclick="adjustTempo('combo', -5)">−</button>
                            <div class="tempo-display">
                                <div class="tempo-value" id="comboTempoValue">60</div>
                                <div class="tempo-label">BPM</div>
                            </div>
                            <button class="tempo-btn" onclick="adjustTempo('combo', 5)">+</button>
                        </div>
                        <div class="drill-stats">
                            <div class="stat-card">
                                <div class="stat-value" id="comboStatBeats">0</div>
                                <div class="stat-label">Cycles</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="comboStatAccuracy">—</div>
                                <div class="stat-label">Accuracy</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="comboStatStreak">0</div>
                                <div class="stat-label">Streak</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Phase 3 -->
                <div class="phase-content" id="phase3" style="display: none;">
                    <div class="phase-header">
                        <div class="phase-title">Three-Sound Triplets</div>
                        <div class="phase-desc">"Boots and cats" = B-t-K. Foundation of all beats.</div>
                    </div>
                    <div class="selector-grid" id="phase3Triplets"></div>
                    <div class="drill-card" id="tripletCard" style="display: none;">
                        <div class="triplet-display">
                            <div class="triplet-phonetic" id="tripletSound1">B</div>
                            <div class="combo-arrow">→</div>
                            <div class="triplet-phonetic" id="tripletSound2">t</div>
                            <div class="combo-arrow">→</div>
                            <div class="triplet-phonetic" id="tripletSound3">K</div>
                        </div>
                        <div class="beat-indicator" id="tripletBeatIndicator">
                            <div class="beat-dot"></div>
                            <div class="beat-dot"></div>
                            <div class="beat-dot"></div>
                            <div class="beat-dot"></div>
                            <div class="beat-dot"></div>
                            <div class="beat-dot"></div>
                        </div>
                        <div class="drill-timer">
                            <div class="timer-display" id="tripletTimerDisplay">1:00</div>
                            <div class="timer-label">Remaining (optional)</div>
                        </div>
                        <div class="drill-controls">
                            <button class="btn primary" id="startTripletBtn" onclick="startTripletDrill()">▶ Start
                                Drill</button>
                            <button class="btn" id="stopTripletBtn" onclick="stopTripletDrill()"
                                style="display: none;">■ Stop</button>
                        </div>
                        <div class="btn-row">
                            <button class="btn" onclick="markTripletComplete()">✓ Complete</button>
                        </div>
                        <div class="tempo-control">
                            <button class="tempo-btn" onclick="adjustTempo('triplet', -5)">−</button>
                            <div class="tempo-display">
                                <div class="tempo-value" id="tripletTempoValue">50</div>
                                <div class="tempo-label">BPM</div>
                            </div>
                            <button class="tempo-btn" onclick="adjustTempo('triplet', 5)">+</button>
                        </div>
                        <div class="drill-stats">
                            <div class="stat-card">
                                <div class="stat-value" id="tripletStatBeats">0</div>
                                <div class="stat-label">Cycles</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="tripletStatAccuracy">—</div>
                                <div class="stat-label">Accuracy</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="tripletStatStreak">0</div>
                                <div class="stat-label">Streak</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PATTERNS SECTION -->
            <div class="content-section" id="patternsSection">
                <div class="transport">
                    <div class="transport-controls">
                        <button class="btn primary" id="playBtn">▶ Play</button>
                        <button class="btn" id="stopBtn">■ Stop</button>
                    </div>
                    <div class="tempo-control">
                        <button class="tempo-btn" onclick="adjustTempo('seq', -5)">−</button>
                        <div class="tempo-display">
                            <div class="tempo-value" id="seqTempoValue">90</div>
                            <div class="tempo-label">BPM</div>
                        </div>
                        <button class="tempo-btn" onclick="adjustTempo('seq', 5)">+</button>
                    </div>
                </div>
                <div class="pattern-info">
                    <div class="pattern-title" id="patternTitle">Select a Pattern</div>
                    <div class="pattern-description" id="patternDescription">Choose a pattern below to practice</div>
                </div>
                <div class="phonetic-guide">
                    <div class="phonetic-text" id="phoneticGuide">B - t - K - t</div>
                    <div class="phonetic-help">Speak this rhythm slowly, then speed up</div>
                </div>
                <div class="sequencer" id="sequencer">
                    <div class="sequencer-mobile-msg">
                        <strong>Pattern Sequencer</strong><br><br>
                        For the full 16-step grid, use a larger screen.<br><br>
                        On mobile, select patterns below and focus on the phonetic guide above.
                    </div>
                    <div class="sequencer-grid">
                        <div class="track" data-instrument="kick">
                            <div class="track-label"><span class="track-name">Kick</span><span class="track-phonetic">{
                                    B }</span></div>
                        </div>
                        <div class="track" data-instrument="snare">
                            <div class="track-label"><span class="track-name">Snare</span><span class="track-phonetic">{
                                    K }</span></div>
                        </div>
                        <div class="track" data-instrument="hihat">
                            <div class="track-label"><span class="track-name">HiHat</span><span class="track-phonetic">{
                                    t }</span></div>
                        </div>
                        <div class="track" data-instrument="openhat">
                            <div class="track-label"><span class="track-name">Open</span><span class="track-phonetic">{
                                    ts }</span></div>
                        </div>
                    </div>
                </div>
                <div class="pattern-list-mobile" id="patternListMobile"></div>
            </div>

            <!-- AI GURU SECTION -->
            <div class="content-section" id="guruSection">
                <div class="guru-header">
                    <div class="guru-title">Beatbox Guru</div>
                    <div class="guru-desc">AI instructor powered by Gemini</div>
                </div>
                <input type="password" class="api-key-input" id="geminiApiKey" placeholder="Paste Gemini API key" />
                <div class="guru-suggestions">
                    <button class="guru-suggestion" onclick="sendGuruMessage('How do I do a lip roll?')">Lip
                        roll?</button>
                    <button class="guru-suggestion" onclick="sendGuruMessage('Explain inward K snare')">Inward
                        K?</button>
                    <button class="guru-suggestion" onclick="sendGuruMessage('What is circular breathing?')">Circular
                        breathing?</button>
                    <button class="guru-suggestion" onclick="sendGuruMessage('5-minute practice routine')">5-min
                        routine</button>
                </div>
                <div class="chat-container">
                    <div class="chat-messages" id="chatMessages">
                        <div class="chat-message assistant">Hello! I'm the Beatbox Guru. Ask me anything about vocal
                            percussion.</div>
                    </div>
                    <div class="chat-input-container">
                        <input type="text" class="chat-input" id="chatInput" placeholder="Ask about technique..."
                            onkeypress="if(event.key==='Enter')sendGuruMessage()" />
                        <button class="chat-send" onclick="sendGuruMessage()">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="status-message" id="statusMessage"></div>

    <script>
        // ===== DATA =====
        const STEPS = 16, instruments = ['kick', 'snare', 'hihat', 'openhat'], DRILL_DURATION = 60;
        const tempos = { drill: 60, combo: 60, triplet: 50, seq: 90 };

        const soundData = {
            // === BEGINNER SOUNDS (Master these first!) ===
            kick: { id: 'kick', phonetic: '{ B }', name: 'Kick Drum', difficulty: 'beginner', order: 1, instruction: 'The foundation of every beat. Say "Buh" but remove the vowel—just a punchy "B" burst from your lips.', steps: ['Close lips tightly together', 'Build air pressure behind your lips', 'Release in one explosive burst', 'Lips should vibrate slightly (like a small explosion)', 'Practice: B...B...B...B (one per second)'], youtubeUrl: 'https://www.youtube.com/watch?v=GNXYI10Po6I', youtubeTitle: 'TylaDubya - Kick Drum Tutorial (145K views)' },
            hihat: { id: 'hihat', phonetic: '{ t }', name: 'Closed Hi-Hat', difficulty: 'beginner', order: 2, instruction: 'Quick, crisp "T" sound. Say "Tuh" and remove the vowel—just the consonant click.', steps: ['Place tongue tip behind upper front teeth', 'Build slight pressure', 'Quick, sharp "t" release', 'Keep it SHORT and crisp (not "tss")', 'Practice: t...t...t...t (quick and dry)'], youtubeUrl: 'https://www.youtube.com/watch?v=v5lqCrHQrxQ', youtubeTitle: 'TylaDubya - Basics Part 1 (313K views)' },
            snare: { id: 'snare', phonetic: '{ K }', name: 'K-Snare (Outward)', difficulty: 'beginner', order: 3, instruction: 'Sharp crack from the back of your throat. Say "Kuh" and remove the vowel—just the "K" click.', steps: ['Back of tongue against soft palate', 'Build pressure behind the seal', 'Release sharply with a loud click', 'Should sound like a crack, not breathy', 'Practice: K...K...K...K (loud and sharp)'], youtubeUrl: 'https://www.youtube.com/watch?v=Yy7dVHlXoOY', youtubeTitle: '80Fitz - Outward K Snare Tutorial' },
            openhat: { id: 'openhat', phonetic: '{ ts }', name: 'Open Hi-Hat', difficulty: 'beginner', order: 4, instruction: 'Start with closed hi-hat { t }, then extend into a "sss" sound. Think "TSS" like a cymbal sustain.', steps: ['Start with { t } tongue position', 'Immediately extend into sustained "sss"', 'Control the duration (short = tss, long = tsssss)', 'Add this after mastering closed hi-hat'], youtubeUrl: 'https://www.youtube.com/watch?v=v5lqCrHQrxQ', youtubeTitle: 'TylaDubya - Basics Part 1 (313K views)' },
            // === INTERMEDIATE SOUNDS (After you can do B-t-K patterns) ===
            pfsnare: { id: 'pfsnare', phonetic: '{ Pf }', name: 'PF-Snare', difficulty: 'intermediate', order: 5, instruction: 'Heavy, punchy snare. Say "Poof" but remove the "oo"—P flows directly into F with no gap.', steps: ['Press lips together for "P"', 'Build up air pressure', 'Release P and immediately transition to F', 'Upper teeth touch lower lip for the F', 'Should feel like one explosive sound: "Pf!"'], youtubeUrl: 'https://www.youtube.com/watch?v=8lmYtzfN0q8', youtubeTitle: 'TylaDubya - PF Snare Tutorial' },
            inwardk: { id: 'inwardk', phonetic: '{ ^K }', name: 'Inward K-Snare', difficulty: 'intermediate', order: 6, instruction: 'Game-changer! Allows breathing WHILE beatboxing. Make a K sound while INHALING.', steps: ['Tongue in same position as outward K', 'Seal tongue sides against palate', 'Try to inhale sharply', 'The suction creates the snap', 'This lets you breathe during long patterns!'], youtubeUrl: 'https://www.youtube.com/watch?v=kVm5kuZ7e2w', youtubeTitle: 'SkilleR - Inward K Snare/Rimshot Tutorial' },
            // === ADVANCED SOUNDS ===
            kick808: { id: 'kick808', phonetic: '{ U }', name: '808 Kick / Throat Bass', difficulty: 'advanced', order: 7, instruction: 'Deep sub-bass from your throat. Close your epiglottis (like holding your breath) and hum.', steps: ['Close your epiglottis (hold breath feeling)', 'Keep it closed', 'Try to vocalize/hum while its shut', 'You\'ll feel vibration in your throat', 'Works best with a microphone on your neck'], youtubeUrl: 'https://www.youtube.com/watch?v=61P_Jp1rGyI', youtubeTitle: 'Throat Bass / 808 Tutorial' }
        };

        const comboData = {
            'kick-hihat': { sounds: ['kick', 'hihat'], display: ['B', 't'], name: 'Kick → Hat' },
            'hihat-snare': { sounds: ['hihat', 'snare'], display: ['t', 'K'], name: 'Hat → Snare' },
            'kick-snare': { sounds: ['kick', 'snare'], display: ['B', 'K'], name: 'Kick → Snare' },
            'kick-pfsnare': { sounds: ['kick', 'pfsnare'], display: ['B', 'Pf'], name: 'Kick → PF' },
            'hihat-pfsnare': { sounds: ['hihat', 'pfsnare'], display: ['t', 'Pf'], name: 'Hat → PF' },
            'kick-openhat': { sounds: ['kick', 'openhat'], display: ['B', 'ts'], name: 'Kick → Open' }
        };

        const tripletData = {
            // === CLASSIC "BOOTS AND CATS" (Start here!) ===
            'boots-cats': { sounds: ['kick', 'hihat', 'snare'], display: ['B', 't', 'K'], name: 'Boots & Cats', desc: 'THE classic pattern. Say "Boots and Cats" fast!' },
            // === ESSENTIAL VARIATIONS ===
            'boots-cats-boots': { sounds: ['kick', 'hihat', 'snare', 'hihat'], display: ['B', 't', 'K', 't'], name: 'B-t-K-t (Full)', desc: '4-beat foundation. Most common beat structure.' },
            'kick-hat-pf': { sounds: ['kick', 'hihat', 'pfsnare'], display: ['B', 't', 'Pf'], name: 'Kick-Hat-PF', desc: 'Punchier snare variation. Hip-hop feel.' },
            'kick-snare-hat': { sounds: ['kick', 'snare', 'hihat'], display: ['B', 'K', 't'], name: 'Kick-Snare-Hat', desc: 'Snare on beat 2. Different groove feel.' },
            'hat-kick-snare': { sounds: ['hihat', 'kick', 'snare'], display: ['t', 'B', 'K'], name: 'Hat-Kick-Snare', desc: 'Off-beat start. Syncopated feel.' },
            // === DOUBLE PATTERNS ===
            'double-kick-snare': { sounds: ['kick', 'kick', 'snare'], display: ['B', 'B', 'K'], name: 'Double Kick', desc: 'Two kicks before snare. Hip-hop staple.' },
            'kick-double-hat': { sounds: ['kick', 'hihat', 'hihat'], display: ['B', 't', 't'], name: 'Kick-Double Hat', desc: 'Kick then two quick hats. Great for fills.' },
            // === INTERMEDIATE PATTERNS ===
            'boom-bap-core': { sounds: ['kick', 'hihat', 'hihat', 'snare'], display: ['B', 't', 't', 'K'], name: 'Boom Bap Core', desc: 'Classic hip-hop triplet. 90s golden era.' }
        };

        const patternLibrary = [
            { name: "Boots and Cats", genre: "Beginner", tempo: 60, description: "THE beginner pattern. Start at 60 BPM.", phonetic: "B - t - K - t", pattern: { kick: [1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0], snare: [0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0], hihat: [0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0], openhat: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0] } },
            { name: "Simple Backbeat", genre: "Beginner", tempo: 70, description: "Just kick and snare. No hi-hat.", phonetic: "B - - - K - - -", pattern: { kick: [1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0], snare: [0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0], hihat: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], openhat: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0] } },
            { name: "Hi-Hat Fill", genre: "Beginner", tempo: 70, description: "Kick → 3 hats → Snare → 3 hats", phonetic: "B t t t K t t t", pattern: { kick: [1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0], snare: [0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0], hihat: [0, 1, 1, 1, 0, 1, 1, 1, 0, 1, 1, 1, 0, 1, 1, 1], openhat: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0] } },
            { name: "Basic Rock", genre: "Rock", tempo: 90, description: "Classic 4/4 rock beat.", phonetic: "B-t-K-t-B-t-K-t", pattern: { kick: [1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0], snare: [0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0], hihat: [1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0], openhat: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0] } },
            { name: "Boom Bap", genre: "Hip-Hop", tempo: 90, description: "Classic hip-hop foundation.", phonetic: "B-t-t-K-B-B-t-K", pattern: { kick: [1, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0], snare: [0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0], hihat: [0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0], openhat: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0] } },
            { name: "Four-on-Floor", genre: "House", tempo: 120, description: "Kick on every beat.", phonetic: "B-t-B-t-B-t-B-ts", pattern: { kick: [1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0], snare: [0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0], hihat: [0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0], openhat: [0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1] } },
            { name: "Trap", genre: "Hip-Hop", tempo: 140, description: "Rapid hi-hats. Advanced.", phonetic: "B-tttt-K-tttt", pattern: { kick: [1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 0], snare: [0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0], hihat: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1], openhat: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0] } }
        ];

        // ===== STATE =====
        let audioContext, isPlaying = false, currentStep = 0, intervalId = null, currentPattern = null, activeGenre = 'All';
        let drillState = { isRunning: false, intervalId: null, timerIntervalId: null, currentBeat: 0, beatsHit: 0, bestStreak: 0, currentStreak: 0, timeRemaining: DRILL_DURATION, currentSound: null };
        let comboState = { isRunning: false, intervalId: null, timerIntervalId: null, currentBeat: 0, cycles: 0, bestStreak: 0, currentStreak: 0, timeRemaining: DRILL_DURATION, currentCombo: null };
        let tripletState = { isRunning: false, intervalId: null, timerIntervalId: null, currentBeat: 0, cycles: 0, bestStreak: 0, currentStreak: 0, timeRemaining: DRILL_DURATION, currentTriplet: null };
        let completedSounds = new Set(), completedCombos = new Set(), completedTriplets = new Set();

        // ===== TEMPO CONTROL =====
        function adjustTempo(type, delta) {
            tempos[type] = Math.max(40, Math.min(180, tempos[type] + delta));
            document.getElementById(type + 'TempoValue').textContent = tempos[type];
            if (type === 'seq' && isPlaying) { stop(); play(); }
            if (type === 'drill' && drillState.isRunning) { stopDrill(); startDrill(); }
            if (type === 'combo' && comboState.isRunning) { stopComboDrill(); startComboDrill(); }
            if (type === 'triplet' && tripletState.isRunning) { stopTripletDrill(); startTripletDrill(); }
        }

        // ===== AUDIO =====
        function initAudio() { if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)(); }

        function playSound(inst) {
            initAudio();
            const now = audioContext.currentTime;
            if (inst === 'kick') {
                const osc = audioContext.createOscillator(), gain = audioContext.createGain();
                osc.connect(gain); gain.connect(audioContext.destination);
                osc.frequency.setValueAtTime(150, now); osc.frequency.exponentialRampToValueAtTime(0.01, now + 0.5);
                gain.gain.setValueAtTime(1, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                osc.start(now); osc.stop(now + 0.5);
            } else if (inst === 'snare' || inst === 'pfsnare') {
                const noise = audioContext.createBufferSource(), buf = audioContext.createBuffer(1, audioContext.sampleRate * 0.2, audioContext.sampleRate);
                const data = buf.getChannelData(0); for (let i = 0; i < buf.length; i++) data[i] = Math.random() * 2 - 1;
                noise.buffer = buf;
                const filter = audioContext.createBiquadFilter(); filter.type = 'highpass'; filter.frequency.value = 1000;
                const gain = audioContext.createGain();
                noise.connect(filter); filter.connect(gain); gain.connect(audioContext.destination);
                gain.gain.setValueAtTime(0.4, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                const osc = audioContext.createOscillator(), oscGain = audioContext.createGain();
                osc.connect(oscGain); oscGain.connect(audioContext.destination);
                osc.frequency.setValueAtTime(200, now); osc.frequency.exponentialRampToValueAtTime(100, now + 0.1);
                oscGain.gain.setValueAtTime(0.3, now); oscGain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                osc.start(now); osc.stop(now + 0.2); noise.start(now); noise.stop(now + 0.2);
            } else if (inst === 'hihat') {
                const noise = audioContext.createBufferSource(), buf = audioContext.createBuffer(1, audioContext.sampleRate * 0.05, audioContext.sampleRate);
                const data = buf.getChannelData(0); for (let i = 0; i < buf.length; i++) data[i] = Math.random() * 2 - 1;
                noise.buffer = buf;
                const hp = audioContext.createBiquadFilter(); hp.type = 'highpass'; hp.frequency.value = 8000;
                const bp = audioContext.createBiquadFilter(); bp.type = 'bandpass'; bp.frequency.value = 12000; bp.Q.value = 2;
                const gain = audioContext.createGain();
                noise.connect(hp); hp.connect(bp); bp.connect(gain); gain.connect(audioContext.destination);
                gain.gain.setValueAtTime(0.5, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
                noise.start(now); noise.stop(now + 0.05);
            } else if (inst === 'openhat') {
                const noise = audioContext.createBufferSource(), buf = audioContext.createBuffer(1, audioContext.sampleRate * 0.5, audioContext.sampleRate);
                const data = buf.getChannelData(0); for (let i = 0; i < buf.length; i++) data[i] = Math.random() * 2 - 1;
                noise.buffer = buf;
                const hp = audioContext.createBiquadFilter(); hp.type = 'highpass'; hp.frequency.value = 5000;
                const gain = audioContext.createGain();
                noise.connect(hp); hp.connect(gain); gain.connect(audioContext.destination);
                gain.gain.setValueAtTime(0, now); gain.gain.linearRampToValueAtTime(0.35, now + 0.01);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                noise.start(now); noise.stop(now + 0.5);
            } else if (inst === 'inwardk' || inst === 'kick808') {
                playSound('snare'); // fallback
            }
        }

        // ===== UI SETUP =====
        function init() {
            buildSidebar();
            buildPhase1();
            buildPhase2();
            buildPhase3();
            buildPatternList();
            buildSequencer();
            setupEventListeners();
            loadPattern(patternLibrary[0]);
            loadApiKey(); // Load saved API key from localStorage
        }

        function loadApiKey() {
            const savedKey = localStorage.getItem('beatbox_gemini_api_key');
            if (savedKey) {
                document.getElementById('geminiApiKey').value = savedKey;
            }
        }

        function buildSidebar() {
            const beg = document.getElementById('beginnerSounds');
            const int = document.getElementById('intermediateSounds');
            const adv = document.getElementById('advancedSounds');
            Object.values(soundData).forEach(s => {
                const html = `<div class="sound-card-mini" onclick="playSound('${s.id}')"><div class="sound-phonetic-mini">${s.phonetic}</div><div class="sound-info-mini"><div class="sound-name-mini">${s.name}</div></div></div>`;
                if (s.difficulty === 'beginner') beg.innerHTML += html;
                else if (s.difficulty === 'intermediate') int.innerHTML += html;
                else adv.innerHTML += html;
            });
        }

        function buildPhase1() {
            const grid = document.getElementById('phase1Sounds');
            Object.values(soundData).forEach(s => {
                grid.innerHTML += `<div class="selector-card" data-sound="${s.id}" onclick="selectSound('${s.id}')"><div class="selector-phonetic">${s.phonetic}</div><div class="selector-name">${s.name}</div></div>`;
            });
        }

        function buildPhase2() {
            const grid = document.getElementById('phase2Combos');
            Object.entries(comboData).forEach(([id, c]) => {
                grid.innerHTML += `<div class="selector-card" data-combo="${id}" onclick="selectCombo('${id}')"><div class="selector-phonetic">${c.display.join(' ')}</div><div class="selector-name">${c.name}</div></div>`;
            });
        }

        function buildPhase3() {
            const grid = document.getElementById('phase3Triplets');
            Object.entries(tripletData).forEach(([id, t]) => {
                grid.innerHTML += `<div class="selector-card" data-triplet="${id}" onclick="selectTriplet('${id}')"><div class="selector-phonetic">${t.display.join(' ')}</div><div class="selector-name">${t.name}</div></div>`;
            });
        }

        function buildPatternList() {
            const genres = ['All', ...new Set(patternLibrary.map(p => p.genre))];
            const filters = document.getElementById('genreFilters');
            genres.forEach(g => {
                filters.innerHTML += `<button class="genre-tag ${g === 'All' ? 'active' : ''}" onclick="filterGenre('${g}')">${g}</button>`;
            });
            renderPatterns();
        }

        function filterGenre(g) {
            activeGenre = g;
            document.querySelectorAll('.genre-tag').forEach(t => t.classList.toggle('active', t.textContent === g));
            renderPatterns();
        }

        function renderPatterns() {
            const list = document.getElementById('patternList');
            const listMobile = document.getElementById('patternListMobile');
            const filtered = patternLibrary.filter(p => activeGenre === 'All' || p.genre === activeGenre);
            const html = filtered.map((p, i) => `<div class="pattern-item ${currentPattern?.name === p.name ? 'active' : ''}" onclick="loadPattern(patternLibrary[${patternLibrary.indexOf(p)}])"><div><div class="pattern-name">${p.name}</div><div class="pattern-meta">${p.genre} • ${p.tempo} BPM</div></div><div class="pattern-phonetic">${p.phonetic}</div></div>`).join('');
            list.innerHTML = html;
            listMobile.innerHTML = html;
        }

        function buildSequencer() {
            document.querySelectorAll('.sequencer-grid .track').forEach(track => {
                const inst = track.dataset.instrument;
                for (let i = 0; i < STEPS; i++) {
                    const step = document.createElement('div');
                    step.className = 'step';
                    step.dataset.instrument = inst;
                    step.dataset.step = i;
                    step.onclick = () => toggleStep(inst, i, step);
                    track.appendChild(step);
                }
            });
        }

        function toggleStep(inst, i, el) {
            if (currentPattern) {
                currentPattern.pattern[inst][i] = currentPattern.pattern[inst][i] ? 0 : 1;
                el.classList.toggle('active');
            }
        }

        function loadPattern(p) {
            currentPattern = p;
            tempos.seq = p.tempo;
            document.getElementById('seqTempoValue').textContent = p.tempo;
            document.getElementById('patternTitle').textContent = p.name;
            document.getElementById('patternDescription').textContent = p.description;
            document.getElementById('phoneticGuide').textContent = p.phonetic;
            instruments.forEach(inst => {
                p.pattern[inst].forEach((v, i) => {
                    const el = document.querySelector(`.sequencer-grid [data-instrument="${inst}"][data-step="${i}"]`);
                    if (el) el.classList.toggle('active', v === 1);
                });
            });
            renderPatterns();
            showStatus('Loaded: ' + p.name, 'success');
        }

        function setupEventListeners() {
            document.querySelectorAll('.mode-tab').forEach(tab => {
                tab.onclick = () => {
                    // STOP ALL SOUNDS when switching modes
                    stopAllSounds();
                    document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
                    document.getElementById(tab.dataset.mode === 'training' ? 'trainingSection' : tab.dataset.mode === 'patterns' ? 'patternsSection' : 'guruSection').classList.add('active');
                };
            });
            document.querySelectorAll('.phase-btn').forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll('.phase-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    document.querySelectorAll('.phase-content').forEach(p => p.style.display = 'none');
                    document.getElementById('phase' + btn.dataset.phase).style.display = 'block';
                };
            });
            document.getElementById('playBtn').onclick = play;
            document.getElementById('stopBtn').onclick = stop;
            document.getElementById('patternSearch').oninput = e => {
                const q = e.target.value.toLowerCase();
                document.querySelectorAll('.pattern-list .pattern-item, .pattern-list-mobile .pattern-item').forEach(item => {
                    item.style.display = item.textContent.toLowerCase().includes(q) ? '' : 'none';
                });
            };
        }


        // ===== PHASE 1: ISOLATION DRILLS =====
        function selectSound(id) {
            drillState.currentSound = id;
            document.querySelectorAll('#phase1Sounds .selector-card').forEach(c => c.classList.remove('selected'));
            document.querySelector(`[data-sound="${id}"]`).classList.add('selected');
            const s = soundData[id];
            document.getElementById('drillCard').style.display = 'block';
            document.getElementById('drillPhonetic').textContent = s.phonetic;
            document.getElementById('drillName').textContent = s.name;
            document.getElementById('drillInstruction').textContent = s.instruction;
            document.getElementById('drillSteps').innerHTML = s.steps.map((st, i) => `<div class="drill-step"><div class="drill-step-num">${i + 1}</div><span>${st}</span></div>`).join('');
            const yt = document.getElementById('youtubeLink');
            yt.href = s.youtubeUrl; yt.style.display = 'flex';
            resetDrillState();
        }

        function resetDrillState() {
            drillState.beatsHit = 0; drillState.bestStreak = 0; drillState.currentStreak = 0;
            drillState.timeRemaining = DRILL_DURATION; drillState.currentBeat = 0;
            document.getElementById('timerDisplay').textContent = formatTime(DRILL_DURATION);
            document.getElementById('statBeats').textContent = '0';
            document.getElementById('statAccuracy').textContent = '—';
            document.getElementById('statStreak').textContent = '0';
            document.querySelectorAll('#beatIndicator .beat-dot').forEach(d => d.classList.remove('active'));
        }

        function startDrill() {
            initAudio();
            drillState.isRunning = true;
            document.getElementById('startDrillBtn').style.display = 'none';
            document.getElementById('stopDrillBtn').style.display = 'flex';
            document.getElementById('statusIndicator').classList.add('active');
            const interval = (60 / tempos.drill) * 1000;
            drillState.intervalId = setInterval(advanceDrillBeat, interval);
            drillState.timerIntervalId = setInterval(() => {
                drillState.timeRemaining--;
                document.getElementById('timerDisplay').textContent = formatTime(drillState.timeRemaining);
                if (drillState.timeRemaining <= 0) completeDrill();
            }, 1000);
            advanceDrillBeat();
        }

        function advanceDrillBeat() {
            const dots = document.querySelectorAll('#beatIndicator .beat-dot');
            dots.forEach(d => d.classList.remove('active'));
            dots[drillState.currentBeat].classList.add('active');
            playSound(drillState.currentSound);
            drillState.beatsHit++; drillState.currentStreak++;
            if (drillState.currentStreak > drillState.bestStreak) drillState.bestStreak = drillState.currentStreak;
            document.getElementById('statBeats').textContent = drillState.beatsHit;
            document.getElementById('statStreak').textContent = drillState.bestStreak;
            drillState.currentBeat = (drillState.currentBeat + 1) % 4;
        }

        function stopDrill() {
            drillState.isRunning = false;
            clearInterval(drillState.intervalId); clearInterval(drillState.timerIntervalId);
            document.getElementById('startDrillBtn').style.display = 'flex';
            document.getElementById('stopDrillBtn').style.display = 'none';
            document.getElementById('statusIndicator').classList.remove('active');
            document.querySelectorAll('#beatIndicator .beat-dot').forEach(d => d.classList.remove('active'));
        }

        function completeDrill() {
            stopDrill();
            completedSounds.add(drillState.currentSound);
            document.querySelector(`[data-sound="${drillState.currentSound}"]`).classList.add('completed');
            const expected = Math.floor(DRILL_DURATION * (tempos.drill / 60));
            document.getElementById('statAccuracy').textContent = Math.min(100, Math.round((drillState.beatsHit / expected) * 100)) + '%';
            showStatus(soundData[drillState.currentSound].name + ' complete!', 'success');
        }

        function markComplete() {
            if (drillState.currentSound) {
                completedSounds.add(drillState.currentSound);
                document.querySelector(`[data-sound="${drillState.currentSound}"]`).classList.add('completed');
                showStatus('Marked complete!', 'success');
            }
        }

        // ===== PHASE 2: COMBO DRILLS =====
        function selectCombo(id) {
            comboState.currentCombo = id;
            document.querySelectorAll('#phase2Combos .selector-card').forEach(c => c.classList.remove('selected'));
            document.querySelector(`[data-combo="${id}"]`).classList.add('selected');
            const c = comboData[id];
            document.getElementById('comboCard').style.display = 'block';
            document.getElementById('comboSound1').textContent = c.display[0];
            document.getElementById('comboSound2').textContent = c.display[1];
            resetComboState();
        }

        function resetComboState() {
            comboState.cycles = 0; comboState.bestStreak = 0; comboState.currentStreak = 0;
            comboState.timeRemaining = DRILL_DURATION; comboState.currentBeat = 0;
            document.getElementById('comboTimerDisplay').textContent = formatTime(DRILL_DURATION);
            document.getElementById('comboStatBeats').textContent = '0';
            document.getElementById('comboStatAccuracy').textContent = '—';
            document.getElementById('comboStatStreak').textContent = '0';
            document.querySelectorAll('#comboBeatIndicator .beat-dot').forEach(d => d.classList.remove('active'));
            document.getElementById('comboSound1').classList.remove('current', 'inactive');
            document.getElementById('comboSound2').classList.remove('current', 'inactive');
        }

        function startComboDrill() {
            initAudio();
            comboState.isRunning = true;
            document.getElementById('startComboBtn').style.display = 'none';
            document.getElementById('stopComboBtn').style.display = 'flex';
            document.getElementById('statusIndicator').classList.add('active');
            const interval = (60 / tempos.combo) * 1000;
            comboState.intervalId = setInterval(advanceComboBeat, interval);
            comboState.timerIntervalId = setInterval(() => {
                comboState.timeRemaining--;
                document.getElementById('comboTimerDisplay').textContent = formatTime(comboState.timeRemaining);
                if (comboState.timeRemaining <= 0) completeComboDrill();
            }, 1000);
            advanceComboBeat();
        }

        function advanceComboBeat() {
            const combo = comboData[comboState.currentCombo];
            const dots = document.querySelectorAll('#comboBeatIndicator .beat-dot');
            dots.forEach(d => d.classList.remove('active'));
            dots[comboState.currentBeat].classList.add('active');
            const soundIdx = comboState.currentBeat % 2;
            playSound(combo.sounds[soundIdx]);
            const s1 = document.getElementById('comboSound1'), s2 = document.getElementById('comboSound2');
            s1.classList.remove('current', 'inactive'); s2.classList.remove('current', 'inactive');
            if (soundIdx === 0) { s1.classList.add('current'); s2.classList.add('inactive'); }
            else { s2.classList.add('current'); s1.classList.add('inactive'); }
            if (comboState.currentBeat % 2 === 1) {
                comboState.cycles++; comboState.currentStreak++;
                if (comboState.currentStreak > comboState.bestStreak) comboState.bestStreak = comboState.currentStreak;
                document.getElementById('comboStatBeats').textContent = comboState.cycles;
                document.getElementById('comboStatStreak').textContent = comboState.bestStreak;
            }
            comboState.currentBeat = (comboState.currentBeat + 1) % 8;
        }

        function stopComboDrill() {
            comboState.isRunning = false;
            clearInterval(comboState.intervalId); clearInterval(comboState.timerIntervalId);
            document.getElementById('startComboBtn').style.display = 'flex';
            document.getElementById('stopComboBtn').style.display = 'none';
            document.getElementById('statusIndicator').classList.remove('active');
            document.querySelectorAll('#comboBeatIndicator .beat-dot').forEach(d => d.classList.remove('active'));
            document.getElementById('comboSound1').classList.remove('current', 'inactive');
            document.getElementById('comboSound2').classList.remove('current', 'inactive');
        }

        function completeComboDrill() {
            stopComboDrill();
            completedCombos.add(comboState.currentCombo);
            document.querySelector(`[data-combo="${comboState.currentCombo}"]`).classList.add('completed');
            showStatus(comboData[comboState.currentCombo].name + ' complete!', 'success');
        }

        function markComboComplete() {
            if (comboState.currentCombo) {
                completedCombos.add(comboState.currentCombo);
                document.querySelector(`[data-combo="${comboState.currentCombo}"]`).classList.add('completed');
                showStatus('Marked complete!', 'success');
            }
        }

        // ===== PHASE 3: TRIPLET DRILLS =====
        function selectTriplet(id) {
            tripletState.currentTriplet = id;
            document.querySelectorAll('#phase3Triplets .selector-card').forEach(c => c.classList.remove('selected'));
            document.querySelector(`[data-triplet="${id}"]`).classList.add('selected');
            const t = tripletData[id];
            document.getElementById('tripletCard').style.display = 'block';
            document.getElementById('tripletSound1').textContent = t.display[0];
            document.getElementById('tripletSound2').textContent = t.display[1];
            document.getElementById('tripletSound3').textContent = t.display[2];
            resetTripletState();
        }

        function resetTripletState() {
            tripletState.cycles = 0; tripletState.bestStreak = 0; tripletState.currentStreak = 0;
            tripletState.timeRemaining = DRILL_DURATION; tripletState.currentBeat = 0;
            document.getElementById('tripletTimerDisplay').textContent = formatTime(DRILL_DURATION);
            document.getElementById('tripletStatBeats').textContent = '0';
            document.getElementById('tripletStatAccuracy').textContent = '—';
            document.getElementById('tripletStatStreak').textContent = '0';
            document.querySelectorAll('#tripletBeatIndicator .beat-dot').forEach(d => d.classList.remove('active'));
        }

        function startTripletDrill() {
            initAudio();
            tripletState.isRunning = true;
            document.getElementById('startTripletBtn').style.display = 'none';
            document.getElementById('stopTripletBtn').style.display = 'flex';
            document.getElementById('statusIndicator').classList.add('active');
            const interval = (60 / tempos.triplet) * 1000;
            tripletState.intervalId = setInterval(advanceTripletBeat, interval);
            tripletState.timerIntervalId = setInterval(() => {
                tripletState.timeRemaining--;
                document.getElementById('tripletTimerDisplay').textContent = formatTime(tripletState.timeRemaining);
                if (tripletState.timeRemaining <= 0) completeTripletDrill();
            }, 1000);
            advanceTripletBeat();
        }

        function advanceTripletBeat() {
            const trip = tripletData[tripletState.currentTriplet];
            const dots = document.querySelectorAll('#tripletBeatIndicator .beat-dot');
            dots.forEach(d => d.classList.remove('active'));
            dots[tripletState.currentBeat].classList.add('active');
            const soundIdx = tripletState.currentBeat % 3;
            playSound(trip.sounds[soundIdx]);
            [1, 2, 3].forEach(n => {
                const el = document.getElementById('tripletSound' + n);
                el.classList.remove('current', 'inactive');
                if (n === soundIdx + 1) el.classList.add('current');
                else el.classList.add('inactive');
            });
            if (tripletState.currentBeat % 3 === 2) {
                tripletState.cycles++; tripletState.currentStreak++;
                if (tripletState.currentStreak > tripletState.bestStreak) tripletState.bestStreak = tripletState.currentStreak;
                document.getElementById('tripletStatBeats').textContent = tripletState.cycles;
                document.getElementById('tripletStatStreak').textContent = tripletState.bestStreak;
            }
            tripletState.currentBeat = (tripletState.currentBeat + 1) % 6;
        }

        function stopTripletDrill() {
            tripletState.isRunning = false;
            clearInterval(tripletState.intervalId); clearInterval(tripletState.timerIntervalId);
            document.getElementById('startTripletBtn').style.display = 'flex';
            document.getElementById('stopTripletBtn').style.display = 'none';
            document.getElementById('statusIndicator').classList.remove('active');
            document.querySelectorAll('#tripletBeatIndicator .beat-dot').forEach(d => d.classList.remove('active'));
        }

        function completeTripletDrill() {
            stopTripletDrill();
            completedTriplets.add(tripletState.currentTriplet);
            document.querySelector(`[data-triplet="${tripletState.currentTriplet}"]`).classList.add('completed');
            showStatus(tripletData[tripletState.currentTriplet].name + ' complete!', 'success');
        }

        function markTripletComplete() {
            if (tripletState.currentTriplet) {
                completedTriplets.add(tripletState.currentTriplet);
                document.querySelector(`[data-triplet="${tripletState.currentTriplet}"]`).classList.add('completed');
                showStatus('Marked complete!', 'success');
            }
        }

        // ===== SEQUENCER =====
        function play() {
            initAudio();
            if (!isPlaying) {
                isPlaying = true;
                document.getElementById('statusIndicator').classList.add('active');
                document.getElementById('playBtn').textContent = '❚❚ Pause';
                const interval = (60 / tempos.seq / 4) * 1000;
                advanceSeq();
                intervalId = setInterval(advanceSeq, interval);
            } else {
                pause();
            }
        }

        function advanceSeq() {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('playing'));
            instruments.forEach(inst => {
                const el = document.querySelector(`.sequencer-grid [data-instrument="${inst}"][data-step="${currentStep}"]`);
                if (el) {
                    el.classList.add('playing');
                    if (currentPattern?.pattern[inst][currentStep]) playSound(inst);
                }
            });
            currentStep = (currentStep + 1) % STEPS;
        }

        function pause() {
            isPlaying = false;
            clearInterval(intervalId);
            document.getElementById('statusIndicator').classList.remove('active');
            document.getElementById('playBtn').textContent = '▶ Play';
        }

        function stop() {
            pause();
            currentStep = 0;
            document.querySelectorAll('.step').forEach(s => s.classList.remove('playing'));
        }

        // ===== STOP ALL SOUNDS (Master stop for mode switching) =====
        function stopAllSounds() {
            // Stop Phase 1 drill
            if (drillState.isRunning) stopDrill();
            // Stop Phase 2 combo drill
            if (comboState.isRunning) stopComboDrill();
            // Stop Phase 3 triplet drill
            if (tripletState.isRunning) stopTripletDrill();
            // Stop sequencer
            if (isPlaying) stop();
        }

        // ===== AI GURU =====
        async function sendGuruMessage(msg) {
            const input = document.getElementById('chatInput');
            const message = msg || input.value.trim();
            if (!message) return;
            const apiKeyInput = document.getElementById('geminiApiKey');
            let apiKey = apiKeyInput.value.trim();

            // Try to load from localStorage if not entered
            if (!apiKey) {
                apiKey = localStorage.getItem('beatbox_gemini_api_key') || '';
                if (apiKey) apiKeyInput.value = apiKey;
            }

            if (!apiKey) {
                showStatus('Enter Gemini API key first', '');
                return;
            }

            // Save API key to localStorage for persistence
            localStorage.setItem('beatbox_gemini_api_key', apiKey);

            input.value = '';
            const chat = document.getElementById('chatMessages');
            chat.innerHTML += `<div class="chat-message user">${message}</div>`;
            chat.innerHTML += `<div class="chat-message assistant" id="typing">Thinking...</div>`;
            chat.scrollTop = chat.scrollHeight;
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `You are an expert beatbox instructor. Be concise and practical. User asks: ${message}` }] }]
                    })
                });
                const data = await res.json();
                const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || 'Sorry, no response.';
                document.getElementById('typing').textContent = reply;
            } catch (e) {
                document.getElementById('typing').textContent = 'Error: ' + e.message;
            }
            chat.scrollTop = chat.scrollHeight;
        }

        // ===== UTILS =====
        function formatTime(s) { return Math.floor(s / 60) + ':' + (s % 60).toString().padStart(2, '0'); }
        function showStatus(msg, type) {
            const el = document.getElementById('statusMessage');
            el.textContent = msg;
            el.className = 'status-message show' + (type === 'success' ? ' success' : '');
            setTimeout(() => el.classList.remove('show'), 3000);
        }

        // ===== INIT =====
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>