<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0A0A0B">
    <title>YEN's Beatbox Trainer</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Instrument+Sans:wght@400;500;600;700&display=swap');
        
        :root {
            --bg-primary: #0A0A0B;
            --bg-secondary: #111113;
            --bg-card: #161618;
            --bg-elevated: #1C1C1F;
            --text-primary: #FAFAFA;
            --text-secondary: #A1A1AA;
            --text-muted: #71717A;
            --accent: #FF6B35;
            --accent-soft: rgba(255, 107, 53, 0.15);
            --accent-glow: rgba(255, 107, 53, 0.4);
            --success: #10B981;
            --border: #27272A;
            --border-light: #3F3F46;
            --touch-min: 48px;
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --safe-left: env(safe-area-inset-left, 0px);
            --safe-right: env(safe-area-inset-right, 0px);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; overflow: hidden; }
        
        body {
            font-family: 'Instrument Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 16px;
            line-height: 1.5;
            padding: var(--safe-top) var(--safe-right) var(--safe-bottom) var(--safe-left);
            touch-action: manipulation;
        }

        .app { display: flex; flex-direction: column; height: 100%; max-width: 600px; margin: 0 auto; }

        /* Header */
        .header {
            flex-shrink: 0;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
        }
        .brand { display: flex; align-items: baseline; gap: 8px; }
        .brand-name { font-size: 20px; font-weight: 700; letter-spacing: -0.02em; }
        .brand-name span { color: var(--accent); }
        .brand-tag { font-size: 11px; font-weight: 500; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.08em; }
        .pulse-dot {
            width: 10px; height: 10px; border-radius: 50%;
            background: var(--border); transition: all 0.3s;
        }
        .pulse-dot.active {
            background: var(--accent);
            box-shadow: 0 0 16px var(--accent-glow);
            animation: pulse-glow 1s ease-in-out infinite;
        }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 16px var(--accent-glow); }
            50% { box-shadow: 0 0 24px var(--accent-glow), 0 0 32px var(--accent-glow); }
        }

        /* Navigation */
        .nav-tabs {
            flex-shrink: 0;
            display: flex;
            padding: 12px 16px;
            gap: 8px;
            overflow-x: auto;
            scrollbar-width: none;
        }
        .nav-tabs::-webkit-scrollbar { display: none; }
        .nav-tab {
            flex-shrink: 0;
            padding: 12px 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            min-height: var(--touch-min);
        }
        .nav-tab:active { transform: scale(0.96); }
        .nav-tab.active { background: var(--accent); color: white; border-color: var(--accent); }

        /* Main content */
        main { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: calc(20px + var(--safe-bottom)); }
        .view { display: none; }
        .view.active { display: block; }

        /* Section headers */
        .section-header { margin-bottom: 16px; }
        .section-title { font-size: 22px; font-weight: 700; letter-spacing: -0.02em; margin-bottom: 4px; }
        .section-desc { font-size: 14px; color: var(--text-secondary); }

        /* =========== SOUND CARDS - TAP TO PLAY =========== */
        .sound-card {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .sound-card:active { transform: scale(0.98); }
        .sound-card.playing {
            border-color: var(--accent);
            box-shadow: 0 0 24px var(--accent-glow);
        }
        .sound-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        .sound-card-phonetic {
            font-family: 'DM Mono', monospace;
            font-size: 32px;
            font-weight: 500;
            color: var(--accent);
        }
        .sound-card-name { font-size: 16px; font-weight: 600; }
        .sound-card-word { font-size: 14px; color: var(--text-secondary); margin-bottom: 8px; }
        .sound-card-desc { font-size: 13px; color: var(--text-muted); line-height: 1.5; }
        .sound-card-link {
            display: inline-block;
            margin-top: 12px;
            color: var(--accent);
            font-size: 14px;
            font-weight: 600;
            text-decoration: none;
        }
        .sound-card-status {
            position: absolute;
            top: 16px;
            right: 16px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            background: var(--bg-elevated);
            padding: 4px 10px;
            border-radius: 6px;
        }
        .sound-card.playing .sound-card-status { color: var(--accent); background: var(--accent-soft); }

        /* Inline BPM control */
        .inline-bpm {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }
        .sound-card.playing .inline-bpm { display: flex; }
        .bpm-btn {
            width: 48px; height: 48px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 24px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .bpm-btn:active { transform: scale(0.9); background: var(--accent); }
        .bpm-display {
            text-align: center;
            min-width: 80px;
        }
        .bpm-value { font-family: 'DM Mono', monospace; font-size: 28px; font-weight: 600; }
        .bpm-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; }

        /* =========== PHRASE/COMBO/TRIPLET CARDS =========== */
        .grid-2col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .tap-card {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            min-height: 120px;
        }
        .tap-card:active { transform: scale(0.97); }
        .tap-card.playing {
            border-color: var(--accent);
            box-shadow: 0 0 20px var(--accent-glow);
        }
        .tap-card-pattern {
            font-family: 'DM Mono', monospace;
            font-size: 20px;
            font-weight: 500;
            color: var(--accent);
            margin-bottom: 8px;
            line-height: 1.3;
        }
        .tap-card-name { font-size: 14px; color: var(--text-secondary); }
        .tap-card-status {
            position: absolute;
            top: 12px;
            right: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            background: var(--bg-elevated);
            padding: 3px 8px;
            border-radius: 4px;
        }
        .tap-card.playing .tap-card-status { color: var(--accent); background: var(--accent-soft); }

        /* Full-width card for drill display */
        .drill-display-card {
            background: var(--bg-card);
            border: 2px solid var(--accent);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
            text-align: center;
            box-shadow: 0 0 30px var(--accent-glow);
        }
        .drill-display-pattern {
            font-family: 'DM Mono', monospace;
            font-size: 36px;
            font-weight: 500;
            color: var(--accent);
            margin-bottom: 8px;
            letter-spacing: 4px;
        }
        .drill-display-pattern .syl { opacity: 0.4; transition: all 0.1s; }
        .drill-display-pattern .syl.current { opacity: 1; transform: scale(1.1); }
        .drill-display-name { font-size: 16px; color: var(--text-secondary); margin-bottom: 16px; }
        .drill-bpm-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
        }
        .drill-tap-hint { font-size: 12px; color: var(--text-muted); margin-top: 12px; }

        /* =========== PATTERN CARDS =========== */
        .pattern-card {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .pattern-card:active { transform: scale(0.98); }
        .pattern-card.playing {
            border-color: var(--accent);
            box-shadow: 0 0 24px var(--accent-glow);
        }
        .pattern-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        .pattern-card-name { font-size: 16px; font-weight: 600; }
        .pattern-card-meta { font-size: 12px; color: var(--text-muted); }
        .pattern-card-phonetic {
            font-family: 'DM Mono', monospace;
            font-size: 14px;
            color: var(--accent);
            margin-bottom: 12px;
        }
        .pattern-card-status {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-muted);
            background: var(--bg-elevated);
            padding: 3px 8px;
            border-radius: 4px;
        }
        .pattern-card.playing .pattern-card-status { color: var(--accent); background: var(--accent-soft); }

        /* Mini pattern grid */
        .mini-grid {
            display: grid;
            grid-template-columns: repeat(16, 1fr);
            gap: 2px;
            margin-bottom: 12px;
        }
        .mini-grid-row { display: contents; }
        .mini-step {
            aspect-ratio: 1;
            background: var(--bg-elevated);
            border-radius: 2px;
        }
        .mini-step.on { background: var(--accent); }
        .mini-step.beat { box-shadow: 0 0 6px var(--accent-glow); }

        /* Pattern inline BPM */
        .pattern-bpm {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }
        .pattern-card.playing .pattern-bpm { display: flex; }

        /* Toast */
        .toast {
            position: fixed;
            bottom: calc(20px + var(--safe-bottom));
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            opacity: 0;
            transition: all 0.3s;
            z-index: 1000;
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.success { border-color: var(--success); color: var(--success); }
    </style>
</head>
<body>
    <div class="app">
        <div class="header">
            <div class="brand">
                <div class="brand-name">YEN's <span>Beatbox</span></div>
                <div class="brand-tag">Trainer</div>
            </div>
            <div class="pulse-dot" id="pulseDot"></div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" data-view="sounds">Sounds</button>
            <button class="nav-tab" data-view="phrases">Phrases</button>
            <button class="nav-tab" data-view="combos">Combos</button>
            <button class="nav-tab" data-view="triplets">Triplets</button>
            <button class="nav-tab" data-view="patterns">Patterns</button>
        </div>

        <main>
            <!-- SOUNDS VIEW -->
            <div class="view active" id="soundsView">
                <div class="section-header">
                    <div class="section-title">Core Sounds</div>
                    <div class="section-desc">Tap card to practice. Tap again to stop.</div>
                </div>
                <div id="soundCards"></div>
            </div>

            <!-- PHRASES VIEW -->
            <div class="view" id="phrasesView">
                <div class="section-header">
                    <div class="section-title">Beatrhyming</div>
                    <div class="section-desc">Tap to start the phrase loop.</div>
                </div>
                <div id="phraseDisplay" style="display: none;"></div>
                <div class="grid-2col" id="phraseGrid"></div>
            </div>

            <!-- COMBOS VIEW -->
            <div class="view" id="combosView">
                <div class="section-header">
                    <div class="section-title">Transitions</div>
                    <div class="section-desc">Two-sound switches. Tap to drill.</div>
                </div>
                <div id="comboDisplay" style="display: none;"></div>
                <div class="grid-2col" id="comboGrid"></div>
            </div>

            <!-- TRIPLETS VIEW -->
            <div class="view" id="tripletsView">
                <div class="section-header">
                    <div class="section-title">Triplets</div>
                    <div class="section-desc">Three sounds, continuous flow.</div>
                </div>
                <div id="tripletDisplay" style="display: none;"></div>
                <div class="grid-2col" id="tripletGrid"></div>
            </div>

            <!-- PATTERNS VIEW -->
            <div class="view" id="patternsView">
                <div class="section-header">
                    <div class="section-title">Pattern Library</div>
                    <div class="section-desc">Full beats. Tap to play.</div>
                </div>
                <div id="patternCards"></div>
            </div>
        </main>
    </div>
    <div class="toast" id="toast"></div>

    <script>
    // ===== DATA =====
    const coreSounds = [
        { id: 'hihat', phonetic: '{ t }', name: 'Hi-Hat (Closed)', word: '"ts" as in "cats"',
          description: 'Tongue tip contacts ridge behind upper front teeth. Quick release. Teeth lightly closed. Unvoiced—consonant only.',
          link: 'https://www.youtube.com/results?search_query=beatbox+hi+hat+tutorial+beginner', soundType: 'hihat' },
        { id: 'kick', phonetic: '{ B }', name: 'Kick Drum', word: '"B" as in "boots"',
          description: 'Bilabial plosive. Whispered "B" with lip pressure. No voice. Deep punch from diaphragm support.',
          link: 'https://www.youtube.com/results?search_query=beatbox+kick+drum+tutorial+beginner', soundType: 'kick' },
        { id: 'snare', phonetic: '{ K }', name: 'K-Snare', word: '"K" as in "cats"',
          description: 'Velar plosive. Hard "K" sound. Back of tongue hits soft palate. Short, percussive click.',
          link: 'https://www.youtube.com/results?search_query=beatbox+k+snare+tutorial+beginner', soundType: 'snare' }
    ];

    const phrases = [
        { id: 'boots-cats', phrase: 'boots and cats', syllables: ['boots', 'and', 'cats', 'and'], sounds: ['kick', 'hihat', 'snare', 'hihat'], pattern: 'B - t - K - t' },
        { id: 'boots-n-cats', phrase: 'boots n cats n', syllables: ['boots', 'n', 'cats', 'n'], sounds: ['kick', 'hihat', 'snare', 'hihat'], pattern: 'B - t - K - t' },
        { id: 'bubba-cup', phrase: 'bubba cup', syllables: ['bub', 'ba', 'cup'], sounds: ['kick', 'kick', 'snare'], pattern: 'B - B - K' },
        { id: 'puh-tuh-kuh', phrase: 'puh tuh kuh', syllables: ['puh', 'tuh', 'kuh'], sounds: ['kick', 'hihat', 'snare'], pattern: 'B - t - K' },
        { id: 'kick-it', phrase: 'kick it kick snare', syllables: ['kick', 'it', 'kick', 'snare'], sounds: ['kick', 'hihat', 'kick', 'snare'], pattern: 'B - t - B - K' },
        { id: 'biggie-style', phrase: 'big puh big kah', syllables: ['big', 'puh', 'big', 'kah'], sounds: ['kick', 'hihat', 'kick', 'snare'], pattern: 'B - t - B - K' }
    ];

    const combos = [
        { id: 'kick-hihat', name: 'Kick → Hi-Hat', sounds: ['kick', 'hihat'], display: ['B', 't'] },
        { id: 'hihat-snare', name: 'Hi-Hat → Snare', sounds: ['hihat', 'snare'], display: ['t', 'K'] },
        { id: 'kick-snare', name: 'Kick → Snare', sounds: ['kick', 'snare'], display: ['B', 'K'] },
        { id: 'snare-kick', name: 'Snare → Kick', sounds: ['snare', 'kick'], display: ['K', 'B'] },
        { id: 'snare-hihat', name: 'Snare → Hi-Hat', sounds: ['snare', 'hihat'], display: ['K', 't'] },
        { id: 'hihat-kick', name: 'Hi-Hat → Kick', sounds: ['hihat', 'kick'], display: ['t', 'B'] }
    ];

    const triplets = [
        { id: 'b-t-k', name: 'boots and cats', sounds: ['kick', 'hihat', 'snare'], display: ['B', 't', 'K'] },
        { id: 'k-t-b', name: 'cats and boots', sounds: ['snare', 'hihat', 'kick'], display: ['K', 't', 'B'] },
        { id: 'b-b-k', name: 'bubba cup', sounds: ['kick', 'kick', 'snare'], display: ['B', 'B', 'K'] },
        { id: 'b-k-t', name: 'boom kat ts', sounds: ['kick', 'snare', 'hihat'], display: ['B', 'K', 't'] },
        { id: 't-t-k', name: 'tika snare', sounds: ['hihat', 'hihat', 'snare'], display: ['t', 't', 'K'] },
        { id: 'b-t-t', name: 'boots tika', sounds: ['kick', 'hihat', 'hihat'], display: ['B', 't', 't'] }
    ];

    const patterns = [
        { name: 'Boots and Cats', genre: 'Foundation', tempo: 60, phonetic: 'B - t - K - t', pattern: { kick: [1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0], snare: [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0], hihat: [0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0], openhat: [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0] } },
        { name: 'Simple Backbeat', genre: 'Foundation', tempo: 70, phonetic: 'B - - - K - - -', pattern: { kick: [1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0], snare: [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0], hihat: [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0], openhat: [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0] } },
        { name: '8th Note Hi-Hat', genre: 'Foundation', tempo: 75, phonetic: 'B t t t K t t t', pattern: { kick: [1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0], snare: [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0], hihat: [1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0], openhat: [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0] } },
        { name: 'Basic Rock', genre: 'Rock', tempo: 90, phonetic: 'B-t-K-t-B-t-K-t', pattern: { kick: [1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0], snare: [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0], hihat: [1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0], openhat: [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0] } },
        { name: 'Boom Bap', genre: 'Hip-Hop', tempo: 90, phonetic: 'B-t-t-K-B-B-t-K', pattern: { kick: [1,0,0,0,0,0,1,0,1,0,0,0,0,0,0,0], snare: [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0], hihat: [0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0], openhat: [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0] } },
        { name: 'Four on Floor', genre: 'House', tempo: 120, phonetic: 'B-t-B-t-B-t-B-tss', pattern: { kick: [1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0], snare: [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0], hihat: [0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0], openhat: [0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1] } },
        { name: 'Trap', genre: 'Hip-Hop', tempo: 140, phonetic: 'B-tttt-K-tttt', pattern: { kick: [1,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0], snare: [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0], hihat: [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1], openhat: [0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0] } },
        { name: 'Funk Pocket', genre: 'Funk', tempo: 100, phonetic: 'B-t-K-t-B-t-K-tt', pattern: { kick: [1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0], snare: [0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,0], hihat: [1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0], openhat: [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0] } }
    ];

    // ===== STATE =====
    let audioCtx = null;
    const state = {
        activeType: null, // 'sound', 'phrase', 'combo', 'triplet', 'pattern'
        activeId: null,
        interval: null,
        bpm: 60,
        currentBeat: 0,
        currentStep: 0
    };

    // ===== HELPERS =====
    const $ = id => document.getElementById(id);
    const $$ = sel => document.querySelectorAll(sel);
    function showToast(msg, type = '') { const t = $('toast'); t.textContent = msg; t.className = 'toast show ' + type; setTimeout(() => t.classList.remove('show'), 2500); }
    function initAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); return audioCtx; }

    function playSound(type) {
        const ctx = initAudio(), now = ctx.currentTime;
        if (type === 'kick') {
            const o = ctx.createOscillator(), g = ctx.createGain();
            o.connect(g); g.connect(ctx.destination);
            o.frequency.setValueAtTime(150, now); o.frequency.exponentialRampToValueAtTime(0.01, now + 0.4);
            g.gain.setValueAtTime(0.8, now); g.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
            o.start(now); o.stop(now + 0.4);
        } else if (type === 'snare') {
            const n = ctx.createBufferSource(), b = ctx.createBuffer(1, ctx.sampleRate * 0.15, ctx.sampleRate), d = b.getChannelData(0);
            for (let i = 0; i < b.length; i++) d[i] = Math.random() * 2 - 1;
            n.buffer = b;
            const f = ctx.createBiquadFilter(); f.type = 'highpass'; f.frequency.value = 1200;
            const g = ctx.createGain(); n.connect(f); f.connect(g); g.connect(ctx.destination);
            g.gain.setValueAtTime(0.4, now); g.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
            const o = ctx.createOscillator(), og = ctx.createGain();
            o.connect(og); og.connect(ctx.destination);
            o.frequency.setValueAtTime(180, now); o.frequency.exponentialRampToValueAtTime(100, now + 0.08);
            og.gain.setValueAtTime(0.25, now); og.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
            o.start(now); o.stop(now + 0.15); n.start(now); n.stop(now + 0.15);
        } else if (type === 'hihat') {
            const n = ctx.createBufferSource(), b = ctx.createBuffer(1, ctx.sampleRate * 0.04, ctx.sampleRate), d = b.getChannelData(0);
            for (let i = 0; i < b.length; i++) d[i] = Math.random() * 2 - 1;
            n.buffer = b;
            const hp = ctx.createBiquadFilter(); hp.type = 'highpass'; hp.frequency.value = 7000;
            const bp = ctx.createBiquadFilter(); bp.type = 'bandpass'; bp.frequency.value = 10000; bp.Q.value = 1;
            const g = ctx.createGain(); n.connect(hp); hp.connect(bp); bp.connect(g); g.connect(ctx.destination);
            g.gain.setValueAtTime(0.4, now); g.gain.exponentialRampToValueAtTime(0.01, now + 0.04);
            n.start(now); n.stop(now + 0.04);
        } else if (type === 'openhat') {
            const n = ctx.createBufferSource(), b = ctx.createBuffer(1, ctx.sampleRate * 0.4, ctx.sampleRate), d = b.getChannelData(0);
            for (let i = 0; i < b.length; i++) d[i] = Math.random() * 2 - 1;
            n.buffer = b;
            const hp = ctx.createBiquadFilter(); hp.type = 'highpass'; hp.frequency.value = 5000;
            const g = ctx.createGain(); n.connect(hp); hp.connect(g); g.connect(ctx.destination);
            g.gain.setValueAtTime(0.3, now); g.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
            n.start(now); n.stop(now + 0.4);
        }
    }

    function stopAll() {
        if (state.interval) clearInterval(state.interval);
        state.interval = null;
        state.activeType = null;
        state.activeId = null;
        state.currentBeat = 0;
        state.currentStep = 0;
        $('pulseDot').classList.remove('active');
        $$('.sound-card, .tap-card, .pattern-card').forEach(c => c.classList.remove('playing'));
        $$('.syl').forEach(s => s.classList.remove('current'));
        $$('.mini-step').forEach(s => s.classList.remove('beat'));
    }

    function adjustBPM(delta, e) {
        if (e) e.stopPropagation();
        state.bpm = Math.max(40, Math.min(180, state.bpm + delta));
        $$('.bpm-value').forEach(v => v.textContent = state.bpm);
        if (state.interval) {
            clearInterval(state.interval);
            startInterval();
        }
    }

    function startInterval() {
        const interval = (60 / state.bpm) * 1000;
        state.interval = setInterval(tick, interval);
        tick();
    }

    function tick() {
        if (state.activeType === 'sound') {
            const s = coreSounds.find(x => x.id === state.activeId);
            if (s) playSound(s.soundType);
        } else if (state.activeType === 'phrase') {
            const p = phrases.find(x => x.id === state.activeId);
            if (p) {
                playSound(p.sounds[state.currentBeat]);
                $$(`#phraseDisplay .syl`).forEach((s, i) => s.classList.toggle('current', i === state.currentBeat));
                state.currentBeat = (state.currentBeat + 1) % p.sounds.length;
            }
        } else if (state.activeType === 'combo') {
            const c = combos.find(x => x.id === state.activeId);
            if (c) {
                playSound(c.sounds[state.currentBeat]);
                $$(`#comboDisplay .syl`).forEach((s, i) => s.classList.toggle('current', i === state.currentBeat));
                state.currentBeat = (state.currentBeat + 1) % c.sounds.length;
            }
        } else if (state.activeType === 'triplet') {
            const t = triplets.find(x => x.id === state.activeId);
            if (t) {
                playSound(t.sounds[state.currentBeat]);
                $$(`#tripletDisplay .syl`).forEach((s, i) => s.classList.toggle('current', i === state.currentBeat));
                state.currentBeat = (state.currentBeat + 1) % t.sounds.length;
            }
        } else if (state.activeType === 'pattern') {
            const p = patterns.find(x => x.name === state.activeId);
            if (p) {
                ['kick', 'snare', 'hihat', 'openhat'].forEach(inst => {
                    if (p.pattern[inst][state.currentStep]) playSound(inst);
                });
                const card = document.querySelector(`.pattern-card[data-name="${state.activeId}"]`);
                if (card) {
                    card.querySelectorAll('.mini-step').forEach((s, i) => s.classList.toggle('beat', i % 16 === state.currentStep));
                }
                state.currentStep = (state.currentStep + 1) % 16;
            }
        }
    }

    // ===== INIT SOUNDS =====
    function initSounds() {
        $('soundCards').innerHTML = coreSounds.map(s => `
            <div class="sound-card" data-id="${s.id}">
                <div class="sound-card-status">READY</div>
                <div class="sound-card-header">
                    <div class="sound-card-phonetic">${s.phonetic}</div>
                    <div class="sound-card-name">${s.name}</div>
                </div>
                <div class="sound-card-word">${s.word}</div>
                <div class="sound-card-desc">${s.description}</div>
                <a href="${s.link}" target="_blank" class="sound-card-link" onclick="event.stopPropagation()">▶ Watch Tutorials</a>
                <div class="inline-bpm">
                    <button class="bpm-btn" onclick="adjustBPM(-5, event)">−</button>
                    <div class="bpm-display"><div class="bpm-value">${state.bpm}</div><div class="bpm-label">BPM</div></div>
                    <button class="bpm-btn" onclick="adjustBPM(5, event)">+</button>
                </div>
            </div>
        `).join('');
        $$('.sound-card').forEach(c => {
            c.addEventListener('click', () => toggleSound(c.dataset.id));
        });
    }

    function toggleSound(id) {
        initAudio();
        if (state.activeType === 'sound' && state.activeId === id) {
            stopAll();
            return;
        }
        stopAll();
        state.activeType = 'sound';
        state.activeId = id;
        document.querySelector(`.sound-card[data-id="${id}"]`).classList.add('playing');
        document.querySelector(`.sound-card[data-id="${id}"] .sound-card-status`).textContent = 'PLAYING';
        $('pulseDot').classList.add('active');
        startInterval();
    }

    // ===== INIT PHRASES =====
    function initPhrases() {
        $('phraseGrid').innerHTML = phrases.map(p => `
            <div class="tap-card" data-id="${p.id}">
                <div class="tap-card-status">READY</div>
                <div class="tap-card-pattern">${p.pattern}</div>
                <div class="tap-card-name">${p.phrase}</div>
            </div>
        `).join('');
        $$('#phraseGrid .tap-card').forEach(c => {
            c.addEventListener('click', () => togglePhrase(c.dataset.id));
        });
    }

    function togglePhrase(id) {
        initAudio();
        if (state.activeType === 'phrase' && state.activeId === id) {
            stopAll();
            $('phraseDisplay').style.display = 'none';
            return;
        }
        stopAll();
        const p = phrases.find(x => x.id === id);
        state.activeType = 'phrase';
        state.activeId = id;
        state.currentBeat = 0;
        document.querySelector(`#phraseGrid .tap-card[data-id="${id}"]`).classList.add('playing');
        
        $('phraseDisplay').style.display = 'block';
        $('phraseDisplay').innerHTML = `
            <div class="drill-display-card">
                <div class="drill-display-pattern">${p.syllables.map(s => `<span class="syl">${s}</span>`).join(' ')}</div>
                <div class="drill-display-name">${p.pattern}</div>
                <div class="drill-bpm-row">
                    <button class="bpm-btn" onclick="adjustBPM(-5, event)">−</button>
                    <div class="bpm-display"><div class="bpm-value">${state.bpm}</div><div class="bpm-label">BPM</div></div>
                    <button class="bpm-btn" onclick="adjustBPM(5, event)">+</button>
                </div>
                <div class="drill-tap-hint">Tap card again to stop</div>
            </div>
        `;
        $('pulseDot').classList.add('active');
        startInterval();
    }

    // ===== INIT COMBOS =====
    function initCombos() {
        $('comboGrid').innerHTML = combos.map(c => `
            <div class="tap-card" data-id="${c.id}">
                <div class="tap-card-status">READY</div>
                <div class="tap-card-pattern">${c.display[0]} - ${c.display[1]}</div>
                <div class="tap-card-name">${c.name}</div>
            </div>
        `).join('');
        $$('#comboGrid .tap-card').forEach(c => {
            c.addEventListener('click', () => toggleCombo(c.dataset.id));
        });
    }

    function toggleCombo(id) {
        initAudio();
        if (state.activeType === 'combo' && state.activeId === id) {
            stopAll();
            $('comboDisplay').style.display = 'none';
            return;
        }
        stopAll();
        const c = combos.find(x => x.id === id);
        state.activeType = 'combo';
        state.activeId = id;
        state.currentBeat = 0;
        document.querySelector(`#comboGrid .tap-card[data-id="${id}"]`).classList.add('playing');
        
        $('comboDisplay').style.display = 'block';
        $('comboDisplay').innerHTML = `
            <div class="drill-display-card">
                <div class="drill-display-pattern">${c.display.map(s => `<span class="syl">${s}</span>`).join(' → ')}</div>
                <div class="drill-display-name">${c.name}</div>
                <div class="drill-bpm-row">
                    <button class="bpm-btn" onclick="adjustBPM(-5, event)">−</button>
                    <div class="bpm-display"><div class="bpm-value">${state.bpm}</div><div class="bpm-label">BPM</div></div>
                    <button class="bpm-btn" onclick="adjustBPM(5, event)">+</button>
                </div>
                <div class="drill-tap-hint">Tap card again to stop</div>
            </div>
        `;
        $('pulseDot').classList.add('active');
        startInterval();
    }

    // ===== INIT TRIPLETS =====
    function initTriplets() {
        $('tripletGrid').innerHTML = triplets.map(t => `
            <div class="tap-card" data-id="${t.id}">
                <div class="tap-card-status">READY</div>
                <div class="tap-card-pattern">${t.display.join(' - ')}</div>
                <div class="tap-card-name">${t.name}</div>
            </div>
        `).join('');
        $$('#tripletGrid .tap-card').forEach(c => {
            c.addEventListener('click', () => toggleTriplet(c.dataset.id));
        });
    }

    function toggleTriplet(id) {
        initAudio();
        if (state.activeType === 'triplet' && state.activeId === id) {
            stopAll();
            $('tripletDisplay').style.display = 'none';
            return;
        }
        stopAll();
        const t = triplets.find(x => x.id === id);
        state.activeType = 'triplet';
        state.activeId = id;
        state.currentBeat = 0;
        document.querySelector(`#tripletGrid .tap-card[data-id="${id}"]`).classList.add('playing');
        
        $('tripletDisplay').style.display = 'block';
        $('tripletDisplay').innerHTML = `
            <div class="drill-display-card">
                <div class="drill-display-pattern">${t.display.map(s => `<span class="syl">${s}</span>`).join(' - ')}</div>
                <div class="drill-display-name">${t.name}</div>
                <div class="drill-bpm-row">
                    <button class="bpm-btn" onclick="adjustBPM(-5, event)">−</button>
                    <div class="bpm-display"><div class="bpm-value">${state.bpm}</div><div class="bpm-label">BPM</div></div>
                    <button class="bpm-btn" onclick="adjustBPM(5, event)">+</button>
                </div>
                <div class="drill-tap-hint">Tap card again to stop</div>
            </div>
        `;
        $('pulseDot').classList.add('active');
        startInterval();
    }

    // ===== INIT PATTERNS =====
    function initPatterns() {
        $('patternCards').innerHTML = patterns.map(p => {
            const miniGrid = ['kick', 'snare', 'hihat', 'openhat'].map(inst => 
                `<div class="mini-grid-row">${p.pattern[inst].map((v, i) => `<div class="mini-step ${v ? 'on' : ''}"></div>`).join('')}</div>`
            ).join('');
            return `
                <div class="pattern-card" data-name="${p.name}" data-tempo="${p.tempo}">
                    <div class="pattern-card-header">
                        <div>
                            <div class="pattern-card-name">${p.name}</div>
                            <div class="pattern-card-meta">${p.genre} • ${p.tempo} BPM</div>
                        </div>
                        <div class="pattern-card-status">READY</div>
                    </div>
                    <div class="pattern-card-phonetic">${p.phonetic}</div>
                    <div class="mini-grid">${miniGrid}</div>
                    <div class="pattern-bpm">
                        <button class="bpm-btn" onclick="adjustBPM(-5, event)">−</button>
                        <div class="bpm-display"><div class="bpm-value">${p.tempo}</div><div class="bpm-label">BPM</div></div>
                        <button class="bpm-btn" onclick="adjustBPM(5, event)">+</button>
                    </div>
                </div>
            `;
        }).join('');
        $$('.pattern-card').forEach(c => {
            c.addEventListener('click', () => togglePattern(c.dataset.name, parseInt(c.dataset.tempo)));
        });
    }

    function togglePattern(name, tempo) {
        initAudio();
        if (state.activeType === 'pattern' && state.activeId === name) {
            stopAll();
            return;
        }
        stopAll();
        state.activeType = 'pattern';
        state.activeId = name;
        state.currentStep = 0;
        state.bpm = tempo;
        $$('.bpm-value').forEach(v => v.textContent = state.bpm);
        document.querySelector(`.pattern-card[data-name="${name}"]`).classList.add('playing');
        $('pulseDot').classList.add('active');
        startInterval();
    }

    // ===== NAVIGATION =====
    function initNav() {
        $$('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                stopAll();
                $('phraseDisplay').style.display = 'none';
                $('comboDisplay').style.display = 'none';
                $('tripletDisplay').style.display = 'none';
                $$('.nav-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                $$('.view').forEach(v => v.classList.remove('active'));
                $(tab.dataset.view + 'View').classList.add('active');
            });
        });
    }

    // ===== INIT =====
    function init() {
        initNav();
        initSounds();
        initPhrases();
        initCombos();
        initTriplets();
        initPatterns();
    }

    document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>